<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>TatvaBot â€” Chat + Image Upload (cloudinary unsigned)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --green:#14532d; --muted:#f7f7f8; --bubble-bg:#f1f5f9; --text:#111827;
    --accent:#16a34a; --muted-border:#e6e6e6;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;}
  body{background:var(--muted);display:flex;align-items:center;justify-content:center;padding:18px;}
  .chat-wrapper{ width:100%; max-width:960px; background:#fff; border-radius:12px; box-shadow:0 12px 30px rgba(2,6,23,0.08); display:grid; grid-template-columns:1fr 340px; overflow:hidden; min-height:540px; }
  .left { padding:18px 20px; display:flex; flex-direction:column; gap:12px; min-height:520px; }
  .chat-header{ background:var(--green); color:#fff; padding:14px; border-radius:8px; font-weight:600; display:flex; justify-content:space-between; align-items:center;}
  .chat-header small{display:block;font-weight:400;font-size:12px;opacity:.9;margin-top:4px}
  .chat-window{ background:#fafafa; border-radius:8px; padding:14px; flex:1; overflow:auto; min-height:340px; }
  .msg{ margin-bottom:12px; max-width:78%; line-height:1.4; display:flex; flex-direction:column; }
  .msg span{ display:block; background:var(--bubble-bg); color:var(--text); padding:12px 14px; border-radius:12px; white-space:pre-wrap; word-wrap:break-word; box-shadow:0 1px 0 rgba(0,0,0,0.02); }
  .msg-user{ align-items:flex-end; margin-left:auto; text-align:right; }
  .msg-user span{ background:var(--green); color:#fff; }
  .msg img{ display:block; margin-top:8px; max-width:320px; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,0.06); }
  .chat-footer{ display:flex; gap:8px; padding-top:10px; border-top:1px solid var(--muted-border); align-items:center; }
  .chat-footer input[type="text"]{ flex:1; padding:10px 14px; border-radius:999px; border:1px solid #ddd; outline:none; font-size:14px; }
  .send{ background:var(--accent); color:#fff; border:none; padding:10px 16px; border-radius:999px; cursor:pointer; }
  .send:disabled{ opacity:.6; cursor:default; }
  .file-controls{ display:flex; gap:8px; align-items:center; }
  .file-btn{ padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; font-size:14px; }
  .file-btn:disabled{ opacity:.6 }
  .camera-note{ font-size:11px; color:#6b7280; margin-left:6px; }
  .right{ padding:18px; border-left:1px solid #f1f1f1; background:#fff; }
  .status{ font-size:13px; color:#6b7280; padding:6px 0 0 0; }
  @media(max-width:920px){ .chat-wrapper{ grid-template-columns:1fr; } .right{ display:none; } }
  small.hint{ display:block; font-size:12px; color:#6b7280; margin-top:6px }
</style>
</head>
<body>
  <div class="chat-wrapper" role="application" aria-label="TatvaBot chat">
    <div class="left" id="left-col">
      <div class="chat-header" aria-hidden="false">
        <div>
          TatvaBot â€” Gardening Assistant
          <small>Ask about vermicompost, terrace gardening, or Tatvabhoomi products</small>
        </div>
        <div style="font-size:12px;opacity:.9">v1</div>
      </div>

      <div id="chat-window" class="chat-window" aria-live="polite" role="log">
        <div class="msg msg-bot"><span>ðŸ‘‹ Namaste! Iâ€™m TatvaBot. How can I help with your plants today?</span></div>
      </div>

      <div id="status" class="status" aria-live="polite"></div>

      <div class="chat-footer" role="region" aria-label="Chat controls">
        <input id="user-input" type="text" placeholder="Type your question..." autocomplete="off" aria-label="Type message" />
        <div class="file-controls" aria-hidden="false">
          <label class="file-btn" id="choose-file-btn" title="Attach image (camera or gallery)">ðŸ“Ž</label>
          <input id="file-input" type="file" accept="image/*" capture="environment" style="display:none" />
          <button id="upload-btn" class="file-btn" title="Upload selected image">Upload</button>
        </div>
        <button id="send-btn" class="send" aria-label="Send message">Send</button>
      </div>

      <small class="hint">Uploads go directly to Cloudinary (unsigned preset).</small>
    </div>

    <div class="right" id="right-col" aria-hidden="true">
      <div style="font-weight:600;margin-bottom:8px">Debug & Controls</div>
      <div id="debug" style="font-size:13px;color:#444;line-height:1.4">Hidden (open console for logs)</div>
    </div>
  </div>

<script>
/*
  QUICK NOTES:
  - This page uploads to Cloudinary unsigned (client-side) using your cloud name & preset.
  - You told me:
      cloud name: dps3lh1ed
      unsigned preset: tatvabot_unsigned
  - The script then posts to YOUR existing server route: POST /api/chat
  - I do NOT modify any server files.
  - If something fails: open DevTools (F12) -> Console and copy the first error line and send to me.

  IMPORTANT: If your deployment has a Content Security Policy (CSP) that blocks uploads to cloudinary,
  the upload will fail. If that happens, paste the error console output here.
*/

const CLOUD_NAME = 'dps3lh1ed';
const UPLOAD_PRESET = 'tatvabot_unsigned';
const CLOUDINARY_ENDPOINT = https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload;

// UI elements
const chatWindow = document.getElementById('chat-window');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
const chooseFileBtn = document.getElementById('choose-file-btn');
const uploadBtn = document.getElementById('upload-btn');
const statusEl = document.getElementById('status');
const debugEl = document.getElementById('debug');

let lastUploadedUrl = null;

function logDebug(...args){
  try { debugEl.textContent = args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' | '); }
  catch(e){ /ignore/ }
  console.log('[tatvabot-debug]', ...args);
}

function setStatus(t){
  statusEl.textContent = t || '';
}

// show message (user or bot). from = 'user'|'bot'
function addMessage(text, from='bot', imageUrl=null){
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (from==='user' ? 'msg-user' : 'msg-bot');
  const span = document.createElement('span');
  span.innerHTML = (text||'').replace(/\n/g,'<br>');
  wrapper.appendChild(span);
  if(imageUrl){
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = 'attached image';
    img.loading = 'lazy';
    wrapper.appendChild(img);
  }
  chatWindow.appendChild(wrapper);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// open native file selector
chooseFileBtn.addEventListener('click', () => {
  try { fileInput.click(); } catch(e){ alert('Unable to open file selector: ' + e.message); console.error(e); }
});

// upload to Cloudinary unsigned
uploadBtn.addEventListener('click', async () => {
  const file = fileInput.files && fileInput.files[0];
  if(!file){
    alert('Please choose an image first (click the paperclip ðŸ“Ž).');
    return;
  }

  // disable while uploading
  uploadBtn.disabled = true;
  chooseFileBtn.disabled = true;
  setStatus('Uploading to Cloudinary...');

  try {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', UPLOAD_PRESET);

    logDebug('Calling cloudinary...', CLOUDINARY_ENDPOINT, UPLOAD_PRESET);
    const res = await fetch(CLOUDINARY_ENDPOINT, { method: 'POST', body: fd });
    const json = await res.json().catch(()=>null);

    if(!res.ok){
      console.error('Cloudinary returned non-OK:', res.status, json);
      alert('Upload failed: cloudinary returned error. See console for details.');
      setStatus('Upload failed');
      return;
    }

    // find secure_url
    const secureUrl = (json && (json.secure_url || json.url)) || null;
    if(!secureUrl){
      console.error('Cloudinary response missing url:', json);
      alert('Upload failed: no url returned. See console.');
      setStatus('Upload failed');
      return;
    }

    lastUploadedUrl = secureUrl;
    setStatus('Upload OK');
    addMessage('Image attached', 'user', lastUploadedUrl);
    fileInput.value = '';
    logDebug('Cloudinary upload OK', secureUrl);
  } catch(err){
    console.error('Upload error', err);
    alert('Upload error: ' + (err.message || err));
    setStatus('Upload error');
  } finally {
    uploadBtn.disabled = false;
    chooseFileBtn.disabled = false;
    setTimeout(()=>setStatus(''), 1800);
  }
});

// send text + optional lastUploadedUrl to /api/chat
async function doSend(){
  const text = (input.value || '').trim();
  if(!text && !lastUploadedUrl){
    // nothing to send
    return;
  }

  // add user's message immediately
  addMessage(text || 'Image', 'user', lastUploadedUrl || null);
  input.value = '';
  setStatus('Sending to TatvaBot...');
  sendBtn.disabled = true;

  try {
    const body = { message: text || '', image: lastUploadedUrl || null };

    logDebug('Posting /api/chat', body);
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    // safety: log raw status
    logDebug('/api/chat status', res.status);

    // try to parse JSON even on failure
    const json = await res.json().catch(()=>null);

    if(!res.ok){
      console.error('/api/chat returned error', res.status, json);
      addMessage('Sorry â€” failed to reach bot. Check console.','bot');
      alert('Chat API returned error: ' + (res.status || 'unknown') + '. See console/Network.');
      return;
    }

    // expected reply property
    const replyText = (json && (json.reply || json.answer || json.text)) || '';
    const replyImage = (json && (json.image || json.img || json.result?.secure_url)) || null;

    if(replyText || replyImage){
      addMessage(replyText || '', 'bot', replyImage || null);
      logDebug('bot reply', replyText, replyImage);
    } else {
      console.warn('Chat API response had no reply:', json);
      addMessage('Sorry â€” bot returned empty reply. See console.', 'bot');
    }
  } catch(err){
    console.error('Network/Chat error', err);
    addMessage('Network error while contacting bot. See console.', 'bot');
    alert('Network error: ' + (err.message || err));
  } finally {
    // clear lastUploadedUrl after sending (so the image is not reused)
    lastUploadedUrl = null;
    sendBtn.disabled = false;
    setStatus('');
  }
}

// Bind UI
sendBtn.addEventListener('click', doSend);
input.addEventListener('keydown', (e) => { if(e.key === 'Enter'){ e.preventDefault(); doSend(); } });

// quick sanity console message so we can detect if this script runs
console.log('[tatvabot] client script loaded. Cloud:', CLOUD_NAME, 'preset:', UPLOAD_PRESET);

// Helpful tip to user: if buttons don't work, open Console (F12) and paste first error here.
(function quickCheckAndAdvice(){
  // small quick patch: if send button wasn't wired by some other script, we already wired it above,
  // but if other code prevents it we will show message in console so you can copy the error.
  try {
    if(typeof window.__tatvabot_quick_patch_applied === 'undefined'){
      window.__tatvabot_quick_patch_applied = true;
      console.log('[tatvabot] quick patch applied (client-only). If Upload/Send still fail, open Console (F12) -> Network and copy the first error line here.');
      alert('Quick fix installed in this browser. Try Upload then Send. If it fails, open Console (F12) and copy the first error line and send it to me.');
    }
  } catch(e){
    console.warn('tatvabot self-check error', e);
  }
})();
</script>
</body>
</html>
