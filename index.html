<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TatvaBot ‚Äî Chat (with image + camera)</title>
  <style>
    :root{
      --bg:#f6f7f5; --accent:#1f8a3a; --muted:#6b6b6b;
      --bubble:#ffffff; --my-bubble:#e9f7ee;
      --radius:12px; --gap:16px;
    }
    html,body{height:100%;margin:0;font-family:Inter,Roboto,Arial; background:var(--bg); color:#222}
    .container{max-width:920px;margin:24px auto;padding:20px}
    header{background:var(--accent);color:white;padding:14px 20px;border-radius:10px}
    header h1{margin:0;font-size:18px}
    .chat-wrap{display:flex;gap:20px;margin-top:20px}
    .messages{flex:1;min-height:480px;background:var(--bubble);border-radius:12px;padding:20px;overflow:auto;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .controls{display:flex;align-items:flex-end;gap:10px;margin-top:12px}
    .input-row{display:flex;align-items:center;gap:10px}
    .text-input{flex:1;padding:12px 16px;border-radius:999px;border:1px solid #ddd;background:white}
    button.primary{background:var(--accent);color:white;padding:10px 16px;border-radius:999px;border:0;cursor:pointer}
    button.icon-btn{border:0;background:transparent;cursor:pointer;padding:8px;border-radius:8px}
    .camera-btn{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:999px;border:1px solid #ddd;background:white}
    .msg{margin-bottom:18px;display:flex;align-items:flex-start;gap:12px}
    .bubble{background:var(--my-bubble);padding:12px 14px;border-radius:10px;max-width:66%;}
    .bubble.bot{background:#fff}
    .bubble.small{padding:6px 10px;display:inline-block}
    .image-preview{display:block;border-radius:12px;max-width:360px;margin-top:8px;box-shadow:0 8px 18px rgba(0,0,0,.08)}
    .attached-tag{display:inline-block;background:var(--accent);color:white;padding:6px 10px;border-radius:999px;font-size:13px}
    .chat-footer{display:flex;gap:8px;align-items:center;margin-top:10px}
    /* small screens */
    @media (max-width:640px){ .container{padding:12px} .messages{min-height:60vh} .image-preview{max-width:86vw} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>TatvaBot ‚Äî Gardening Assistant</h1>
      <div style="font-size:13px;opacity:.95;margin-top:6px">Ask about vermicompost, terrace gardening, plant issues</div>
    </header>

    <div class="chat-wrap">
      <div style="flex:1;display:flex;flex-direction:column">
        <div class="messages" id="messages" role="log" aria-live="polite">
          <!-- example starter bot message -->
          <div class="msg">
            <div class="bubble bot small">üëã Namaste! I'm TatvaBot. How can I help with your plants today?</div>
          </div>
        </div>

        <!-- bottom area: text + camera + upload + send -->
        <div class="chat-footer">
          <input id="text" class="text-input" placeholder="Type your question..." aria-label="Message input" />

          <!-- hidden file input used for both gallery and camera capture -->
          <input id="fileInput" type="file" accept="image/*" style="display:none" />

          <!-- camera button: capture attribute is handled by setting input.capture below for mobile -->
          <button id="cameraBtn" class="icon-btn camera-btn" title="Capture photo">
            üì∑ Camera
          </button>

          <!-- upload from gallery -->
          <button id="uploadBtn" class="icon-btn camera-btn" title="Choose image">
            ‚¨ÜÔ∏è Upload
          </button>

          <button id="sendBtn" class="primary">Send</button>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  HOW IT WORKS:
  - User clicks Upload (choose file) or Camera (open camera on mobile)
  - The selected image is POSTed to UPLOAD_ENDPOINT as form field "image"
  - The endpoint should return JSON with { url: "<public-url>" }
  - Script inserts an image preview bubble into chat and attaches the url to the next send
  - On Send, the text + imageUrl are sent to your chat backend (you can extend to actually call your bot API)
*/

const UPLOAD_ENDPOINT = '/api/upload'; // <-- change this to your server upload path if needed

const messagesEl = document.getElementById('messages');
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const cameraBtn = document.getElementById('cameraBtn');
const sendBtn = document.getElementById('sendBtn');
const textInput = document.getElementById('text');

let pendingImageUrl = null; // stores URL after upload

// helper to append a chat bubble
function appendBubble({ from='bot', text='', imageUrl=null, tag=null }) {
  const wrapper = document.createElement('div');
  wrapper.className = 'msg';
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (from === 'me' ? 'me' : 'bot');
  if (text) {
    const p = document.createElement('div');
    p.textContent = text;
    bubble.appendChild(p);
  }
  if (imageUrl) {
    const img = document.createElement('img');
    img.className = 'image-preview';
    img.src = imageUrl;
    img.alt = 'Uploaded image';
    bubble.appendChild(img);
  }
  if (tag) {
    // small floating tag (e.g. "Image attached")
    const tagEl = document.createElement('div');
    tagEl.className = 'attached-tag';
    tagEl.style.marginLeft = '12px';
    tagEl.textContent = tag;
    wrapper.appendChild(tagEl);
  }
  wrapper.appendChild(bubble);
  messagesEl.appendChild(wrapper);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// open gallery
uploadBtn.addEventListener('click', () => {
  fileInput.removeAttribute('capture'); // ensure gallery mode
  fileInput.click();
});

// open camera (mobile will prompt camera)
cameraBtn.addEventListener('click', () => {
  // set capture to environment (back camera) ‚Äî many mobile browsers respect this
  fileInput.setAttribute('capture', 'environment');
  fileInput.click();
});

// when a file is picked, upload immediately and show preview
fileInput.addEventListener('change', async (ev) => {
  const f = ev.target.files && ev.target.files[0];
  if (!f) return;
  // simple client-side validation:
  if (!f.type.startsWith('image/')) {
    alert('Please choose an image file.');
    fileInput.value = '';
    return;
  }

  // show a temporary preview while uploading
  const tmpUrl = URL.createObjectURL(f);
  appendBubble({ from:'me', text:'', imageUrl:tmpUrl, tag:'Uploading...' });

  try {
    const form = new FormData();
    form.append('image', f);

    const res = await fetch(UPLOAD_ENDPOINT, { method:'POST', body:form });
    if (!res.ok) throw new Error('Upload failed: ' + res.status);
    const data = await res.json();

    // adapt if your backend uses different field name
    const publicUrl = data.url || data.secure_url || data.publicUrl || data.public_url;
    if (!publicUrl) throw new Error('Upload response missing url');

    // remove the last "Uploading..." bubble and replace with final bubble
    // simple approach: remove last message and append final
    messagesEl.removeChild(messagesEl.lastChild);
    appendBubble({ from:'me', imageUrl:publicUrl, tag:'Image attached' });
    pendingImageUrl = publicUrl;
    fileInput.value = '';
  } catch (err) {
    console.error(err);
    // clean up temp bubble
    messagesEl.removeChild(messagesEl.lastChild);
    alert('Upload failed: ' + (err.message || err));
    fileInput.value = '';
    pendingImageUrl = null;
  }
});

// Send button: sends text and optional image url to chat (you can extend to call your bot API)
sendBtn.addEventListener('click', async () => {
  const text = textInput.value && textInput.value.trim();
  if (!text && !pendingImageUrl) {
    // nothing to send
    textInput.focus();
    return;
  }

  // show the user's message in chat
  appendBubble({ from:'me', text, imageUrl: pendingImageUrl || null });

  // Clear UI
  textInput.value = '';
  const imageToSend = pendingImageUrl;
  pendingImageUrl = null;

  // Call your bot backend here. Example placeholder:
  try {
    // Replace with your bot endpoint. This example sends JSON { text, image }
    const BOT_ENDPOINT = '/api/message'; // <-- adapt as needed
    const resp = await fetch(BOT_ENDPOINT, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ text: text || '', image: imageToSend || null })
    });

    if (!resp.ok) throw new Error('Chat API error ' + resp.status);
    const botReply = await resp.json();

    // If your bot returns { text, image } adapt accordingly:
    // Fallback: if botReply.text absent, show generic reply.
    const botText = botReply.text || botReply.message || 'I got that ‚Äî processing...';
    const botImage = botReply.image || null;

    appendBubble({ from:'bot', text:botText, imageUrl:botImage || null });
  } catch (err) {
    console.error(err);
    appendBubble({ from:'bot', text:'Sorry ‚Äî failed to reach bot. Try again.' });
  }
});

// enter to send
textInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});
</script>
</body>
</html>
