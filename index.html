<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>TatvaBot â€” Chat + Image Upload</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --green:#14532d;
    --muted:#f7f7f8;
    --bubble-bg:#f1f5f9;
    --text:#111827;
    --accent:#16a34a;
    --muted-border:#e6e6e6;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;}
  body{background:var(--muted);display:flex;align-items:center;justify-content:center;padding:18px;}

  /* NOW only one column */
  .chat-wrapper{
    width:100%;
    max-width:960px;
    background:#fff;
    border-radius:12px;
    box-shadow:0 12px 30px rgba(2,6,23,0.08);
    display:flex;
    flex-direction:column;
    overflow:hidden;
    min-height:540px;
  }

  /* left = chat */
  .left { padding:18px 20px; display:flex; flex-direction:column; gap:12px; min-height:520px; }

  /* FIXED HEADER (now stays on top and does NOT scroll away) */
  .chat-header{
    background:var(--green);
    color:#fff;
    padding:14px;
    border-radius:8px;
    font-weight:600;
    display:flex;
    justify-content:space-between;
    align-items:center;
    position:sticky;
    top:0;
    z-index:10;
  }
  .chat-header small{
    display:block;
    font-weight:400;
    font-size:12px;
    opacity:.9;
    margin-top:4px;
  }

  .chat-window{
    background:#fafafa;
    border-radius:8px;
    padding:14px;
    flex:1;
    overflow:auto;
    min-height:340px;
  }

  .msg{ margin-bottom:12px; max-width:78%; line-height:1.4; display:flex; flex-direction:column; }
  .msg span{
    display:block;
    background:var(--bubble-bg);
    color:var(--text);
    padding:12px 14px;
    border-radius:12px;
    white-space:pre-wrap;
    word-wrap:break-word;
    box-shadow:0 1px 0 rgba(0,0,0,0.02);
  }
  .msg-user{ align-items:flex-end; margin-left:auto; text-align:right; }
  .msg-user span{ background:var(--green); color:#fff; }

  .msg img{
    display:block;
    margin-top:8px;
    max-width:320px;
    border-radius:8px;
    box-shadow:0 6px 18px rgba(2,6,23,0.06);
  }

  .chat-footer{
    display:flex;
    gap:8px;
    padding-top:10px;
    border-top:1px solid var(--muted-border);
    align-items:center;
  }
  .chat-footer input[type="text"]{
    flex:1;
    padding:10px 14px;
    border-radius:999px;
    border:1px solid #ddd;
    outline:none;
    font-size:14px;
  }
  .chat-footer input[type="text"]:focus{
    border-color:var(--green);
  }
  .send{
    background:var(--accent);
    color:#fff;
    border:none;
    padding:10px 16px;
    border-radius:999px;
    cursor:pointer;
  }

  .file-controls{ display:flex; gap:8px; align-items:center; }
  .file-btn{
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #ddd;
    background:#fff;
    cursor:pointer;
    font-size:14px;
  }
</style>
</head>
<body>

  <div class="chat-wrapper" role="application">
    <div class="left">

      <div class="chat-header">
        <div>
          TatvaBot â€” Gardening Assistant
          <small>Ask about vermicompost, terrace gardening, or Tatvabhoomi products</small>
        </div>
        <div style="font-size:12px;opacity:.9">v1</div>
      </div>

      <div id="chat-window" class="chat-window">
        <div class="msg msg-bot">
          <span>ðŸ‘‹ Namaste! Iâ€™m TatvaBot. How can I help with your plants today?</span>
        </div>
      </div>

      <div id="status" class="status"></div>

      <div class="chat-footer">
        <input id="user-input" type="text" placeholder="Type your question..." autocomplete="off" />

        <div class="file-controls">
          <label class="file-btn" id="choose-file-btn">ðŸ“Ž</label>
          <input id="file-input" type="file" accept="image/*" capture="environment" style="display:none" />
        </div>

        <button id="send-btn" class="send">Send</button>
      </div>

    </div>
  </div>

<script>
const chatWindow = document.getElementById('chat-window');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
const chooseFileBtn = document.getElementById('choose-file-btn');
const statusEl = document.getElementById('status');

let uploadedImageUrl = null;

function showStatus(t){ statusEl.textContent = t || ''; }

function addMessage(text, from='bot', image=null){
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + (from==='user' ? 'msg-user':'msg-bot');

  const span = document.createElement('span');
  span.innerHTML = text.replace(/\n/g,'<br>');
  wrap.appendChild(span);

  if(image){
    const img = document.createElement('img');
    img.src = image;
    wrap.appendChild(img);
  }

  chatWindow.appendChild(wrap);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

/* ---- AUTO UPLOAD ON FILE SELECT (NO "UPLOAD" BUTTON NEEDED) ---- */
chooseFileBtn.addEventListener('click',()=> fileInput.click());

fileInput.addEventListener('change', async () => {
  const file = fileInput.files[0];
  if(!file) return;

  showStatus("Uploading image...");

  const fd = new FormData();
  fd.append("file", file);

  try {
    const res = await fetch("/api/upload",{ method:"POST", body:fd });
    const data = await res.json();

    uploadedImageUrl =
      data.url || data.secure_url || data.result?.secure_url || null;

    addMessage("Image attached","user",uploadedImageUrl);
    showStatus("Upload successful");

  } catch(e){
    console.error(e);
    showStatus("Upload failed");
  }

  fileInput.value = "";
  setTimeout(()=>showStatus(""),1500);
});

/* ---- SEND TEXT + OPTIONAL IMAGE ---- */
async function sendMessage(){
  const message = input.value.trim();
  if(!message && !uploadedImageUrl) return;

  addMessage(message || "Image","user",uploadedImageUrl);
  input.value = "";
  showStatus("TatvaBot is thinking...");
  sendBtn.disabled = true;

  try{
    const res = await fetch("/api/chat",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ message:message, image:uploadedImageUrl })
    });
    const data = await res.json();

    addMessage(data.reply || "Sorry, no reply.","bot",data.image || null);
  } catch(e){
    addMessage("Network error.","bot");
  }

  uploadedImageUrl = null;
  sendBtn.disabled = false;
  showStatus("");
}

sendBtn.addEventListener("click",sendMessage);
input.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendMessage(); }});
</script>

</body>
</html>
