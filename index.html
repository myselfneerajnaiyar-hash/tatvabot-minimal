<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>TatvaBot â€” Chat + Image Upload (Diagnosis)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --green:#14532d; --muted:#f7f7f8; --bubble-bg:#f1f5f9;
    --text:#111827; --accent:#16a34a; --muted-border:#e6e6e6; --danger:#c53030;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:var(--muted);}
  body{display:flex;align-items:center;justify-content:center;padding:18px;}
  .chat-wrapper{width:100%;max-width:960px;background:#fff;border-radius:12px;box-shadow:0 12px 30px rgba(2,6,23,0.08);overflow:hidden;display:flex;flex-direction:column;min-height:560px;height:80vh;}
  .chat-header{background:var(--green);color:#fff;padding:10px 14px;font-weight:600;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000;}
  .chat-body{display:flex;padding:18px;flex:1 1 auto;min-height:0;box-sizing:border-box;}
  .chat-window{flex:1;background:#fafafa;border-radius:8px;padding:14px;overflow:auto;height:100%;box-sizing:border-box;}
  .msg{margin-bottom:12px;max-width:78%;line-height:1.4;display:flex;flex-direction:column;}
  .msg span{display:block;background:var(--bubble-bg);color:var(--text);padding:12px 14px;border-radius:12px;white-space:pre-wrap;}
  .msg-user{align-items:flex-end;margin-left:auto;text-align:right;}
  .msg-user span{background:var(--green);color:#fff;}
  .msg img{display:block;margin-top:8px;max-width:320px;border-radius:8px;}
  .chat-footer{border-top:1px solid var(--muted-border);padding:12px 14px;display:flex;gap:8px;align-items:center;background:#fff;}
  .chat-footer input[type="text"]{flex:1;padding:10px 14px;border-radius:999px;border:1px solid #ddd;outline:none;font-size:14px;}
  .file-btn{padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;font-size:16px;}
  .send{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:999px;cursor:pointer;}
  .mic-btn{width:40px;height:40px;border-radius:999px;border:1px solid #ddd;display:flex;align-items:center;justify-content:center;cursor:pointer;background:#fff;}
  .status{font-size:13px;color:#6b7280;padding:6px 18px 10px;min-height:20px;}
  .quick-row{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0;}
  .quick-btn{background:#fff;border:1px solid var(--muted-border);padding:8px 12px;border-radius:999px;cursor:pointer;font-size:13px;}
  .quick-btn.primary{background:var(--green);color:#fff;border-color:var(--green);}
  .meta{font-size:11px;color:#7b7b7b;margin-top:6px;}
  @media(max-width:640px){ .msg img{max-width:220px;} }
</style>
</head>
<body>
  <div class="chat-wrapper" role="application" aria-label="TatvaBot chat">
    <div class="chat-header">
      <div>
        <div style="font-size:16px"><strong>TatvaBot â€” Gardening Assistant</strong></div>
        <small>Ask about vermicompost, terrace gardening, or Tatvabhoomi products</small>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="location-display" style="font-size:13px;opacity:.95">Location â€” <em>not set</em></div>
        <button id="share-location" class="quick-btn">Share location</button>
        <button id="set-location" class="quick-btn">Set location</button>
        <button id="clear-btn" class="quick-btn">Clear chat</button>
      </div>
    </div>

    <div class="chat-body">
      <div id="chat-window" class="chat-window" aria-live="polite" role="log"></div>
    </div>

    <div id="status" class="status" aria-live="polite"></div>

    <div class="chat-footer" role="region" aria-label="Chat controls">
      <input id="user-input" type="text" placeholder="Type your question or use the mic..." autocomplete="off" />
      <div id="mic-btn" class="mic-btn" title="Voice input">ðŸŽ¤</div>
      <label class="file-btn" id="choose-file-btn">ðŸ“Ž</label>
      <input id="file-input" type="file" accept="image/*" capture="environment" style="display:none" />
      <button id="send-btn" class="send">Send</button>
    </div>
  </div>

<script>
/* Single-file TatvaBot UI
   - Multistep diagnosis + auto send summary to Formspree
   - Quick buttons, location, voice input (optional), image upload stub
   - Replace only this file. Backup previous before replacing.
*/

const FORMSPREE_ENDPOINT = "https://formspree.io/f/xwpdkjaa"; // change if needed

/* ------- state and keys ------- */
const STORAGE_KEY = 'tatvabot_chat_v_final';
const LOCATION_KEY = 'tatvabot_location_v_final';

const chatWindow = document.getElementById('chat-window');
const inputEl = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
const chooseFileBtn = document.getElementById('choose-file-btn');
const statusEl = document.getElementById('status');
const clearBtn = document.getElementById('clear-btn');
const micBtn = document.getElementById('mic-btn');
const shareLocBtn = document.getElementById('share-location');
const setLocBtn = document.getElementById('set-location');
const locationDisplay = document.getElementById('location-display');

let uploadedImageUrl = null;
let lastUploadedUrlShown = null;
let recognition = null;
let isRecording = false;

/* Simple phone regex */
const PHONE_REGEX = /(\+?\d[\d\-\s]{8,15}\d)/;

/* ---------- helpers ---------- */
function showStatus(t){ statusEl.textContent = t || ''; }
function now(){ return Date.now(); }
function formatTime(ts){ return new Date(ts || Date.now()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function saveHistory(messages){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(messages)); }catch(e){console.warn(e);} }
function loadHistory(){ try{ const r = localStorage.getItem(STORAGE_KEY); return r ? JSON.parse(r) : []; }catch(e){console.warn(e); return []; } }
function saveLocation(loc){ try{ localStorage.setItem(LOCATION_KEY, JSON.stringify(loc)); }catch(e){console.warn(e);} }
function loadLocation(){ try{ const r = localStorage.getItem(LOCATION_KEY); return r ? JSON.parse(r) : null; }catch(e){console.warn(e); return null; } }

function setLocationDisplay(loc){
  if(!loc) locationDisplay.innerHTML = 'Location â€” <em>not set</em>';
  else if(loc.name) locationDisplay.innerHTML = 'Location â€” ' + escapeHtml(loc.name);
  else if(loc.coords) {
    const c = loc.coords;
    locationDisplay.innerHTML = 'Location â€” ' + c.latitude.toFixed(3) + ',' + c.longitude.toFixed(3);
  } else locationDisplay.innerHTML = 'Location â€” set';
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

/* ---------- rendering messages ---------- */
function createMessageEl({text,from='bot',imageUrl=null,ts}) {
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (from==='user' ? 'msg-user' : 'msg-bot');
  const span = document.createElement('span');
  span.innerHTML = escapeHtml(text || '');
  wrapper.appendChild(span);
  if(imageUrl){
    const img = document.createElement('img'); img.src = imageUrl; img.alt = 'image'; wrapper.appendChild(img);
  }
  const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = formatTime(ts); wrapper.appendChild(meta);
  return wrapper;
}
function addMessage(text, from='bot', imageUrl=null, ts=now(), save=true){
  const el = createMessageEl({text,from,imageUrl,ts});
  chatWindow.appendChild(el);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  if(save){
    const hist = loadHistory(); hist.push({text,from,imageUrl,ts}); saveHistory(hist);
  }
}

/* ---------- persistence restore ---------- */
(function restore(){
  const hist = loadHistory();
  chatWindow.innerHTML = '';
  if(!hist || !hist.length){
    addMessage("ðŸ‘‹ Namaste! Iâ€™m TatvaBot. How can I help with your plants today?", 'bot');
    injectQuickRow();
    setLocationDisplay(loadLocation());
    return;
  }
  hist.forEach(m => chatWindow.appendChild(createMessageEl(m)));
  injectQuickRow();
  setLocationDisplay(loadLocation());
  chatWindow.scrollTop = chatWindow.scrollHeight;
})();

/* ---------- quick buttons ---------- */
function injectQuickRow(){
  if(document.getElementById('quick-row')) return;
  const row = document.createElement('div'); row.id='quick-row'; row.className='quick-row';
  const items = [
    {t:'Why are leaves yellow?'}, {t:'Powdery mildew'}, {t:'Leaf holes / pests'}, {t:'Soil smell / drainage'}, {t:'Buy vermicompost', cls:'primary'}
  ];
  items.forEach(it => {
    const b = document.createElement('button'); b.className='quick-btn ' + (it.cls||''); b.textContent = it.t; b.setAttribute('data-q', it.t);
    row.appendChild(b);
  });
  // place after the first bot message if present
  const firstBot = chatWindow.querySelector('.msg-bot');
  if(firstBot && firstBot.nextSibling) chatWindow.insertBefore(row, firstBot.nextSibling);
  else chatWindow.appendChild(row);
  row.addEventListener('click', ev => {
    const btn = ev.target.closest('button[data-q]'); if(!btn) return;
    inputEl.value = btn.getAttribute('data-q'); sendMessage();
  });
}

/* ---------- upload stub (keeps original flow) ---------- */
chooseFileBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async () => {
  const file = fileInput.files && fileInput.files[0]; if(!file) return;
  showStatus('Uploading image...'); chooseFileBtn.disabled = true; sendBtn.disabled = true;
  try {
    // This expects your server POST /api/upload -> { url: "..." }
    const fd = new FormData(); fd.append('file', file);
    const res = await fetch('/api/upload', { method:'POST', body: fd });
    const data = await res.json().catch(()=>null);
    if(res.ok && data && (data.url || data.secure_url || data.result)) {
      uploadedImageUrl = data.url || data.secure_url || (data.result && data.result.secure_url) || null;
      if(uploadedImageUrl && uploadedImageUrl !== lastUploadedUrlShown){ addMessage('Image attached','user',uploadedImageUrl); lastUploadedUrlShown = uploadedImageUrl; }
      showStatus('Upload OK');
    } else { console.error('upload failed',res,data); alert('Upload failed'); showStatus('Upload failed'); }
  } catch(err){ console.error(err); alert('Upload error'); showStatus('Upload error'); }
  finally{ fileInput.value=''; chooseFileBtn.disabled=false; sendBtn.disabled=false; setTimeout(()=>showStatus(''),1400); }
});

/* ---------- diagnosis flows ---------- */
/* We'll implement a small rule-based multi-step diagnosis for "yellow leaves"
   and allow extension later. The flow is stored and answers collected; at end we auto-send to Formspree.
*/
const DIAGNOSES = {
  'yellow leaves': {
    title: 'Yellow leaves diagnosis',
    questions: [
      {key:'pattern', q:'Is yellowing uniform (whole leaf) or just between veins?', opts:['whole leaf','between veins']},
      {key:'water', q:'How often do you water this plant?', opts:['daily','weekly','rarely']},
      {key:'light', q:'Is the plant in bright sun or in shade?', opts:['bright sun','shade']}
    ],
    summarize: (answers, loc) => {
      const lines = [];
      lines.push('Yellow leaves diagnosis â€” summary\n');
      DIAGNOSES['yellow leaves'].questions.forEach((qq, i) => {
        lines.push((i+1)+'. '+qq.q+'\n   Answer: ' + (answers[qq.key]||'â€”'));
      });
      if(loc){
        if(loc.name) lines.push('\nLocation: ' + loc.name);
        else if(loc.coords) lines.push('\nLocation: ' + loc.coords.latitude.toFixed(4) + ',' + loc.coords.longitude.toFixed(4));
      }
      lines.push('\nTimestamp: ' + new Date().toLocaleString());
      return lines.join('\n');
    }
  }
};

let activeDiagnosis = null; // { id: 'yellow leaves', idx: questionIndex, answers:{} }

/* Try to detect intent in user message to start diagnosis */
function detectAndStartDiagnosis(text){
  if(!text) return false;
  const t = text.toLowerCase();
  if(t.includes('yellow') && t.includes('leaf')) {
    startDiagnosis('yellow leaves'); return true;
  }
  return false;
}

function startDiagnosis(id){
  const def = DIAGNOSES[id];
  if(!def) return;
  activeDiagnosis = { id, idx: 0, answers: {} };
  // show first question
  addMessage(def.questions[0].q, 'bot');
  showStatus('Diagnosis started');
}

/* When user answers a diagnosis question, capture answer and continue */
async function handleDiagnosisAnswer(text){
  if(!activeDiagnosis) return false;
  const def = DIAGNOSES[activeDiagnosis.id];
  const q = def.questions[activeDiagnosis.idx];
  // naive mapping: accept the user's text as answer (could validate with opts)
  activeDiagnosis.answers[q.key] = text || 'â€”';
  activeDiagnosis.idx += 1;
  if(activeDiagnosis.idx < def.questions.length){
    // ask next
    addMessage(def.questions[activeDiagnosis.idx].q, 'bot');
    return true;
  } else {
    // finished
    const summary = def.summarize(activeDiagnosis.answers, loadLocation());
    addMessage('Thanks â€” I\'ve prepared a short summary and sent it to the Tatvabhoomi team for follow-up.','bot');
    addMessage(summary, 'bot');
    // auto-send summary to Formspree (no phone required)
    try {
      await sendSummaryToFormspree(def.title, summary);
      console.info('Summary sent to Formspree');
    } catch(e){
      console.error('auto-send failed', e);
      addMessage('Auto-send failed. Will retry later.', 'bot');
    }
    activeDiagnosis = null;
    return true;
  }
}

/* ---------- send to Formspree (used for lead capture + diagnosis summary) ---------- */
async function sendSummaryToFormspree(subject, summary){
  // we send a JSON object to Formspree - they accept form data / json
  const payload = {
    subject: subject,
    message: summary,
    source: 'Tatvabhoomi chat',
    location: loadLocation()
  };
  const res = await fetch(FORMSPREE_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type':'application/json','Accept':'application/json' },
    body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error('Formspree error: ' + res.status);
  return res;
}

/* ---------- send flow (main) ---------- */
async function sendMessage(){
  const raw = inputEl.value.trim();
  const imageToSend = uploadedImageUrl || null;
  if(!raw && !imageToSend) return;
  // If diagnosis active, answers will be consumed
  // Show user's message (avoid duplicate image thumbnail)
  if(imageToSend && lastUploadedUrlShown === imageToSend){
    addMessage(raw || 'Image','user',null);
  } else {
    addMessage(raw || 'Image','user',imageToSend);
    lastUploadedUrlShown = imageToSend;
  }
  inputEl.value = '';
  // If the message looks like a phone, use Formspree lead capture (existing behaviour)
  const phoneMatch = raw.match(PHONE_REGEX);
  if(phoneMatch){
    const phoneDigits = phoneMatch[1].replace(/\D/g,'');
    showStatus('Saving your number...');
    sendBtn.disabled = true;
    try {
      await fetch(FORMSPREE_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({ phone: phoneDigits, message: raw, source: 'Tatvabhoomi chat', location: loadLocation() })
      });
      addMessage("Thank you! ðŸŒ± Your number has been shared with the Tatvabhoomi team. We'll reach out soon.", 'bot');
    } catch(e){ console.error(e); addMessage("Couldn't send your number â€” please try later.", 'bot'); }
    finally{ uploadedImageUrl = null; sendBtn.disabled = false; showStatus(''); }
    return;
  }

  // If a diagnosis is active, forward to diagnosis handler first
  if(activeDiagnosis){
    showStatus('Processing diagnosis answer...');
    try {
      await handleDiagnosisAnswer(raw);
    } catch(e){
      console.error('diagnosis error', e);
      addMessage('Sorry â€” diagnosis encountered an error.', 'bot');
    } finally {
      showStatus('');
    }
    uploadedImageUrl = null;
    return;
  }

  // If no diagnosis active, try to detect intent
  const started = detectAndStartDiagnosis(raw);
  if(started){
    uploadedImageUrl = null;
    return;
  }

  // Otherwise normal chat flow: forward to /api/chat (keeps your backend contract)
  showStatus('TatvaBot is thinking...');
  sendBtn.disabled = true;
  const typingEl = showTyping(); // visual typing indicator
  try {
    const body = { message: raw, image: imageToSend, location: loadLocation() || null };
    const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const data = await res.json().catch(()=>null);
    await new Promise(r => setTimeout(r, 500)); // small delay
    if(res.ok && data && (data.reply || data.text || data.answer)){
      const reply = data.reply || data.text || data.answer;
      const replyImage = data.image || data.img || null;
      removeTyping(typingEl);
      addMessage(reply, 'bot', replyImage || null);
    } else {
      removeTyping(typingEl);
      addMessage('Sorry â€” tatvabot had trouble replying. Try again later.', 'bot');
    }
  } catch(err){
    removeTyping(typingEl);
    console.error(err);
    addMessage('Network error. Please check your connection and try again.', 'bot');
  } finally {
    uploadedImageUrl = null;
    sendBtn.disabled = false;
    showStatus('');
  }
}

/* ---------- typing indicator ---------- */
function showTyping(){
  const el = document.createElement('div'); el.className='msg msg-bot typing-wrap';
  const span = document.createElement('span'); span.className='typing'; span.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  el.appendChild(span); chatWindow.appendChild(el); chatWindow.scrollTop = chatWindow.scrollHeight; return el;
}
function removeTyping(el){ if(el && el.parentNode) el.parentNode.removeChild(el); }

/* ---------- handlers ---------- */
sendBtn.addEventListener('click', sendMessage);
inputEl.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); sendMessage(); }});
clearBtn.addEventListener('click', ()=> { if(confirm('Clear saved chat history?')) { localStorage.removeItem(STORAGE_KEY); chatWindow.innerHTML=''; addMessage("ðŸ‘‹ Namaste! Iâ€™m TatvaBot. How can I help with your plants today?", 'bot'); injectQuickRow(); }});

/* ---------- voice (optional) ---------- */
function initSpeech(){
  const S = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!S) { micBtn.title = 'Voice not supported'; micBtn.style.opacity=.6; return null; }
  const r = new S(); r.lang='en-IN'; r.interimResults=true; r.maxAlternatives=1;
  r.onresult = ev => {
    let interim=''; let finalText='';
    for(let i=ev.resultIndex;i<ev.results.length;i++){
      const rr = ev.results[i];
      if(rr.isFinal) finalText += rr[0].transcript;
      else interim += rr[0].transcript;
    }
    inputEl.value = (finalText + interim).trim();
  };
  r.onerror = ev => { console.error('speech error',ev); stopRec(); showStatus('Voice error'); setTimeout(()=>showStatus(''),1500); };
  r.onend = ()=> { stopRec(); if(inputEl.value.trim()) sendMessage(); };
  return r;
}
function startRec(){ if(!recognition) recognition = initSpeech(); if(!recognition){ alert('Voice not supported'); return; } isRecording=true; micBtn.classList.add('recording'); micBtn.setAttribute('aria-pressed','true'); showStatus('Listening...'); recognition.start(); }
function stopRec(){ if(!recognition) return; try{ recognition.stop(); }catch(e){} isRecording=false; micBtn.classList.remove('recording'); micBtn.setAttribute('aria-pressed','false'); showStatus(''); }
micBtn.addEventListener('click', ()=> { if(isRecording) stopRec(); else startRec(); });

/* ---------- location handlers ---------- */
shareLocBtn.addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  showStatus('Requesting location...'); navigator.geolocation.getCurrentPosition(pos => {
    const loc = { coords: { latitude: pos.coords.latitude, longitude: pos.coords.longitude }, timestamp: Date.now() };
    saveLocation(loc); setLocationDisplay(loc); showStatus('Location saved'); setTimeout(()=>showStatus(''),1200);
  }, err => { console.error('geo error',err); showStatus('Could not get location'); setTimeout(()=>showStatus(''),1400); }, { timeout:10000 });
});
setLocBtn.addEventListener('click', ()=>{
  const name = prompt('Enter your city/locality (e.g. "Bengaluru, India")');
  if(name && name.trim()){ const loc = { name: name.trim(), timestamp: Date.now() }; saveLocation(loc); setLocationDisplay(loc); showStatus('Location saved'); setTimeout(()=>showStatus(''),1200); }
});
setLocationDisplay(loadLocation());

/* small console hint */
console.info('TatvaBot UI loaded â€” storage key:', STORAGE_KEY);
</script>
</body>
</html>
