<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TatvaBot â€” Upload + Camera</title>
<style>
  /* Minimal, clean chat-style layout */
  :root{
    --green: #1f8f3b;
    --muted: #f3f6f4;
    --bubble: #e9f4ec;
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  }
  body{ margin:0; background:#fff; color:#222; }
  .app { max-width:900px; margin:24px auto; padding:18px; }
  header { background:var(--green); color:#fff; padding:14px; border-radius:8px; font-weight:600;}
  .chat { margin-top:18px; min-height:420px; border-radius:8px; padding:16px; background:#fff; box-shadow:0 0 0 1px #eee inset;}
  .bubble { display:inline-block; margin:14px 0; padding:14px; background:var(--bubble); border-radius:12px; max-width:70%; }
  .bubble.bot { background:#f0f7f2; }
  .image-bubble { display:block; margin:10px 0; border-radius:10px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,.08); width:320px; }
  .image-bubble img { width:100%; display:block; }
  .controls { display:flex; gap:8px; align-items:center; margin-top:12px; }
  input[type="text"]{ flex:1; padding:10px 12px; border-radius:20px; border:1px solid #ddd; }
  button { background:var(--green); color:#fff; padding:8px 12px; border:0; border-radius:8px; cursor:pointer; }
  .small-btn { background:#f5f5f5; color:#333; padding:6px 10px; border-radius:8px; border:1px solid #ddd; cursor:pointer; display:inline-flex; gap:8px; align-items:center;}
  .status { display:inline-block; margin-right:10px; font-size:0.9em; color:#666; }
  .progress { height:8px; width:220px; background:#eee; border-radius:999px; overflow:hidden; }
  .progress > i { display:block; height:100%; width:0%; background:var(--green); transition:width .15s linear; }
  .hidden { display:none; }
  .error { color:#b02; font-weight:600; }
</style>
</head>
<body>
  <div class="app">
    <header>TatvaBot â€” Gardening Assistant</header>

    <div class="chat" id="chat">
      <div class="bubble bot">ğŸ‘‹ Namaste! I'm TatvaBot. How can I help with your plants today?</div>
    </div>

    <div class="controls" aria-hidden="false">
      <input id="msgInput" type="text" placeholder="Type your question..." />

      <!-- Camera file input (mobile friendly): capture attribute -->
      <input id="cameraInput" class="hidden" type="file" accept="image/*" capture="environment" />

      <!-- Hidden traditional file input -->
      <input id="fileInput" class="hidden" type="file" accept="image/*" />

      <button id="cameraBtn" class="small-btn" title="Take photo">
        ğŸ“· Camera
      </button>

      <button id="chooseBtn" class="small-btn" title="Choose file">
        â¬†ï¸ Upload
      </button>

      <button id="sendBtn">Send</button>
    </div>

    <div style="margin-top:10px; display:flex; align-items:center; gap:12px;">
      <span id="statusText" class="status"></span>
      <div class="progress" id="progressBar"><i></i></div>
    </div>

  </div>

<script>
/* ------- CONFIG (your Cloudinary settings) ------- */
const CLOUD_NAME = "dps3lh1ed";               // from you
const UPLOAD_PRESET = "tatvabot_unsigned";    // unsigned preset name
const UPLOAD_URL = https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload;

/* ------- DOM refs ------- */
const chat = document.getElementById('chat');
const fileInput = document.getElementById('fileInput');
const cameraInput = document.getElementById('cameraInput');
const chooseBtn = document.getElementById('chooseBtn');
const cameraBtn = document.getElementById('cameraBtn');
const statusText = document.getElementById('statusText');
const progressBar = document.getElementById('progressBar');
const progressFill = progressBar.querySelector('i');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');

/* ------- helpers ------- */
function appendBotBubble(text){
  const d = document.createElement('div');
  d.className = 'bubble bot';
  d.innerHTML = text;
  chat.appendChild(d);
  d.scrollIntoView({behavior:'smooth', block:'end'});
}
function appendImageBubble(url){
  const block = document.createElement('div');
  block.className = 'image-bubble';
  const img = document.createElement('img');
  img.src = url;
  img.alt = 'uploaded image';
  block.appendChild(img);
  chat.appendChild(block);
  block.scrollIntoView({behavior:'smooth', block:'end'});
}
function setStatus(text, err=false){
  statusText.textContent = text||'';
  statusText.className = err ? 'status error' : 'status';
}
function setProgress(p){ progressFill.style.width = ${p}%; }

/* ------- UI wiring ------- */
chooseBtn.addEventListener('click', ()=> fileInput.click());
cameraBtn.addEventListener('click', ()=> cameraInput.click());

fileInput.addEventListener('change', async (ev)=> {
  const file = ev.target.files?.[0];
  if(file) await doUpload(file);
  fileInput.value = '';
});
cameraInput.addEventListener('change', async (ev)=> {
  const file = ev.target.files?.[0];
  if(file) await doUpload(file);
  cameraInput.value = '';
});

// Send text message button: just adds a bubble and optionally call existing send handler
sendBtn.addEventListener('click', ()=> {
  const text = msgInput.value.trim();
  if(!text) return;
  const b = document.createElement('div');
  b.className = 'bubble';
  b.style.background = '#e2f2e8';
  b.textContent = text;
  chat.appendChild(b);
  b.scrollIntoView({behavior:'smooth', block:'end'});
  msgInput.value = '';
  // If your site exposes a global sendMessage function, call it with the text:
  if(window.sendMessage && typeof window.sendMessage === 'function'){
    try { window.sendMessage(text); } catch(e){ console.warn('sendMessage failed', e); }
  }
});

/* ------- Upload function using unsigned preset ------- */
async function doUpload(file){
  setStatus('Preparing upload...');
  setProgress(0);

  // Basic client-side size/type check:
  if(!file.type?.startsWith('image/')){
    setStatus('File is not an image', true);
    return;
  }

  // Build form
  const form = new FormData();
  form.append('file', file);
  form.append('upload_preset', UPLOAD_PRESET);

  // Show local preview immediately
  const tempUrl = URL.createObjectURL(file);
  appendImageBubble(tempUrl); // shows preview while uploading
  setStatus('Uploading...');

  try{
    const xhr = new XMLHttpRequest();
    xhr.open('POST', UPLOAD_URL, true);

    xhr.upload.onprogress = function(e){
      if(e.lengthComputable){
        const pct = Math.round((e.loaded / e.total) * 100);
        setProgress(pct);
      }
    };

    xhr.onload = function(){
      if(xhr.status >= 200 && xhr.status < 300){
        const res = JSON.parse(xhr.responseText);
        // Cloudinary returns secure_url / url
        const finalUrl = res.secure_url || res.url;
        setProgress(100);
        setStatus('Upload OK');

        // Replace the temporary previews with final image: (append second, remove previous temp)
        // For simplicity: append final image and keep previous.
        appendImageBubble(finalUrl);

        // If your frontend has a function to send message to the bot, pass the image URL
        if(window.sendMessage && typeof window.sendMessage === 'function'){
          try {
            // Send as an object { image: url } â€” adapt on backend if needed
            window.sendMessage({ image: finalUrl, from: 'upload' });
          } catch(e){ console.warn('sendMessage failed', e); }
        }
      } else {
        // 400 etc
        let message = Upload failed: ${xhr.status};
        try {
          const body = JSON.parse(xhr.responseText || '{}');
          if(body.error) message += ' â€” ' + (body.error.message || JSON.stringify(body.error));
        } catch(e){}
        setStatus(message, true);
        alert(message);
      }
    };

    xhr.onerror = function(){
      setStatus('Upload failed: network error', true);
      alert('Upload failed: network error');
    };

    xhr.send(form);

  } catch(err){
    setStatus('Upload failed: ' + (err.message||err), true);
    console.error(err);
    alert('Upload failed: ' + (err.message||err));
  }
}

/* Optional: keyboard Enter to send text */
msgInput.addEventListener('keydown', (e)=> {
  if(e.key === 'Enter') { sendBtn.click(); e.preventDefault(); }
});

</script>
</body>
</html>
