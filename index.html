<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>TatvaBot ‚Äî Chat + Image Upload (Voice + Location + Diagnosis)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#14532d">
<link rel="icon" href="/assets/icon-192.png">
<style>
  :root{
     --brown:#8b5a2b;
     --brown-light:#f4ebe2;
     --brown-border:#d6b89c;
    --green:#14532d;
    --muted:#f7f7f8;
    --bubble-bg:#f1f5f9;
    --text:#111827;
    --accent:#16a34a;
    --muted-border:#e6e6e6;
    --muted-dark:#e6e6e6;
    --danger:#c53030;
  }
  html,body{ height:100%; margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial; background:var(--muted); }
  body{ display:flex; align-items:center; justify-content:center; padding:18px; }
  .chat-wrapper{ width:100%; max-width:960px; background:#fff; border-radius:12px; box-shadow:0 12px 30px rgba(2,6,23,0.08); overflow:hidden; display:flex; flex-direction:column; min-height:560px; height:80vh; }
  .chat-header{ background:var(--green); color:#fff; padding:10px 14px; font-weight:600; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:1000; }
  .chat-header-left{display:flex; gap:12px; align-items:center;}
  .chat-header small{ display:block; font-weight:400; font-size:12px; opacity:.95; margin-top:2px; }
  .header-controls{ display:flex; gap:8px; align-items:center; }
  .btn-clear, .btn-ghost{ background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.12); padding:6px 8px;border-radius:8px;cursor:pointer;font-size:13px; }
  .chat-body{ display:flex; gap:0; padding:18px; flex:1 1 auto; min-height:0; box-sizing:border-box; }
  .chat-window{ flex:1; background:#fafafa; border-radius:8px; padding:14px; overflow:auto; height:100%; box-sizing:border-box; }
  .msg{ margin-bottom:12px; max-width:78%; line-height:1.4; display:flex; flex-direction:column; }
  .msg span{ display:block; background:var(--bubble-bg); color:var(--text); padding:12px 14px; border-radius:12px; white-space:pre-wrap; word-wrap:break-word; box-shadow:0 1px 0 rgba(0,0,0,0.02); }
  .msg .meta { font-size:11px; color:#7b7b7b; margin-top:6px; }
  .msg-user{ align-items:flex-end; margin-left:auto; text-align:right; }
  .msg-user span{ background:var(--green); color:#fff; }
  .msg img{ display:block; margin-top:8px; max-width:320px; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,0.06); }
  .typing { display:inline-block; padding:8px 12px; background:#ececec; border-radius:12px; }
  .typing .dot { width:6px;height:6px;background:#9a9a9a;border-radius:50%;display:inline-block;margin:0 3px;opacity:.6; animation: blink 1s infinite; }
  @keyframes blink { 0%{opacity:.15} 50%{opacity:1} 100%{opacity:.15} }
  .chat-footer{ border-top:1px solid var(--muted-border); padding:12px 14px; display:flex; gap:8px; align-items:center; background:#fff; }
  .chat-footer input[type="text"]{ flex:1; padding:10px 14px; border-radius:999px; border:1px solid #ddd; outline:none; font-size:14px; }
  .file-btn{ padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; font-size:16px; line-height:1; }
  .send{ background:var(--accent); color:#fff; border:none; padding:10px 16px; border-radius:999px; cursor:pointer; }
  .send:disabled{ opacity:.6; cursor:default; }

  #installBtn {
  background: #14532d;
  color: #ffffff;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  margin-left: 8px;
}
  .mic-btn{ width:40px; height:40px; border-radius:999px; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; cursor:pointer; background:#fff; }
  .mic-btn.recording{ box-shadow:0 0 0 6px rgba(197,48,48,0.08); border-color:var(--danger); }
  .status{ font-size:13px; color:#6b7280; padding:6px 18px 10px; min-height:20px; }
  .quick-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin:8px 0;
}

  /* =========================
   Sticky Quick Action Bar
   ========================= */
#quick-bar {
  position: sticky;
  top: 0;                 /* üî• key change */
  z-index: 900;
  background: #ffffff;
  padding: 10px 14px;
  border-bottom: 1px solid #e5e7eb;
}
  #quick-bar .quick-row {
  max-width: 960px;
  margin: 0 auto;
}
/* üå± Soil / brown themed quick tabs */
.quick-btn{
  background:var(--brown-light);
  border:1px solid var(--brown-border);
  color:#5b3a1e;
  padding:8px 14px;
  border-radius:999px;
  cursor:pointer;
  font-size:13px;
  display:flex;
  align-items:center;
  gap:6px;
}

.quick-btn:hover{
  background:#ead8c4;
}

.quick-btn.primary{
  background:var(--brown);
  color:#fff;
  border-color:var(--brown);
}
  /* =========================
   Quick Button Row Themes
   ========================= */

/* Plants row */
.quick-row.plants .quick-btn {
  background: #e8f5e9;
  border-color: #81c784;
  color: #1b5e20;
}

/* Problems row */
.quick-row.problems .quick-btn {
  background: #fff8e1;
  border-color: #ffca28;
  color: #7a4f01;
}

/* Actions / Special row */
.quick-row.actions .quick-btn {
  background: var(--brown-light);
  border-color: var(--brown-border);
  color: #5b3a1e;
}

/* Highlight primary action */
.quick-row.actions .quick-btn.primary {
  background: var(--brown);
  color: #fff;
}
  @media (max-width: 768px) {

  body {
    font-size: 14px;
  }

  .chat-header {
    padding: 10px;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .chat-header-left {
    width: 100%;
  }

  .header-controls {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .header-controls button {
    font-size: 12px;
    padding: 6px 10px;
  }

  .quick-row {
    gap: 6px;
  }

  .quick-btn {
    font-size: 12px;
    padding: 6px 10px;
  }

  #installBtn {
    width: 100%;
    text-align: center;
    margin-top: 6px;
  }
}

/* keep your existing rule */
@media (max-width:640px){
  .msg img { max-width:220px; }
}

  <style>
.product-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  margin: 8px 0;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  background: #ffffff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  max-width: 360px;
}

.product-img {
  width: 64px;
  height: 64px;
  object-fit: cover;
  border-radius: 8px;
  border: 1px solid #ddd;
}

.product-body {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.product-title {
  font-weight: 600;
  font-size: 14px;
  color: #111827;
}

.product-brand {
  font-size: 12px;
  color: #6b7280;
}

.product-price {
  font-size: 14px;
  font-weight: 600;
  color: #15803d;
}
</style>
</head>
<body>
  <div class="chat-wrapper" role="application" aria-label="TatvaBot chat">
    <div class="chat-header" id="chat-header">
  <div class="chat-header-left">
        <div>
          <div style="font-size:16px"><strong>TatvaBot ‚Äî Gardening Assistant</strong></div>
          <small>Ask about vermicompost, terrace gardening, or Tatvabhoomi products</small>
        </div>
      </div>
      <div class="header-controls">
        <div id="location-display" style="font-size:13px; opacity:.95">Location ‚Äî <em>not set</em></div>
        <button id="share-location" class="btn-ghost" title="Share device location">Share location</button>
        <button id="set-location" class="btn-ghost" title="Set location manually">Set location</button>
        <div style="font-size:12px;opacity:.95">v1</div>
        <button id="clear-btn" class="btn-clear" title="Clear chat history">Clear chat</button>
      <button id="installBtn">Install App</button>
      </div>
    </div>
<div id="quick-bar"></div>
    <div class="chat-body">
      <div id="chat-window" class="chat-window" aria-live="polite" role="log"></div>
    </div>

    <div id="status" class="status" aria-live="polite"></div>

    <div class="chat-footer" role="region" aria-label="Chat controls">
      <input id="user-input" type="text" placeholder="Type your question or use the mic..." autocomplete="off" aria-label="Type message" />
      <div id="mic-btn" class="mic-btn" title="Start voice input" aria-pressed="false">üé§</div>
      <label class="file-btn" id="choose-file-btn" title="Attach image (camera or gallery)">üìé</label>
      <input id="file-input" type="file" accept="image/*" capture="environment" style="display:none" />
      <button id="send-btn" class="send" aria-label="Send message">Send</button>
    </div>
  </div>

<script>
/* Single-file UI with multistep diagnosis and auto-send to Formspree.
   Replace FORMSPREE_ENDPOINT with your endpoint.
   Server endpoints expected:
     POST /api/upload  -> returns JSON { url: "<url>" } (or secure_url)
     POST /api/chat    -> used for normal chat (optional)
*/

const FORMSPREE_ENDPOINT = "https://formspree.io/f/xwpdkjaa";

const STORAGE_KEY_BASE = 'tatvabot_chat';
const STORAGE_VERSION = 'v3';
const STORAGE_KEY = STORAGE_KEY_BASE + '_' + STORAGE_VERSION;
const LOCATION_KEY = 'tatvabot_location_' + STORAGE_VERSION;
// üå¶ Weather API config
const OPENWEATHER_API_KEY = "76670e9cffa7ad0545a4972cd7830c5b";
const OPENWEATHER_BASE_URL = "https://api.openweathermap.org/data/2.5/weather";
   /* =========================
   üåø PLANT KNOWLEDGE BASE
========================= */
const PLANT_KNOWLEDGE = {
  tulsi: {
    name: "Tulsi (Holy Basil)",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/tulsi.jpg",
    about: "Tulsi is a sacred medicinal plant widely grown in Indian homes. It has strong aromatic leaves and is used in Ayurveda.",
    sunlight: "4‚Äì6 hours of direct sunlight daily. Prefers morning sun.",
    watering: "Water when topsoil is dry. Avoid daily watering.",
    soil: "Well-draining soil with compost. Avoid waterlogging.",
    temperature: "Thrives in warm climates (20‚Äì35¬∞C).",
    pruning: "Regular pruning encourages bushy growth.",
    commonMistakes: [
      "Overwatering",
      "Keeping in shade",
      "No drainage holes"
    ],
    quickTips: [
      "Pinch flower buds to promote leaf growth",
      "Use vermicompost once a month",
      "Move indoors during extreme cold"
    ]
  },
  areca: {
  name: "Areca Palm",
   image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/arecapalm.jpg",
  about: "Areca Palm is a popular indoor air-purifying plant with long feathery fronds. It thrives in bright indoor spaces.",
  sunlight: "Bright indirect light. Avoid harsh direct sunlight.",
  watering: "Water when top 1‚Äì2 inches of soil feel dry. Likes slightly moist soil.",
  soil: "Loose, well-draining potting mix with sand or cocopeat.",
  temperature: "Prefers 18‚Äì30¬∞C. Sensitive to cold drafts.",
  pruning: "Remove yellow or dry fronds at the base.",
  commonMistakes: [
    "Keeping in low light",
    "Overwatering",
    "Using heavy clay soil"
  ],
  quickTips: [
    "Mist leaves for humidity",
    "Rotate pot for even growth",
    "Use diluted vermicompost every 45 days"
  ]
},
  moneyplant: {
  name: "Money Plant (Pothos)",
  image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/moneyplant.jpg",  
 
  about: "Money Plant is a hardy indoor climber known for air-purifying qualities and easy maintenance. It thrives even in low light and is ideal for beginners.",
  sunlight: "Bright indirect light preferred, but tolerates low light.",
  watering: "Water when top 1‚Äì2 inches of soil are dry. Overwatering causes root rot.",
  soil: "Loose, well-draining soil. Can grow in water too.",
  temperature: "18‚Äì30¬∞C. Avoid cold drafts.",
  pruning: "Trim long vines regularly to promote bushy growth.",
  commonMistakes: [
    "Overwatering",
    "Keeping in complete darkness",
    "No pruning"
  ],
  quickTips: [
    "Grow in water with monthly water change",
    "Wipe leaves to remove dust",
    "Use vermicompost every 30‚Äì40 days"
  ]
},
   aloevera: {
    name: "Aloe Vera",
     image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/aloevera.jpg",
    about: "Aloe Vera is a succulent plant known for its medicinal gel. It is drought-tolerant and ideal for beginners.",
    sunlight: "Bright indirect sunlight or mild direct morning sun.",
    watering: "Water only when soil is completely dry. Overwatering causes root rot.",
    soil: "Sandy, well-draining soil (cactus or succulent mix).",
    temperature: "15‚Äì35¬∞C. Sensitive to frost.",
    pruning: "Remove damaged outer leaves from the base.",
    commonMistakes: [
      "Overwatering",
      "Keeping in shade",
      "Using heavy garden soil"
    ],
    quickTips: [
      "Water once every 10‚Äì15 days",
      "Use clay pots for better drainage",
      "Harvest gel only from mature leaves"
    ]
  },
  snakeplant: {
    name: "Snake Plant (Sansevieria)",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/snakeplant.jpg",
    about: "Snake plant is a hardy indoor plant known for air purification and extreme tolerance to neglect.",
    sunlight: "Low to bright indirect light. Avoid harsh direct sun.",
    watering: "Water only when soil is completely dry. Overwatering kills snake plants.",
    soil: "Very well-draining soil (cactus/succulent mix preferred).",
    temperature: "15‚Äì35¬∞C. Tolerates heat well.",
    pruning: "Remove damaged or yellow leaves from the base.",
    commonMistakes: [
      "Overwatering",
      "Poor drainage",
      "Keeping soil constantly moist"
    ],
    quickTips: [
      "Thrives in low light rooms",
      "Water once every 10‚Äì15 days",
      "Perfect plant for beginners"
    ]
  },
  rose: {
    name: "Rose",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/rose.jpg",
    about: "Rose is a flowering plant grown for its beautiful and fragrant blooms. It needs good sunlight, nutrition, and regular care to flower well.",
    sunlight: "5‚Äì6 hours of direct sunlight daily. Morning sun is best.",
    watering: "Water deeply when topsoil is dry. Do not water daily.",
    soil: "Rich, well-draining soil with compost and sand.",
    temperature: "15‚Äì30¬∞C. Protect from extreme heat and frost.",
    pruning: "Prune lightly after flowering to encourage new buds.",
    commonMistakes: [
      "Less sunlight",
      "Overwatering",
      "No pruning",
      "Skipping fertilizer"
    ],
    quickTips: [
      "Use vermicompost every 20‚Äì30 days",
      "Remove spent flowers regularly",
      "Check underside of leaves for pests"
    ]
  },
};
/* =========================
üå± PLANT SUGGESTION DATABASE
(ONLY for "What should I grow?")
========================= */

const PLANT_SUGGESTIONS = [
  {
    key: "aloevera",
    name: "Aloe Vera",
   image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/aloevera.jpg",
    weather: ["hot", "dry"],
    reason: "Thrives in heat, needs very little water, and is ideal for Indian summers."
  },
  {
    key: "areca",
    name: "Areca Palm",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/arecapalm.jpg",
    weather: ["humid", "moderate"],
    reason: "Loves warm, humid weather and grows well indoors with indirect light."
  },
  {
    key: "bougainvillea",
    name: "Bougainvillea",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/bougainvillea.jpg",
    weather: ["hot"],
    reason: "Perfect for hot climates, blooms beautifully in full sunlight."
  },
  {
    key: "portulaca",
    name: "Portulaca",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/portulaca.jpg",
    weather: ["hot", "dry"],
    reason: "A hardy summer flowering plant that survives extreme heat."
  },
  {
    key: "hibiscus",
    name: "Hibiscus",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/hibiscus.jpg",
    weather: ["humid", "hot"],
    reason: "Grows well in warm weather and rewards with large colorful flowers."
  },

  // üåø leafy / easy plants
  {
    key: "moneyplant",
    name: "Money Plant",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/moneyplant.jpg",
    weather: ["humid", "moderate"],
    reason: "Low maintenance climber that adapts to most Indian weather conditions."
  },
  {
    key: "snakeplant",
    name: "Snake Plant",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/snakeplant.jpg",
    weather: ["hot", "dry", "moderate"],
    reason: "Extremely hardy plant that tolerates heat, low light, and irregular watering."
  },
  {
    key: "tulsi",
    name: "Tulsi (Holy Basil)",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/tulsi.jpg",
    weather: ["hot", "moderate"],
    reason: "Sacred medicinal plant that grows well in warm Indian climates."
  },

  // üå∏ flowering
  {
    key: "rose",
    name: "Rose",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/rose.jpg",
    weather: ["moderate"],
    reason: "Prefers mild temperatures and rewards good sunlight with regular blooms."
  },
  {
    key: "vinca",
    name: "Vinca (Sadabahar)",
   image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/vinca.jpg",
    weather: ["hot"],
    reason: "Very heat-tolerant flowering plant ideal for Indian summers."
  },

  // üåø herbs & others
  {
    key: "mint",
    name: "Mint",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/mint.jpg",
    weather: ["moderate", "humid"],
    reason: "Grows fast in moderate weather and is perfect for kitchen gardens."
  },
  {
    key: "curryleaf",
    name: "Curry Leaf Plant",
   image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/curryleafplant.jpg",
    weather: ["hot"],
    reason: "Loves warmth and sunlight; ideal for balconies and terraces."
  },

  // üå± indoor
  {
    key: "peace_lily",
    name: "Peace Lily",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/peacelily.jpg",
    weather: ["humid", "moderate"],
    reason: "Thrives indoors in warm, humid conditions with indirect light."
  },
  {
    key: "rubberplant",
    name: "Rubber Plant",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/rubberplant.jpg",
    weather: ["moderate"],
    reason: "Adaptable indoor plant with large leaves and low maintenance needs."
  },
  {
    key: "zzplant",
    name: "ZZ Plant",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/zzplant.jpg",
    weather: ["hot", "dry"],
    reason: "Extremely drought tolerant and perfect for busy plant owners."
  },

  // üåµ succulents
  {
    key: "echeveria",
    name: "Echeveria",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/echeveria.jpg",
    weather: ["dry"],
    reason: "Succulent that thrives in dry weather with minimal watering."
  },
  {
    key: "haworthia",
    name: "Haworthia",
    image: "https://raw.githubusercontent.com/myselfneerajnaiyar-hash/tatvabot-minimal/main/assets/haworthia.jpg",
    weather: ["dry", "moderate"],
    reason: "Compact succulent ideal for indoor pots and low water conditions."
  }
];
  
  
const chatWindow = document.getElementById('chat-window');
  let mainQuickBarHTML = '';
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
async function analyzePlantImage() {
  return "Image received. I will ask a few questions to diagnose the issue.";
}
const chooseFileBtn = document.getElementById('choose-file-btn');
const statusEl = document.getElementById('status');
const clearBtn = document.getElementById('clear-btn');
const micBtn = document.getElementById('mic-btn');
const shareLocBtn = document.getElementById('share-location');
const setLocBtn = document.getElementById('set-location');
const locationDisplay = document.getElementById('location-display');

let uploadedImageUrl = null;
let lastUploadedUrlShown = null;
let recognition = null;
let isRecording = false;

// diagnosis state container
let diagnosisState = null; // {flow: 'yellow_leaves', qIndex:0, answers: []}
  let currentPlant = null;
let diagnosisCompleted = false;

// üåû Daily care state

let selectedPlantsForCare = new Set();
  // üîπ Action Panel State (NEW)
let activeActionPanel = null;
let activeActionType = null
// { plants: [], awaitingSelection: false }
  
// phone regex
const PHONE_REGEX = /(\+?\d[\d\-\s]{8,15}\d)/;

// --- helpers ---
function showStatus(text){ statusEl.textContent = text || ''; }

function formatTime(ts){ const d = new Date(ts || Date.now()); return d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }); }
function createMessageElement({ text, from = 'bot', imageUrl = null, ts }) {
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (from === 'user' ? 'msg-user' : 'msg-bot');

  const span = document.createElement('span');
  span.innerHTML = (text || '').replace(/\n/g, '<br>');
  wrapper.appendChild(span);

 if (
  imageUrl &&
  typeof imageUrl === "string" &&
  imageUrl.startsWith("http")
) {
  const img = document.createElement('img');
  img.src = imageUrl;
  img.alt = '';
  img.loading = 'lazy';

  wrapper.appendChild(img);
}

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = formatTime(ts);
  wrapper.appendChild(meta);

  return wrapper;
}

function loadHistory(){ try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ console.warn(e); return null; } }
function saveHistory(msgs){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(msgs)); } catch(e){ console.warn(e); } }
function appendHistoryItem(item){ const h = loadHistory() || []; h.push(item); saveHistory(h); }
function scrollToElementTop(el) {
  const containerTop = chatWindow.getBoundingClientRect().top;
  const elementTop = el.getBoundingClientRect().top;

  chatWindow.scrollTop += elementTop - containerTop - 12;
}
  
function addMessage(text, from = "bot", imageUrl = null, ts = Date.now(), save = true) {
  if (!text || text === "![image]" || text.trim() === "image") return;

  const el = createMessageElement({ text, from, imageUrl, ts });
  chatWindow.appendChild(el);
  // üîí HARD FIX: wait for DOM + images + layout to fully settle
  setTimeout(() => {
  if (from === 'user') {
    // user messages ‚Üí always go bottom
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
}, 0);

  if (save) appendHistoryItem({ text, from, imageUrl, ts });
}
function clearHistory(){ try { localStorage.removeItem(STORAGE_KEY); chatWindow.innerHTML = ''; ensureInitialMessage(); } catch(e){ console.warn(e); } }

function saveLocation(loc) {
  try {
    // Attach nursery_id when name matches a known nursery
    if (loc && loc.name) {
      const NURSERY_MAP = {
        "demo_nursery": 6863,
        "Demo Nursery": 6863,
        "delhi_nursery": 7001,
        "gurgaon_nursery": 7002
      };

      if (NURSERY_MAP[loc.name]) {
        loc.nursery_id = NURSERY_MAP[loc.name];
      }
    }

    localStorage.setItem(LOCATION_KEY, JSON.stringify(loc));
  } catch (e) {
    console.warn(e);
  }
}
function loadLocation(){ try { const raw = localStorage.getItem(LOCATION_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; } }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]; }); }
 function setLocationDisplay(loc){ if(!loc) { locationDisplay.innerHTML = 'Location ‚Äî <em>not set</em>'; } else if(loc.name){ locationDisplay.innerHTML = 'Location ‚Äî ' + escapeHtml(loc.name); } else if(loc.coords){ const c = loc.coords; locationDisplay.innerHTML = 'Location ‚Äî ' + c.latitude.toFixed(3) + ',' + c.longitude.toFixed(3); } else { locationDisplay.innerHTML = 'Location ‚Äî <em>not set</em>'; } }
async function getWeatherForUser() {
  const loc = loadLocation();
  if (!loc) return null;

  let url = "";

  // Case 1: GPS
  if (loc.coords) {
    url = `${OPENWEATHER_BASE_URL}?lat=${loc.coords.latitude}&lon=${loc.coords.longitude}&units=metric&appid=${OPENWEATHER_API_KEY}`;
  }

  // Case 2: City name
  if (loc.name) {
    url = `${OPENWEATHER_BASE_URL}?q=${encodeURIComponent(loc.name)}&units=metric&appid=${OPENWEATHER_API_KEY}`;
  }

  try {
    const res = await fetch(url);
    if (!res.ok) return null;
    return await res.json();
  } catch (e) {
    console.error("Weather fetch failed", e);
    return null;
  }
}
  // üå¶Ô∏è Convert raw weather into gardener-style summary
function getGardenerWeatherSummary(weather) {
  if (!weather || !weather.main || !weather.weather) return null;

  const temp = weather.main.temp;
  const humidity = weather.main.humidity;
  const condition = weather.weather[0].main.toLowerCase();
  const city = weather.name || "your area";

  let summary = `üå¶Ô∏è Today in ${city}: `;

  // Temperature logic
  if (temp <= 15) {
    summary += "It‚Äôs quite cool. ";
  } else if (temp <= 25) {
    summary += "The weather is pleasant. ";
  } else if (temp <= 35) {
    summary += "It‚Äôs warm today. ";
  } else {
    summary += "It‚Äôs very hot today. ";
  }

  // Rain / fog / clouds
  if (condition.includes("rain")) {
    summary += "It has rained recently or may rain. Soil will stay moist longer. ";
  } else if (condition.includes("fog")) {
    summary += "There is fog and low evaporation. ";
  } else if (condition.includes("cloud")) {
    summary += "It‚Äôs cloudy with limited sunlight. ";
  } else {
    summary += "Plenty of sunlight is available. ";
  }

  // Humidity logic
  if (humidity >= 80) {
    summary += "Humidity is high, so avoid watering unless soil is dry.";
  } else if (humidity >= 50) {
    summary += "Humidity is moderate. Normal watering rules apply.";
  } else {
    summary += "Air is dry, plants may need closer moisture checks.";
  }

  return summary;
}
 const PRODUCT_TYPE_MAP = {
  seed_germination: 7202,
  plant_tonic: 7201,
  micronutrient_mix: 7200,
  soil_conditioner: 7199,
  fungicide: 7198,
  organic_pest_control: 7197,
  neem_oil: 7196,
  root_growth_promoter: 7195,
  leaf_growth_booster: 7194,
  flower_booster: 7193,
  liquid_fertilizer: 7192,
  organic_fertilizer: 7191,
  potting_mix: 7190,
  cocopeat: 7172,
  vermicompost: 7106
};
  const PRODUCT_EDUCATION = {

  liquid_fertilizer: {
    title: "üß¥ Liquid Fertilizer",
    body:
      "Liquid fertilizers provide fast-acting nutrients that are quickly absorbed by plants.\n\n" +
      "‚úÖ Benefits:\n" +
      "‚Ä¢ Immediate nutrient availability\n" +
      "‚Ä¢ Revives weak plants\n" +
      "‚Ä¢ Supports rapid growth\n\n" +
      "ü™¥ How to use:\n" +
      "‚Ä¢ Always dilute before use\n" +
      "‚Ä¢ Can be applied to soil or leaves\n\n" +
      "üìè Dosage:\n" +
      "‚Ä¢ 2‚Äì5 ml per litre water\n" +
      "‚Ä¢ Use once every 10‚Äì15 days"
  },

  neem_oil: {
    title: "üêõ Neem Oil",
    body:
      "Neem oil is a natural organic pesticide effective against most garden pests.\n\n" +
      "‚úÖ Benefits:\n" +
      "‚Ä¢ Controls aphids, mites, whiteflies\n" +
      "‚Ä¢ Prevents fungal infections\n\n" +
      "ü™¥ How to use:\n" +
      "‚Ä¢ Mix with water + mild soap\n" +
      "‚Ä¢ Spray both sides of leaves\n\n" +
      "üìè Dosage:\n" +
      "‚Ä¢ 3‚Äì5 ml per litre water\n" +
      "‚Ä¢ Spray every 5‚Äì7 days"
  },

  root_growth_promoter: {
    title: "üå± Root Growth Promoter",
    body:
      "Helps plants develop strong and healthy root systems.\n\n" +
      "‚úÖ Benefits:\n" +
      "‚Ä¢ Better nutrient absorption\n" +
      "‚Ä¢ Faster establishment after transplant\n\n" +
      "ü™¥ How to use:\n" +
      "‚Ä¢ Apply during transplanting\n\n" +
      "üìè Dosage:\n" +
      "‚Ä¢ 2‚Äì3 ml per litre water\n" +
      "‚Ä¢ Once every 15 days"
  },

  leaf_growth_booster: {
    title: "üçÉ Leaf Growth Booster",
    body:
      "Promotes lush green foliage and vegetative growth.\n\n" +
      "‚úÖ Benefits:\n" +
      "‚Ä¢ Larger, greener leaves\n" +
      "‚Ä¢ Improved photosynthesis\n\n" +
      "ü™¥ How to use:\n" +
      "‚Ä¢ Best during growth phase\n\n" +
      "üìè Dosage:\n" +
      "‚Ä¢ 2 ml per litre water\n" +
      "‚Ä¢ Spray every 10‚Äì15 days"
  },

  flower_booster: {
    title: "üå∏ Flower Booster",
    body:
      "Encourages bud formation and improves flowering quality.\n\n" +
      "‚úÖ Benefits:\n" +
      "‚Ä¢ More flowers\n" +
      "‚Ä¢ Longer blooming period\n\n" +
      "ü™¥ How to use:\n" +
      "‚Ä¢ Apply before flowering starts\n\n" +
      "üìè Dosage:\n" +
      "‚Ä¢ 2‚Äì3 ml per litre water\n" +
      "‚Ä¢ Every 15 days"
  },

  organic_fertilizer: {
    title: "üåø Organic Fertilizer",
    body:
      "Improves soil fertility and plant health naturally.\n\n" +
      "‚úÖ Benefits:\n" +
      "‚Ä¢ Improves soil structure\n" +
      "‚Ä¢ Long-term nutrition\n\n" +
      "ü™¥ How to use:\n" +
      "‚Ä¢ Mix with topsoil\n\n" +
      "üìè Dosage:\n" +
      "‚Ä¢ 1‚Äì2 handfuls per pot\n" +
      "‚Ä¢ Once a month"
  },

  potting_mix: {
    title: "ü™¥ Potting Mix",
    body:
      "Ready-to-use soil mix for pots and grow bags.\n\n" +
      "‚úÖ Benefits:\n" +
      "‚Ä¢ Good drainage\n" +
      "‚Ä¢ Balanced nutrients\n\n" +
      "ü™¥ How to use:\n" +
      "‚Ä¢ Use directly for planting\n\n" +
      "üìè Usage:\n" +
      "‚Ä¢ Fill pots completely\n" +
      "‚Ä¢ Replace soil every 6‚Äì12 months"
  },

  micronutrient_mix: {
    title: "üß™ Micronutrient Mix",
    body:
      "Supplies essential trace elements required by plants.\n\n" +
      "‚úÖ Benefits:\n" +
      "‚Ä¢ Prevents deficiency symptoms\n\n" +
      "ü™¥ How to use:\n" +
      "‚Ä¢ Apply as foliar spray\n\n" +
      "üìè Dosage:\n" +
      "‚Ä¢ 1‚Äì2 g per litre water\n" +
      "‚Ä¢ Once a month"
  },

  soil_conditioner: {
    title: "üå± Soil Conditioner",
    body:
      "Improves soil texture and water-holding capacity.\n\n" +
      "‚úÖ Benefits:\n" +
      "‚Ä¢ Better aeration\n\n" +
      "ü™¥ How to use:\n" +
      "‚Ä¢ Mix with soil before planting\n\n" +
      "üìè Usage:\n" +
      "‚Ä¢ 10‚Äì20% of soil volume"
  },

  fungicide: {
    title: "ü¶† Organic Fungicide",
    body:
      "Controls fungal diseases in plants.\n\n" +
      "‚úÖ Benefits:\n" +
      "‚Ä¢ Prevents leaf spots & rot\n\n" +
      "ü™¥ How to use:\n" +
      "‚Ä¢ Spray affected areas\n\n" +
      "üìè Dosage:\n" +
      "‚Ä¢ As per label instructions"
  },

  seed_germination: {
    title: "üå± Seed Germination Aid",
    body:
      "Improves seed sprouting success.\n\n" +
      "‚úÖ Benefits:\n" +
      "‚Ä¢ Faster germination\n\n" +
      "ü™¥ How to use:\n" +
      "‚Ä¢ Soak seeds before sowing\n\n" +
      "üìè Usage:\n" +
      "‚Ä¢ As directed"
  },

  plant_tonic: {
    title: "üçµ Plant Tonic",
    body:
      "General health booster for stressed plants.\n\n" +
      "‚úÖ Benefits:\n" +
      "‚Ä¢ Improves immunity\n\n" +
      "ü™¥ How to use:\n" +
      "‚Ä¢ Apply during stress periods\n\n" +
      "üìè Dosage:\n" +
      "‚Ä¢ Every 15 days"
  }

};
  /* =========================
   üîò ACTION PANEL SYSTEM
========================= */
function showProductEducation(key) {
  const p = PRODUCT_EDUCATION[key];
  if (!p) return;

  // 1Ô∏è‚É£ Show detailed education
  addMessage(
    `${p.title}\n\n${p.body}\n\nWould you like to see products available at this nursery?`,
    "bot"
  );

  // 2Ô∏è‚É£ Show YES / NO buttons
  quickBar.innerHTML = '';

  const row = document.createElement('div');
  row.className = 'quick-row actions';

  const yesBtn = document.createElement('button');
  yesBtn.className = 'quick-btn primary';
  yesBtn.textContent = '‚úÖ Yes, show products';
  yesBtn.onclick = () => {
    showSupplementProductList(key);
  };

  const noBtn = document.createElement('button');
  noBtn.className = 'quick-btn';
  noBtn.textContent = '‚ùå No, maybe later';
  noBtn.onclick = () => {
    addMessage(
      "üëç No problem. You can explore other plant supplements anytime.",
      "bot"
    );
    renderMainQuickBar();
  };

  row.appendChild(yesBtn);
  row.appendChild(noBtn);
  quickBar.appendChild(row);
}
  function showProductListPlaceholder(key) {
  quickBar.innerHTML = '';

  addMessage(
    `üõí Products for ${key.replace(/_/g, ' ')}\n\n` +
    "This will show:\n" +
    "‚Ä¢ Product image\n" +
    "‚Ä¢ Price\n" +
    "‚Ä¢ Pack size\n\n" +
    "Demo nursery data will be used for now.",
    "bot"
  );

  showBackButton();
}
function destroyActionPanel() {
  if (activeActionPanel) {
    activeActionPanel.remove();
    activeActionPanel = null;
    activeActionType = null;
  }
}
  function showBackButton() {
  const quickBar = document.getElementById('quick-bar');

  // do not add twice
  if (document.getElementById('back-to-main')) return;

  const row = document.createElement('div');
  row.className = 'quick-row back-row';

  const btn = document.createElement('button');
  btn.className = 'quick-btn primary';
  btn.id = 'back-to-main';
  btn.textContent = '‚Üê Back';

  btn.onclick = () => {
    destroyActionPanel();
    activeActionType = null;
    renderMainQuickBar();
  };

  row.appendChild(btn);

  // IMPORTANT: prepend, do NOT replace
  quickBar.prepend(row);
}
/* =========================
   üß≠ TOP QUICK BAR SYSTEM
========================= */

const quickBar = document.getElementById('quick-bar');

function renderMainQuickBar() {
  quickBar.innerHTML = '';

  const buttons = [
    { label: "üåû Today‚Äôs Plant Care", action: "daily_care" },
    { label: "ü©∫ Diagnosis", action: "diagnosis" },
    { label: "üåø Plant Info", action: "plant_info" },
    { label: "üå± What should I grow", action: "plant_suggestions" },
    { label: "üß™ Plant Growth Supplements", action: "supplements" }
  ];

  const row = document.createElement('div');
  row.className = 'quick-row actions';

  buttons.forEach(b => {
    const btn = document.createElement('button');
    btn.className = 'quick-btn';
    btn.textContent = b.label;
    btn.dataset.action = b.action;

    btn.onclick = () => handleMainAction(b.action);
    row.appendChild(btn);
  });

  quickBar.appendChild(row);
}

function handleMainAction(action) {
  if (action === 'daily_care') {
    renderDailyCareSelection();
    return;
  }

  if (action === 'diagnosis') {
    renderDiagnosisOptions();
    return;
  }

  if (action === 'plant_info') {
    renderPlantInfoOptions();
    return;
  }

  if (action === 'plant_suggestions') {
    suggestPlantsToGrow();
    return;
  }

  if (action === 'supplements') {
    quickBar.innerHTML = '';

    const row = document.createElement('div');
    row.className = 'quick-row actions';

    const categories = [
      { key: 'soil', label: 'ü™± Soil & Growing Media' },
      { key: 'nutrition', label: 'üß¥ Nutrition & Boosters' },
      { key: 'pest', label: 'üêõ Pest Control' },
      { key: 'disease', label: 'ü¶† Disease Control' }
    ];

    categories.forEach(c => {
      const btn = document.createElement('button');
      btn.className = 'quick-btn';
      btn.textContent = c.label;

      btn.onclick = () => {
        destroyActionPanel();

        if (c.key === 'soil') {
          showSoilProducts();
          return;
        }
if (c.key === 'nutrition') {
  showSupplementProducts('nutrition');
  return;
}

if (c.key === 'pest') {
  showSupplementProducts('pest');
  return;
}

if (c.key === 'disease') {
  showSupplementProducts('disease');
  return;
}
        addMessage(
          `üå± ${c.label}\n\nThis category will be enabled soon.`,
          'bot'
        );
      };

      row.appendChild(btn);
    });

    quickBar.appendChild(row);
    showBackButton();
    activeActionType = 'supplements';
  }
}
 function showSoilProducts() {
  destroyActionPanel();
  quickBar.innerHTML = '';

  const row = document.createElement('div');
  row.className = 'quick-row actions';

 const products = [
  { key: 'vermicompost', label: 'ü™± Vermicompost' },
  { key: 'cocopeat', label: 'ü•• Cocopeat' },
  { key: 'potting_mix', label: 'ü™¥ Potting Mix (Ready Mix Soil)' },
  { key: 'soil_conditioner', label: 'üå± Soil Conditioner' }
];

products.forEach(p => {
  const btn = document.createElement('button');
  btn.className = 'quick-btn';
  btn.textContent = p.label;

 btn.onclick = () => {

  // existing special cases (DO NOT TOUCH)
  if (p.key === 'cocopeat') {
    showCocopeatEducation();
    return;
  }

  if (p.key === 'vermicompost') {
    showVermicompostEducation();
    return;
  }

  // üî• ALL OTHER PRODUCTS USE STANDARD EDUCATION
  showProductEducation(p.key);
};

  row.appendChild(btn);
});

  quickBar.appendChild(row);
  showBackButton();
  activeActionType = 'soil_products';
}
  function showCocopeatEducation() {
  addMessage(
    "ü•• Cocopeat (Coconut Coir)\n\n" +
    "Cocopeat is a natural growing medium made from coconut husk.\n\n" +
    "‚úÖ Benefits:\n" +
    "‚Ä¢ Improves soil aeration\n" +
    "‚Ä¢ Retains moisture\n" +
    "‚Ä¢ Encourages healthy root growth\n\n" +
    "ü™¥ How to use:\n" +
    "‚Ä¢ Mix with garden soil (30‚Äì50%)\n" +
    "‚Ä¢ Can be used in pots, grow bags, and seed trays\n\n" +
    "üìè General dosage:\n" +
    "‚Ä¢ Small pots: 1‚Äì2 handfuls\n" +
    "‚Ä¢ Grow bags: 20‚Äì30% of mix\n\n" +
    "Would you like to see cocopeat products available at this nursery?",
    "bot"
  );

  // ‚úÖ SIMPLE YES / NO BUTTONS (NO ACTION PANEL)
  quickBar.innerHTML = '';

  const row = document.createElement('div');
  row.className = 'quick-row actions';

  const yesBtn = document.createElement('button');
  yesBtn.className = 'quick-btn primary';
  yesBtn.textContent = '‚úÖ Yes, show products';
 yesBtn.onclick = () => {
  showSupplementProductList("cocopeat");
};

  const noBtn = document.createElement('button');
  noBtn.className = 'quick-btn';
  noBtn.textContent = '‚ùå No, maybe later';
  noBtn.onclick = () => {
    addMessage(
      "üëç No problem. You can explore other plant supplements anytime.",
      "bot"
    );
   activeActionType = null;
destroyActionPanel();
renderMainQuickBar()
  };

  row.appendChild(yesBtn);
  row.appendChild(noBtn);
  quickBar.appendChild(row);
}
function showVermicompostEducation() {
  addMessage(
    "ü™± Vermicompost\n\n" +
    "Vermicompost is an organic manure made using earthworms. It improves soil fertility naturally.\n\n" +
    "‚úÖ Benefits:\n" +
    "‚Ä¢ Improves soil structure\n" +
    "‚Ä¢ Increases beneficial microbes\n" +
    "‚Ä¢ Promotes healthy plant growth\n\n" +
    "ü™¥ How to use:\n" +
    "‚Ä¢ Mix with topsoil\n" +
    "‚Ä¢ Can be added to pots, grow bags, and garden beds\n\n" +
    "üìè General dosage:\n" +
    "‚Ä¢ Small pots: 1‚Äì2 handfuls\n" +
    "‚Ä¢ Large pots: 3‚Äì4 handfuls\n" +
    "‚Ä¢ Garden beds: 1‚Äì2 kg per 10 sq ft\n\n" +
    "Would you like to see vermicompost products available at this nursery?",
    "bot"
  );

  quickBar.innerHTML = '';

  const row = document.createElement('div');
  row.className = 'quick-row actions';

  const yesBtn = document.createElement('button');
  yesBtn.className = 'quick-btn primary';
  yesBtn.textContent = '‚úÖ Yes, show products';
 yesBtn.onclick = () => {
  showSupplementProductList("vermicompost");
};

  const noBtn = document.createElement('button');
  noBtn.className = 'quick-btn';
  noBtn.textContent = '‚ùå No, maybe later';
  noBtn.onclick = () => {
    addMessage(
      "üëç No problem. You can explore other plant supplements anytime.",
      "bot"
    );
    renderMainQuickBar();
  };

  row.appendChild(yesBtn);
  row.appendChild(noBtn);
  quickBar.appendChild(row);
}
  
  
    function showCocopeatProducts() {
  quickBar.innerHTML = '';

  addMessage(
    "üõí Cocopeat products available at this nursery\n\n" +
    "This will show:\n" +
    "‚Ä¢ Product image\n" +
    "‚Ä¢ Price\n" +
    "‚Ä¢ Pack size (e.g. 1kg, 5kg)\n\n" +
    "Demo nursery data will be used for now.",
    "bot"
  );

  showBackButton();
}
 function showVermicompostProducts() {
  quickBar.innerHTML = '';

  addMessage(
    "üõí Vermicompost products available at this nursery\n\n" +
    "This will show:\n" +
    "‚Ä¢ Product image\n" +
    "‚Ä¢ Price\n" +
    "‚Ä¢ Pack size (e.g. 1kg, 5kg)\n\n" +
    "Demo nursery data will be used for now.",
    "bot"
  );

  showBackButton();
}
  function renderDiagnosisOptions() {
  quickBar.innerHTML = '';

  const problems = [
    { label: "Yellow Leaves", flow: "yellow_leaves" },
    { label: "Brown Spots", flow: "brown_spots" },
    { label: "Wilting", flow: "wilting" },
    { label: "Pests", flow: "pests" },
    { label: "Leaf Drop", flow: "leaf_drop" }
  ];

  const row = document.createElement('div');
  row.className = 'quick-row problems';

  problems.forEach(p => {
    const btn = document.createElement('button');
    btn.className = 'quick-btn';
    btn.textContent = p.label;
    btn.dataset.flow = p.flow;
    row.appendChild(btn);
  });

  quickBar.appendChild(row);
    showBackButton()
}

function renderPlantInfoOptions() {
  quickBar.innerHTML = '';

  const plants = [
    { label: "Tulsi", plant: "tulsi" },
    { label: "Money Plant", plant: "moneyplant" },
    { label: "Rose", plant: "rose" },
    { label: "Aloe Vera", plant: "aloevera" },
    { label: "Snake Plant", plant: "snakeplant" }
  ];

  const row = document.createElement('div');
  row.className = 'quick-row plants';

  plants.forEach(p => {
    const btn = document.createElement('button');
    btn.className = 'quick-btn';
    btn.textContent = p.label;
    btn.dataset.plant = p.plant;
    row.appendChild(btn);
  });

  quickBar.appendChild(row);
  showBackButton()
}

function renderDailyCareSelection() {
  const items = Object.keys(PLANT_KNOWLEDGE).map(k => ({
    key: k,
    label: PLANT_KNOWLEDGE[k].name
  }));

  renderActionPanel({
    title: "üåû Select plants for today‚Äôs care",
    items,
    onSelect: (selected) => {
      selectedPlantsForCare = new Set(selected);
    },
    onDone: () => {
      generateDailyCareAdvice();
      renderMainQuickBar();
    }
  });
}
function renderActionPanel({ title, items, onSelect, onDone }) {
  destroyActionPanel();

  const panel = document.createElement('div');
  panel.style.margin = '12px 0';
  panel.style.padding = '12px';
  panel.style.border = '1px solid #ddd';
  panel.style.borderRadius = '12px';
  panel.style.background = '#ffffff';

  const heading = document.createElement('div');
  heading.textContent = title;
  heading.style.fontWeight = '600';
  heading.style.marginBottom = '10px';
  panel.appendChild(heading);
  // üîπ Helper instruction text
const helperText = document.createElement('div');
helperText.textContent = 'Please select at least one plant to get today‚Äôs care instructions.';
helperText.style.fontSize = '13px';
helperText.style.color = '#555';
helperText.style.marginBottom = '10px';

panel.appendChild(helperText);

  const buttonsWrap = document.createElement('div');
  buttonsWrap.style.display = 'flex';
  buttonsWrap.style.flexWrap = 'wrap';
  buttonsWrap.style.gap = '8px';

  const selected = new Set();

  items.forEach(item => {
    const btn = document.createElement('button');
    btn.textContent = item.label;
    btn.style.padding = '8px 14px';
    btn.style.borderRadius = '999px';
    btn.style.border = '1px solid #ccc';
    btn.style.background = '#f7f7f7';
    btn.style.cursor = 'pointer';

    btn.onclick = () => {
      if (selected.has(item.key)) {
        selected.delete(item.key);
        btn.style.background = '#f7f7f7';
      } else {
        selected.add(item.key);
        btn.style.background = '#d1fae5';
      }

      onSelect([...selected]);
      doneBtn.style.display = selected.size ? 'block' : 'none';
    };

    buttonsWrap.appendChild(btn);
  });

  panel.appendChild(buttonsWrap);

  const doneBtn = document.createElement('button');
 doneBtn.textContent =
  activeActionType === 'soil_products'
    ? 'Continue'
    : '‚úÖ Get Today‚Äôs Care';
  doneBtn.className = 'send';
  doneBtn.style.marginTop = '12px';
  doneBtn.style.display = 'none';

  doneBtn.onclick = () => {
  helperText.remove(); // üßπ remove instruction text
  onDone([...selected]);
  destroyActionPanel();
};
  panel.appendChild(doneBtn);

  chatWindow.appendChild(panel);
  activeActionPanel = panel;

  setTimeout(() => {
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }, 0);
}
  // üåû Generate Daily Care Advice (GLOBAL)
async function generateDailyCareAdvice() {
  const weather = await getWeatherForUser();

  /* ---------- 1Ô∏è‚É£ RAW WEATHER FACTS ---------- */
  if (weather && weather.main && weather.weather) {
    const temp = weather.main.temp;
    const humidity = weather.main.humidity;
    const condition = weather.weather[0].description;
    const city = weather.name || "your area";

    addMessage(
      `üåç Weather Details (${city})\n\n` +
      `üå°Ô∏è Temperature: ${temp}¬∞C\n` +
      `üíß Humidity: ${humidity}%\n` +
      `üå¨Ô∏è Condition: ${condition}`,
      'bot'
    );
  }


  /* ---------- 2Ô∏è‚É£ GARDENER INTERPRETATION ---------- */
  const gardenerWeather = getGardenerWeatherSummary(weather);

  if (gardenerWeather) {
    addMessage(
      "üßë‚Äçüåæ Gardener‚Äôs Insight\n\n" + gardenerWeather,
      'bot'
    );
  }
// 2Ô∏è‚É£ Plant-wise advice
  selectedPlantsForCare.forEach(plantKey => {
    const plant = PLANT_KNOWLEDGE[plantKey];

    let weatherNote = '‚úÖ Normal watering rules apply.';
    if (weather) {
      const condition = weather.weather[0].main.toLowerCase();
      if (condition.includes('rain')) {
        weatherNote = 'üåß It rained recently ‚Äî skip watering today.';
      } else if (weather.main.humidity > 75) {
        weatherNote = 'üíß High humidity ‚Äî water only if soil is dry.';
      } else if (weather.main.temp > 35) {
        weatherNote = 'üî• Very hot ‚Äî water early morning or evening.';
      }
    }

    addMessage(
`üåû Today‚Äôs Care for ${plant.name}

üíß Watering:
${plant.watering}

‚òÄÔ∏è Light:
${plant.sunlight}

üå¶ Weather-based advice:
${weatherNote}

üìå Tip:
${plant.quickTips[0]}`,
      'bot'
    );
  });

  selectedPlantsForCare.clear();
}
 
  
// typing indicator
function showTypingIndicator(){ const el = document.createElement('div'); el.className = 'msg msg-bot typing-wrap'; const span = document.createElement('span'); span.className = 'typing'; span.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>'; el.appendChild(span); chatWindow.appendChild(el); chatWindow.scrollTop = chatWindow.scrollHeight; return el; }
function removeTypingIndicator(el){ if(el && el.parentNode) el.parentNode.removeChild(el); }
// quick row (DIAGNOSIS TABS)

// üå¶Ô∏è Classify weather into gardener-friendly types
function classifyWeather(weather) {
  if (!weather || !weather.main) return 'moderate';

  const temp = weather.main.temp;
  const humidity = weather.main.humidity;

  // üå° Indian gardening‚Äìfriendly logic
  if (temp >= 35) return 'hot';
  if (temp >= 20 && temp < 35) return 'moderate';

  // Delhi winter should NOT be extreme cold
  if (temp >= 10 && temp < 20) return 'moderate';

  // Only real cold (hill stations)
  return 'cold';
}
    async function suggestPlantsToGrow() {
  const weather = await getWeatherForUser();

  const weatherType = classifyWeather(weather)

  const matches = PLANT_SUGGESTIONS
  .filter(p => p.weather.includes(weatherType))
  .slice(0, 6);

// ‚ùÑÔ∏è TRUE cold-climate handling (Shimla, Manali, etc.)
if (weatherType === 'cold') {
  const coldMsg = createMessageElement({
    text:
`‚ùÑÔ∏è Cold Weather Advisory

Your area is experiencing true cold conditions.
Most tropical Indian plants struggle in this weather.

üå± What you CAN do right now:
* Grow hardy indoor plants (Snake Plant, ZZ Plant, Peace Lily)
* Start seeds indoors near sunlight
* Protect existing plants with covers or move them inside
* Focus on soil prep, composting & pruning

üå∏ Outdoor planting is best resumed when temperatures rise above 12‚Äì15¬∞C.`,
    from: 'bot'
  });

  chatWindow.appendChild(coldMsg);
  setTimeout(() => scrollToElementTop(coldMsg), 0);
  return; // üö® IMPORTANT: stop here
}

  // üîí Create ONE anchor message
  const anchor = createMessageElement({
    text: `üå± Best Plants to Grow Right Now\n\nBased on current ${weatherType} weather in your area:`,
    from: 'bot'
  });

  chatWindow.appendChild(anchor);

  // üåø Render plants
  matches.forEach(p => {
    const plantMsg = createMessageElement({
      text: `üåø ${p.name}\n${p.reason}`,
      from: 'bot',
      imageUrl: p.image
    });
    chatWindow.appendChild(plantMsg);
  });

  // üß≠ ONE FINAL SCROLL (this is the magic)
  setTimeout(() => scrollToElementTop(anchor), 0);
}
/* =========================
   üîò GLOBAL BUTTON CLICK HANDLER
   ========================= */

document.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;

  /* üå± What should I grow */
  if (btn.dataset.action === 'plant_suggestions') {
    suggestPlantsToGrow();
    return;
  }

  /* üåø Plant Info */
  if (btn.dataset.plant) {
    currentPlant = btn.dataset.plant;
    const plant = PLANT_KNOWLEDGE[currentPlant];

    addMessage(
`üåø ${plant.name}

üìò About:
${plant.about}

‚òÄÔ∏è Sunlight: ${plant.sunlight}
üíß Watering: ${plant.watering}
üå± Soil: ${plant.soil}
üå°Ô∏è Temperature: ${plant.temperature}

üëâ Now tell me the problem you are facing.`,
      'bot',
      plant.image
    );
    return;
  }

  /* ü©∫ Diagnosis */
  if (btn.dataset.flow) {
    startDiagnosis(btn.dataset.flow);
    return;
  }
});

// restore

  function ensureInitialMessage(){ addMessage("üëã Namaste! I‚Äôm TatvaBot. How can I help with your plants today?", 'bot', null, Date.now(), true);  }

(function restore(){
  const hist = loadHistory();
  const loc = loadLocation();
  setLocationDisplay(loc);

  chatWindow.innerHTML = '';

  if (Array.isArray(hist)) {
    hist.forEach(msg => {
      const el = createMessageElement(msg);
      chatWindow.appendChild(el);
    });
  } else {
    ensureInitialMessage();
  }

  // üî• ALWAYS inject fresh buttons AFTER messages
  const quickBar = document.getElementById('quick-bar');
mainQuickBarHTML = quickBar.innerHTML;


  chatWindow.scrollTop = chatWindow.scrollHeight;
})();

// --- upload ---
chooseFileBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', async () => {
  const file = fileInput.files && fileInput.files[0]; if(!file) return;
  showStatus('Uploading image...'); chooseFileBtn.disabled = true; sendBtn.disabled = true;
  try {
    const fd = new FormData(); fd.append('file', file);
    const res = await fetch('/api/upload', { method:'POST', body:fd });
    const data = await res.json().catch(()=>null);
    if(res.ok && data && (data.url || data.secure_url || data.result?.secure_url || data.result?.url)){
      uploadedImageUrl = data.url || data.secure_url || data.result?.secure_url || data.result?.url || null;
      if(uploadedImageUrl && uploadedImageUrl !== lastUploadedUrlShown){ addMessage('Image attached', 'user', uploadedImageUrl); lastUploadedUrlShown = uploadedImageUrl; }
      showStatus('Upload OK');
    } else { console.error('Upload failed', res, data); alert('Upload failed. Check server logs and console.'); showStatus('Upload failed'); }
  } catch(err){ console.error('Upload error', err); alert('Upload error: ' + (err.message || err)); showStatus('Upload error'); }
  finally { fileInput.value = ''; chooseFileBtn.disabled = false; sendBtn.disabled = false; setTimeout(()=>showStatus(''),1600); }
});
// --- diagnosis flows (config-driven) ---
const DIAG_FLOWS = {

  yellow_leaves: {
    title: 'Yellow leaves diagnosis',
    questions: [
      'Is yellowing uniform (whole leaf) or just between veins?',
      'How often do you water this plant? (daily / weekly / rarely)',
      'Is the plant in bright sun or in shade?',
      'Have you noticed any pests or unusual spots? (yes / no)'
    ],
    finishText(answers, location) {
      return buildSummary(this.title, this.questions, answers, location);
    }
  },

  brown_spots: {
    title: 'Brown spots on leaves',
    questions: [
      'Are the spots dry or wet/soft?',
      'Do the spots have yellow halos around them?',
      'Has the plant been exposed to rain or overhead watering?',
      'Are the spots spreading quickly? (yes / no)'
    ],
    finishText(answers, location) {
      return buildSummary(this.title, this.questions, answers, location);
    }
  },

  wilting: {
    title: 'Wilting plant diagnosis',
    questions: [
      'Is the soil currently wet or dry?',
      'Does the plant recover at night?',
      'Is the pot well-drained? (yes / no)',
      'Has the plant been moved recently? (yes / no)'
    ],
    finishText(answers, location) {
      return buildSummary(this.title, this.questions, answers, location);
    }
  },

  pests: {
    title: 'Pest infestation diagnosis',
    questions: [
      'Do you see insects on the plant? (aphids / mites / whiteflies / unknown)',
      'Are leaves curling or sticky?',
      'Are ants present near the plant?',
      'Is the infestation mild or heavy?'
    ],
    finishText(answers, location) {
      return buildSummary(this.title, this.questions, answers, location);
    }
  },

  leaf_drop: {
    title: 'Leaf drop diagnosis',
    questions: [
      'Are old leaves falling or new leaves?',
      'Did temperature change suddenly?',
      'Has watering routine changed recently?',
      'Is the plant indoors or outdoors?'
    ],
    finishText(answers, location) {
      return buildSummary(this.title, this.questions, answers, location);
    }
  },

  slow_growth: {
    title: 'Slow or stunted growth',
    questions: [
      'How old is the plant?',
      'Is it root-bound? (yes / no)',
      'How much sunlight does it receive?',
      'When was it last fertilized?'
    ],
    finishText(answers, location) {
      return buildSummary(this.title, this.questions, answers, location);
    }
  },

  flowering_issues: {
    title: 'Not flowering / fruiting',
    questions: [
      'Is the plant mature enough to flower?',
      'How many hours of sunlight does it get?',
      'Are you using high-nitrogen fertilizer?',
      'Is pruning done regularly?'
    ],
    finishText(answers, location) {
      return buildSummary(this.title, this.questions, answers, location);
    }
  }

};

// --- rule-based diagnosis engine ---
function diagnoseFromAnswers(answers){
  const a = answers.join(' ').toLowerCase();

  // 1. Overwatering
  if(a.includes('daily') || a.includes('wet')){
    return {
      issue: 'Overwatering stress',
      confidence: 'High (80%)',
      why: 'Frequent watering or soil staying wet',
      do: [
        'Stop watering until topsoil dries',
        'Ensure pot has drainage holes',
        'Keep plant in bright indirect light'
      ],
      dont: [
        'Do not add fertilizer',
        'Do not repot immediately'
      ]
    };
  }

  // 2. Underwatering
  if(a.includes('dry') || a.includes('rarely')){
    return {
      issue: 'Underwatering stress',
      confidence: 'High (80%)',
      why: 'Dry soil and infrequent watering',
      do: [
        'Water thoroughly until excess drains out',
        'Check soil moisture every 2‚Äì3 days'
      ],
      dont: [
        'Do not suddenly water daily'
      ]
    };
  }

  // 3. Pest attack
  if(a.includes('sticky') || a.includes('ants') || a.includes('web')){
    return {
      issue: 'Pest attack',
      confidence: 'High (85%)',
      why: 'Sticky residue, ants, or webbing detected',
      do: [
        'Isolate the plant',
        'Spray neem oil every 5‚Äì7 days'
      ],
      dont: [
        'Do not use harsh pesticides immediately'
      ]
    };
  }

  // 4. Fungal disease
  if(a.includes('powder') || a.includes('spots')){
    return {
      issue: 'Fungal disease',
      confidence: 'Medium (70%)',
      why: 'Spots or powdery growth with moisture',
      do: [
        'Avoid wetting leaves',
        'Improve airflow around plant'
      ],
      dont: [
        'Do not mist the plant'
      ]
    };
  }

  // fallback
  return {
    issue: 'Unclear cause',
    confidence: 'Low (<60%)',
    why: 'Symptoms overlap across multiple causes',
    do: [
      'Share a clear photo',
      'Confirm watering frequency and soil condition'
    ],
    dont: []
  };
}
// start diagnosis detection (simple keyword-based)
function detectDiagnosisIntent(message){
  const m = message.toLowerCase();

  if (m.includes('yellow') || m.includes('chlorosis')) {
    return 'yellow_leaves';
  }

  if (m.includes('brown') || m.includes('spot')) {
    return 'brown_spots';
  }

  if (m.includes('wilt') || m.includes('droop')) {
    return 'wilting';
  }

  if (m.includes('pest') || m.includes('sticky') || m.includes('insect')) {
    return 'pests';
  }

  if (m.includes('leaf drop') || m.includes('falling')) {
    return 'leaf_drop';
  }

  if (m.includes('slow') || m.includes('not growing')) {
    return 'slow_growth';
  }

  return null;
}
async function startDiagnosis(flowKey){
  const flow = DIAG_FLOWS[flowKey];
  if(!flow) return;
  diagnosisState = { flow: flowKey, qIndex: 0, answers: [] };
  // inform user
  addMessage('Diagnosis ‚Äî starting: ' + flow.title, 'bot');
  // ask first question
  await askDiagnosisQuestion();
}

async function askDiagnosisQuestion(){
  if(!diagnosisState) return;
  const flow = DIAG_FLOWS[diagnosisState.flow];
  const q = flow.questions[diagnosisState.qIndex];
  addMessage(q, 'bot');
  // (we wait for user message to handle)
}

async function handleDiagnosisAnswer(answerText){
  if(!diagnosisState) return;
  diagnosisState.answers.push(answerText);
  diagnosisState.qIndex++;
  const flow = DIAG_FLOWS[diagnosisState.flow];
  if(diagnosisState.qIndex < flow.questions.length){
    await askDiagnosisQuestion();
    return;
  }
  // finished
 // finished ‚Üí run diagnosis logic
const result = diagnoseFromAnswers(diagnosisState.answers);

let reply = `üåø Likely Issue
${result.issue} (${result.confidence})

üîç Why this is likely
${result.why}

‚úÖ What to do now
- ${result.do.join('\n- ')}`;

if (result.dont.length) {
  reply += `

‚ùå What NOT to do
- ${result.dont.join('\n- ')}`;
}

reply += `

üîÅ Recheck
If no improvement in 5‚Äì7 days, recheck with a new photo.`;

addMessage(reply, 'bot');
diagnosisState = null;
  diagnosisCompleted = true;
}
// --- send flow (Formspree phone detection + normal chat) ---

// handlers
  async function sendMessage() {
  const messageRaw = input.value.trim();
  const imageToSend = uploadedImageUrl || null;

  // üåû Finish Daily Care Mode
 

  if (!messageRaw && !imageToSend) return;

  // show user message
  addMessage(messageRaw || 'Image', 'user', imageToSend);
  input.value = '';

  // diagnosis flow
  if (diagnosisState) {
    await handleDiagnosisAnswer(messageRaw);
    return;
  }

  // normal chat
  showStatus('TatvaBot is thinking...');
  sendBtn.disabled = true;
  const typingEl = showTypingIndicator();

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: messageRaw,
        imageUrl: uploadedImageUrl || null,
        location: loadLocation() || null
      })
    });

    const data = await res.json();
    removeTypingIndicator(typingEl);

   if (data?.reply) {
  let reply = data.reply;

  // Attach images for suggested plants (What should I grow?)
  

  addMessage(reply, 'bot');
} else {
  addMessage('Sorry, I could not understand that.', 'bot');
}

  } catch (err) {
    removeTypingIndicator(typingEl);
    addMessage('Network error. Please try again.', 'bot');
  } finally {
    uploadedImageUrl = null;
    sendBtn.disabled = false;
    showStatus('');
  }
}
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); sendMessage(); }});
clearBtn.addEventListener('click', ()=>{ if(confirm('Clear saved chat history? This cannot be undone.')) clearHistory(); });

// --- voice ---
function initSpeech(){ const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; if(!SpeechRecognition){ micBtn.title = 'Voice input not supported in this browser'; micBtn.style.opacity = 0.6; return null; } const rec = new SpeechRecognition(); rec.lang = 'en-IN'; rec.interimResults = true; rec.maxAlternatives = 1; return rec; }
function startRecording(){
  if(!recognition) recognition = initSpeech();
  if(!recognition){ alert('Voice input not supported by this browser.'); return; }
  isRecording = true; micBtn.classList.add('recording'); micBtn.setAttribute('aria-pressed','true'); showStatus('Listening... Tap mic to stop');
  let interim = '', finalText = '';
  recognition.onresult = (event) => {
    interim = '';
    for(let i = event.resultIndex; i < event.results.length; i++){
      const r = event.results[i];
      if(r.isFinal) finalText += r[0].transcript;
      else interim += r[0].transcript;
    }
    input.value = (finalText + interim).trim();
  };
  recognition.onerror = (ev) => { console.error('Speech error', ev); stopRecording(); showStatus('Voice recognition error'); setTimeout(()=>showStatus(''),1500); };
  recognition.onend = () => { isRecording = false; micBtn.classList.remove('recording'); micBtn.setAttribute('aria-pressed','false'); showStatus(''); if(input.value.trim()) sendMessage(); };
  recognition.start();
}
function stopRecording(){ if(!recognition) return; try { recognition.stop(); } catch(e){} isRecording = false; micBtn.classList.remove('recording'); micBtn.setAttribute('aria-pressed','false'); showStatus(''); }
micBtn.addEventListener('click', ()=>{ if(isRecording) stopRecording(); else startRecording(); });

// --- location ---
shareLocBtn.addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Geolocation not supported in this browser.'); return; }
  showStatus('Requesting location...');
  navigator.geolocation.getCurrentPosition((pos) => {
    const loc = { coords: { latitude: pos.coords.latitude, longitude: pos.coords.longitude }, timestamp: Date.now() };
    saveLocation(loc); setLocationDisplay(loc); showStatus('Location saved'); setTimeout(()=>showStatus(''),1500);
  }, (err)=>{
    console.error('geo error', err); showStatus('Could not get location'); setTimeout(()=>showStatus(''),1500);
  }, { enableHighAccuracy:false, timeout:10000 });
});
setLocBtn.addEventListener('click', () => {
  const name = prompt('Enter your city or locality (e.g. "Bengaluru, India")');
  if (name && name.trim()) {
    const loc = {
      name: name.trim(),
      timestamp: Date.now()
    };
    saveLocation(loc);
    setLocationDisplay(loc);
    showStatus('Location saved');
    setTimeout(() => showStatus(''), 1500);
  }
});
// initial
setLocationDisplay(loadLocation());
input.focus();
console.info('TatvaBot UI loaded ‚Äî storage key:', STORAGE_KEY, 'location key:', LOCATION_KEY);
  renderMainQuickBar()
  /* =========================
   üå± SUPPLEMENTS MASTER CONFIG
   (Matches WordPress Product Types EXACTLY)
========================= */

const SUPPLEMENT_DATA = {
  nutrition: [
    {
      key: "root_growth_promoter",
      name: "Root Growth Promoter",
      education: "Improves root development, helps plants establish faster after transplanting."
    },
    {
      key: "leaf_growth_booster",
      name: "Leaf Growth Booster",
      education: "Boosts leaf size and greenness, ideal during vegetative growth."
    },
    {
      key: "flower_booster",
      name: "Flower Booster",
      education: "Enhances flowering and bud formation."
    },
    {
      key: "liquid_fertilizer",
      name: "Liquid Fertilizer",
      education: "Fast-acting nutrients absorbed quickly by plants."
    },
    {
      key: "organic_fertilizer",
      name: "Organic Fertilizer (General Purpose)",
      education: "Balanced nutrition for overall plant health."
    },
    {
      key: "plant_tonic",
      name: "Plant Tonic / Growth Tonic",
      education: "Improves plant immunity and stress resistance."
    },
    {
      key: "micronutrient_mix",
      name: "Micronutrient Mix",
      education: "Supplies essential trace elements like zinc, iron, magnesium."
    },
    {
      key: "seed_germination",
      name: "Seed Germination Aid",
      education: "Improves seed sprouting and early root development."
    }
  ],

  pest: [
    {
      key: "neem_oil",
      name: "Neem Oil",
      education: "Controls aphids, mites, whiteflies organically."
    },
    {
      key: "organic_pest_control",
      name: "Organic Pest Control (Non-Neem)",
      education: "Alternative organic solutions for pest management."
    }
  ],

  disease: [
    {
      key: "fungicide",
      name: "Fungicide (Organic / Mild)",
      education: "Controls fungal infections like leaf spot and mildew."
    }
  ]
};

/* =========================
   üîÑ GENERIC SUPPLEMENT FLOW
========================= */

function showSupplementProducts(categoryKey) {
  quickBar.innerHTML = '';

  const row = document.createElement('div');
  row.className = 'quick-row actions';

  const items = SUPPLEMENT_DATA[categoryKey] || [];

  items.forEach(item => {
    const btn = document.createElement('button');
    btn.className = 'quick-btn';
    btn.textContent = item.name;

   btn.onclick = () => {
  showProductEducation(item.key);
};

    row.appendChild(btn);
  });

  quickBar.appendChild(row);
  showBackButton();
}

function showSupplementProductList(key) {
  console.log("üî• NEW FUNCTION HIT:", key);
  quickBar.innerHTML = '';

  const typeId = PRODUCT_TYPE_MAP[key];
  if (!typeId) {
    addMessage("Unknown product type.", "bot");
    return;
  }

addMessage(
  `üõí Showing ${key.replace(/_/g, ' ')} products available at this nursery‚Ä¶`,
  "bot"
);

// get nursery from storage (white-label context)
const loc = JSON.parse(localStorage.getItem("tatvabot_location_v3") || "{}");
const nurseryId = loc.nursery_id;

if (!nurseryId) {
  addMessage("Nursery not set. Please reload the page.", "bot");
  return;
}

fetch(`https://tatvasutra.in/wp-json/tatvabot/v1/products?product_type_id=${typeId}&nursery_id=${nurseryId}`)
    .then(res => res.json())
    .then(products => {
      if (!products.length) {
        addMessage(
          "No products found for this category in this nursery.",
          "bot"
        );
        showBackButton();
        return;
      }
.then(products => {

  products.forEach(p => {
    const img = p.image || "https://via.placeholder.com/300x200?text=Product";

    addMessage(
      `<div class="product-card">
        <img src="${img}" class="product-img" />
        <div class="product-body">
          <div class="product-title">${p.title}</div>
          <div class="product-brand">Brand: ${p.brand || "‚Äî"}</div>
          <div class="product-price">‚Çπ${p.price}</div>
        </div>
      </div>`,
      "bot",
      true
    );
  });

  showBackButton();
});   // <-- this semicolon is the whole problem

.catch(() => {
  addMessage(
    "Failed to load products. Please try again.",
    "bot"
  );
  showBackButton();
});
 

 
</script>
  
<script>
let deferredPrompt;
const installBtn = document.getElementById("installBtn");

// Hide button initially
installBtn.style.display = "none";

window.addEventListener("beforeinstallprompt", (e) => {
  console.log("beforeinstallprompt fired");
  e.preventDefault();
  deferredPrompt = e;

  // Show install button
  installBtn.style.display = "block";
});

installBtn.addEventListener("click", async () => {
  if (!deferredPrompt) return;

  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  console.log("Install choice:", outcome);

  deferredPrompt = null;
  installBtn.style.display = "none";
});
</script>
  <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(registrations => {
    registrations.forEach(reg => {
      reg.unregister();
    });
  });

  caches.keys().then(keys => {
    keys.forEach(key => caches.delete(key));
  });
}
</script>
</body>
</html>
