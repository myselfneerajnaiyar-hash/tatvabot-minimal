<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TatvaBot ‚Äî Chat</title>
  <style>
    :root{--green:#1f8b3a;--light:#f6f8f6}
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:#fff;margin:0;padding:0;color:#222}
    .topbar{background:var(--green);color:#fff;padding:18px 28px;border-radius:6px;margin:18px;box-shadow:0 2px 0 rgba(0,0,0,.03)}
    .container{max-width:980px;margin:8px auto;padding:12px}
    .chat-window{height:62vh;border:1px solid #eee;border-radius:10px;padding:18px;overflow:auto;background:#fafafa}
    .bubble{display:inline-block;background:#e9f5e9;padding:12px 16px;border-radius:10px;margin:8px 0;max-width:72%;}
    .bubble.right{background:var(--green);color:#fff;float:right;clear:both}
    .img-preview{display:block;margin:12px auto;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.06);max-width:360px}
    .composer{display:flex;gap:8px;align-items:center;margin-top:12px}
    .input{flex:1;padding:12px 14px;border-radius:22px;border:1px solid #ddd}
    .btn{padding:8px 14px;border-radius:8px;border:0;background:var(--green);color:#fff;cursor:pointer}
    .btn.secondary{background:#f3f7f3;color:#333;border:1px solid #ddd}
    .small-note{font-size:12px;color:#666;margin-top:8px}
    .controls{display:flex;gap:8px;align-items:center}
    .hidden{display:none}
    .upload-status{font-size:13px;color:#333;margin-left:8px}
  </style>
</head>
<body>
  <div class="topbar">TatvaBot ‚Äî Gardening Assistant</div>

  <div class="container">
    <div class="chat-window" id="chatWindow" aria-live="polite">
      <div class="bubble">üëã Namaste! I'm TatvaBot. How can I help with your plants today?</div>
      <div style="clear:both"></div>
    </div>

    <div class="composer" style="margin-top:16px">
      <input id="textInput" class="input" type="text" placeholder="Type your question..." />
      <div class="controls">
        <button id="cameraBtn" class="btn secondary">üì∑ Camera</button>
        <button id="chooseBtn" class="btn secondary">‚¨ÜÔ∏è Upload</button>
        <input id="fileInput" class="hidden" type="file" accept="image/*" />
        <button id="uploadBtn" class="btn secondary">Upload</button>
        <button id="sendBtn" class="btn">Send</button>
      </div>
    </div>

    <div class="small-note">Uploads go directly to Cloudinary (unsigned preset).</div>
    <div id="uploadInfo" class="upload-status"></div>
  </div>

  <script>
    // ========== CONFIG - change only if needed ==========
    const CLOUD_NAME = 'dps3lh1ed';              // <- your cloud name
    const UPLOAD_PRESET = 'tatvabot_unsigned';  // <- your unsigned preset
    const API_ENDPOINT = '/api';                // <- backend endpoint that handles chat (POST)
    // ===================================================

    const chatWindow = document.getElementById('chatWindow');
    const textInput = document.getElementById('textInput');
    const fileInput = document.getElementById('fileInput');
    const chooseBtn = document.getElementById('chooseBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const sendBtn = document.getElementById('sendBtn');
    const uploadInfo = document.getElementById('uploadInfo');

    let selectedFile = null;
    let uploadedImageUrl = null;
    let isUploading = false;

    // show a message in chat (left = bot, right = user)
    function appendMessage(text, side='left'){
      const b = document.createElement('div');
      b.className = 'bubble' + (side === 'right' ? ' right' : '');
      b.innerText = text;
      chatWindow.appendChild(b);
      const br = document.createElement('div'); br.style.clear='both';
      chatWindow.appendChild(br);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // show image in chat
    function appendImage(url, side='right'){
      const img = document.createElement('img');
      img.src = url;
      img.className = 'img-preview';
      if(side === 'right'){
        const wrap = document.createElement('div');
        wrap.style.textAlign='right';
        wrap.appendChild(img);
        chatWindow.appendChild(wrap);
      } else {
        chatWindow.appendChild(img);
      }
      const br = document.createElement('div'); br.style.clear='both';
      chatWindow.appendChild(br);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // choose file button
    chooseBtn.addEventListener('click', () => fileInput.click());

    // camera button -- use file input with capture attribute for mobile
    cameraBtn.addEventListener('click', async () => {
      // On mobile, input with capture will open camera. Create a new file input with capture.
      const c = document.createElement('input');
      c.type = 'file';
      c.accept = 'image/*';
      c.capture = 'environment';
      c.onchange = (e) => { fileInput.files = e.target.files; handleFileChosen(); };
      c.click();
    });

    fileInput.addEventListener('change', handleFileChosen);

    function handleFileChosen(){
      if(fileInput.files && fileInput.files[0]){
        selectedFile = fileInput.files[0];
        uploadInfo.innerText = 'Selected: ' + selectedFile.name;
        uploadedImageUrl = null; // reset
      } else {
        selectedFile = null;
        uploadInfo.innerText = '';
      }
    }

    uploadBtn.addEventListener('click', async () => {
      if(!selectedFile){
        alert('Please choose an image first (Upload or Camera).');
        return;
      }
      if(isUploading) return;
      isUploading = true;
      uploadBtn.disabled = true;
      uploadInfo.innerText = 'Uploading...';
      try {
        const form = new FormData();
        form.append('file', selectedFile);
        form.append('upload_preset', UPLOAD_PRESET);

        const url = https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload;
        const res = await fetch(url, { method: 'POST', body: form });
        const json = await res.json();
        if(!res.ok){
          const msg = json && json.error ? json.error.message || JSON.stringify(json) : 'Upload failed';
          alert('Upload failed: ' + msg);
          uploadInfo.innerText = 'Upload failed';
          isUploading = false;
          uploadBtn.disabled = false;
          return;
        }
        uploadedImageUrl = json.secure_url || json.url;
        uploadInfo.innerText = 'Upload OK';
        appendImage(uploadedImageUrl, 'right'); // show in chat as user image
      } catch (err){
        console.error(err);
        alert('Upload error: ' + err.message);
        uploadInfo.innerText = 'Upload error';
      } finally {
        isUploading = false;
        uploadBtn.disabled = false;
      }
    });

    // Send button: sends text and optional uploadedImageUrl to your backend
    sendBtn.addEventListener('click', async () => {
      const text = textInput.value && textInput.value.trim();
      if(!text && !uploadedImageUrl){
        alert('Please enter text or upload an image first.');
        return;
      }

      // show user text in chat
      if(text){
        appendMessage(text, 'right');
      }

      // if there is an uploaded image already it was shown above via appendImage()
      textInput.value = '';
      uploadInfo.innerText = 'Sending to bot...';

      try {
        const payload = { text: text || '', image: uploadedImageUrl || null };
        const r = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if(!r.ok){
          const body = await r.text();
          console.error('API error', r.status, body);
          appendMessage('Sorry ‚Äî failed to reach bot. Try again.', 'left');
          uploadInfo.innerText = 'Send failed';
          return;
        }

        const data = await r.json();
        // Expecting response with { reply: '...'} or similar. We'll fallback to raw text.
        const replyText = data && (data.reply || data.text || JSON.stringify(data)) || 'No reply';
        appendMessage(replyText, 'left');
        uploadInfo.innerText = '';
        // reset uploaded image only after we have used it (so user doesn't accidentally resend)
        uploadedImageUrl = null;
        selectedFile = null;
        fileInput.value = '';
      } catch (err) {
        console.error(err);
        appendMessage('Sorry ‚Äî failed to reach bot. Try again.', 'left');
        uploadInfo.innerText = 'Send error';
      }
    });

    // allow Enter to send
    textInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter') { e.preventDefault(); sendBtn.click(); }
    });

  </script>
</body
