<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>TatvaBot ‚Äî Chat + Image Upload + Voice</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --green:#14532d;
    --muted:#f7f7f8;
    --bubble-bg:#f1f5f9;
    --text:#111827;
    --accent:#16a34a;
    --muted-border:#e6e6e6;
    --muted-dark:#e6e6e6;
  }
  html,body{
    height:100%;
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    background:var(--muted);
  }
  body{
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
  }

  /* container */
  .chat-wrapper{
    width:100%; max-width:960px;
    background:#fff; border-radius:12px;
    box-shadow:0 12px 30px rgba(2,6,23,0.08);
    overflow:hidden;
    display:flex; flex-direction:column;
    min-height:560px;
    height:80vh; /* fixed viewport so chat-window can scroll */
  }

  /* header - fixed inside wrapper */
  .chat-header{
    background:var(--green);
    color:#fff;
    padding:14px 18px;
    font-weight:600;
    display:flex;
    justify-content:space-between;
    align-items:center;
    position:sticky;
    top:0;
    z-index:1000;
  }
  .chat-header small{
    display:block;
    font-weight:400;
    font-size:12px;
    opacity:.95;
    margin-top:4px;
  }

  /* body area holds the scrollable chat-window */
  .chat-body{
    display:flex;
    gap:0;
    padding:18px;
    flex:1 1 auto;
    min-height:0;  /* important so child can scroll */
    box-sizing:border-box;
  }

  .chat-window{
    flex:1;
    background:#fafafa;
    border-radius:8px;
    padding:14px;
    overflow:auto;
    height:100%;
    box-sizing:border-box;
  }

  .msg{
    margin-bottom:12px;
    max-width:78%;
    line-height:1.4;
    display:flex;
    flex-direction:column;
  }
  .msg span{
    display:block;
    background:var(--bubble-bg);
    color:var(--text);
    padding:12px 14px;
    border-radius:12px;
    white-space:pre-wrap;
    word-wrap:break-word;
    box-shadow:0 1px 0 rgba(0,0,0,0.02);
  }
  .msg .meta {
    font-size:11px; color:#7b7b7b; margin-top:6px;
  }
  .msg-user{
    align-items:flex-end;
    margin-left:auto;
    text-align:right;
  }
  .msg-user span{
    background:var(--green);
    color:#fff;
  }
  .msg img{
    display:block;
    margin-top:8px;
    max-width:320px;
    border-radius:8px;
    box-shadow:0 6px 18px rgba(2,6,23,0.06);
  }

  /* typing indicator */
  .typing {
    display:inline-block;
    padding:8px 12px;
    background:#ececec;
    border-radius:12px;
  }
  .typing .dot { width:6px;height:6px;background:#9a9a9a;border-radius:50%;display:inline-block;margin:0 3px;opacity:.6; animation: blink 1s infinite; }
  .typing .dot:nth-child(2){ animation-delay:.15s; } .typing .dot:nth-child(3){ animation-delay:.3s; }
  @keyframes blink { 0%{opacity:.15} 50%{opacity:1} 100%{opacity:.15} }

  /* footer (controls) pinned to bottom of wrapper */
  .chat-footer{
    border-top:1px solid var(--muted-border);
    padding:12px 18px;
    display:flex;
    gap:8px;
    align-items:center;
    background:#fff;
  }

  .chat-footer input[type="text"]{
    flex:1;
    padding:10px 14px;
    border-radius:999px;
    border:1px solid #ddd;
    outline:none;
    font-size:14px;
  }
  .chat-footer input[type="text"]:focus{ border-color:var(--green); }

  .file-btn{
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #ddd;
    background:#fff;
    cursor:pointer;
    font-size:16px;
    line-height:1;
  }

  .send{
    background:var(--accent);
    color:#fff;
    border:none;
    padding:10px 16px;
    border-radius:999px;
    cursor:pointer;
  }
  .send:disabled{ opacity:.6; cursor:default; }

  .mic-btn{
    padding:8px 10px;
    border-radius:50%;
    border:1px solid #ddd;
    background:#fff;
    cursor:pointer;
    font-size:16px;
    line-height:1;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }
  .mic-btn.recording{
    background:linear-gradient(90deg, #ff6b6b, #ff3b3b);
    color:#fff;
    box-shadow:0 6px 18px rgba(255,59,59,0.16);
    animation: micPulse 1.2s infinite;
  }
  @keyframes micPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.06); }
    100% { transform: scale(1); }
  }

  .status{
    font-size:13px;
    color:#6b7280;
    padding:6px 18px 10px;
    min-height:20px;
  }

  /* quick buttons area (optional, inline) */
  .quick-row{ display:flex; gap:10px; flex-wrap:wrap; margin:8px 0; }
  .quick-btn{ background:#fff; border:1px solid var(--muted-dark); padding:8px 12px; border-radius:999px; cursor:pointer; font-size:13px; }
  .quick-btn.primary{ background:var(--green); color:#fff; border-color:var(--green); }

  @media(max-width:640px){
    .msg img{ max-width:220px; }
  }
</style>
</head>
<body>
  <div class="chat-wrapper" role="application" aria-label="TatvaBot chat">
    <div class="chat-header" id="chat-header">
      <div>
        <div style="font-size:16px"><strong>TatvaBot ‚Äî Gardening Assistant</strong></div>
        <small>Ask about vermicompost, terrace gardening, or Tatvabhoomi products</small>
      </div>
      <div style="font-size:12px;opacity:.95">v1</div>
    </div>

    <div class="chat-body">
      <div id="chat-window" class="chat-window" aria-live="polite" role="log">
        <div class="msg msg-bot">
          <span>üëã Namaste! I‚Äôm TatvaBot. How can I help with your plants today?</span>
          <div class="meta">just now</div>
        </div>

        <!-- suggested quick buttons -->
        <div id="quick-row" class="quick-row" aria-hidden="false" style="margin-bottom:14px;">
          <button class="quick-btn" data-q="Why are leaves yellow?">Why are leaves yellow?</button>
          <button class="quick-btn" data-q="Powdery mildew">Powdery mildew</button>
          <button class="quick-btn" data-q="Leaf holes / pests">Leaf holes / pests</button>
          <button class="quick-btn" data-q="Soil smell / drainage">Soil smell / drainage</button>
          <button class="quick-btn primary" data-q="Buy vermicompost">Buy vermicompost</button>
        </div>
      </div>
    </div>

    <div id="status" class="status" aria-live="polite"></div>

    <div class="chat-footer" role="region" aria-label="Chat controls">
      <input id="user-input" type="text" placeholder="Type your question..." autocomplete="off" aria-label="Type message" />
      <!-- attach icon opens file chooser. File selection auto-uploads. -->
      <label class="file-btn" id="choose-file-btn" title="Attach image (camera or gallery)">üìé</label>
      <input id="file-input" type="file" accept="image/*" capture="environment" style="display:none" />

      <!-- voice mic -->
      <button id="mic-btn" class="mic-btn" title="Hold / click to speak">üéôÔ∏è</button>

      <button id="send-btn" class="send" aria-label="Send message">Send</button>
    </div>
  </div>

<script>
/*
  Single-file front-end w/ voice input added.
  Keep your server endpoints:
    POST /api/upload  -> returns JSON { url: "<secure_url>" } etc.
    POST /api/chat    -> accepts { message, image } -> returns { reply, image? }
  Formspree endpoint already wired (you provided).
*/

const FORMSPREE_ENDPOINT = "https://formspree.io/f/xwpdkjaa";

const chatWindow    = document.getElementById('chat-window');
const input         = document.getElementById('user-input');
const sendBtn       = document.getElementById('send-btn');
const fileInput     = document.getElementById('file-input');
const chooseFileBtn = document.getElementById('choose-file-btn');
const statusEl      = document.getElementById('status');
const quickRow      = document.getElementById('quick-row');
const micBtn        = document.getElementById('mic-btn');

let uploadedImageUrl     = null;  // URL returned by /api/upload for the current selection
let lastUploadedUrlShown = null;  // last URL we displayed as "Image attached"
const STORAGE_KEY = 'tatvabot_chat_v1';

// simple phone number detector: 9‚Äì15 digits, allowing spaces/dashes
const PHONE_REGEX = /(\+?\d[\d\-\s]{8,15}\d)/;

/* -------- persistence helpers -------- */
function saveHistory(messages){
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(messages)); } catch(e){ console.warn('save history failed', e); }
}
function loadHistory(){
  try { const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return null; return JSON.parse(raw); } catch(e){ console.warn('load history failed', e); return null; }
}

/* -------- rendering helpers -------- */
function formatTime(ts){ const d = new Date(ts || Date.now()); return d.toLocaleTimeString([], { hour: '2-digit', minute:'2-digit' }); }
function createMessageElement({ text, from='bot', imageUrl=null, ts }){
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (from==='user' ? 'msg-user' : 'msg-bot');
  const span = document.createElement('span');
  span.innerHTML = (text || '') .replace(/\n/g,'<br>');
  wrapper.appendChild(span);
  if(imageUrl){
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = 'image';
    img.loading = 'lazy';
    wrapper.appendChild(img);
  }
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = formatTime(ts);
  wrapper.appendChild(meta);
  return wrapper;
}
function addMessage(text, from='bot', imageUrl=null, ts=Date.now(), save=true){
  const el = createMessageElement({ text, from, imageUrl, ts });
  chatWindow.appendChild(el);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  if(save){
    const hist = loadHistory() || [];
    hist.push({ text, from, imageUrl, ts });
    saveHistory(hist);
  }
}

/* restore messages on load */
(function restore(){
  const hist = loadHistory();
  if(!hist || !hist.length) return;
  chatWindow.innerHTML = '';
  if(quickRow) chatWindow.appendChild(quickRow);
  hist.forEach(msg => {
    const el = createMessageElement(msg);
    chatWindow.appendChild(el);
  });
  chatWindow.scrollTop = chatWindow.scrollHeight;
})();

/* small utilities */
function showStatus(text){ statusEl.textContent = text || ''; }

/* -------- upload flow (keeps your /api/upload) -------- */
chooseFileBtn.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', async () => {
  const file = fileInput.files && fileInput.files[0];
  if(!file) return;

  showStatus('Uploading image...');
  chooseFileBtn.disabled = true;
  sendBtn.disabled = true;

  try {
    const fd = new FormData();
    fd.append('file', file);

    const res  = await fetch('/api/upload', { method: 'POST', body: fd });
    const data = await res.json().catch(()=>null);

    if(res.ok && data && (data.url || data.secure_url || data.result?.secure_url || data.result?.url)){
      uploadedImageUrl = data.url || data.secure_url || data.result?.secure_url || data.result?.url || null;

      // show thumbnail only if we haven't already shown it
      if(uploadedImageUrl && uploadedImageUrl !== lastUploadedUrlShown){
        addMessage('Image attached', 'user', uploadedImageUrl);
        lastUploadedUrlShown = uploadedImageUrl;
      }
      showStatus('Upload OK');
    } else {
      console.error('Upload failed', res, data);
      alert('Upload failed. Check server logs and console.');
      showStatus('Upload failed');
    }
  } catch(err){
    console.error('Upload error', err);
    alert('Upload error: ' + (err.message || err));
    showStatus('Upload error');
  } finally {
    fileInput.value = '';
    chooseFileBtn.disabled = false;
    sendBtn.disabled = false;
    setTimeout(()=>showStatus(''), 1600);
  }
});

/* quick buttons behavior */
if(quickRow){
  quickRow.addEventListener('click', (ev) => {
    const btn = ev.target.closest('button[data-q]');
    if(!btn) return;
    const q = btn.getAttribute('data-q');
    if(q){
      input.value = q;
      sendMessage();
    }
  });
}

/* show / remove typing indicator helpers */
function showTypingIndicator(){
  const el = document.createElement('div');
  el.className = 'msg msg-bot typing-wrap';
  const span = document.createElement('span');
  span.className = 'typing';
  span.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  el.appendChild(span);
  chatWindow.appendChild(el);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  return el;
}
function removeTypingIndicator(el){ if(el && el.parentNode) el.parentNode.removeChild(el); }

/* -------- send flow (Formspree lead capture + normal chat) -------- */
async function sendMessage(){
  const messageRaw  = input.value.trim();
  const imageToSend = uploadedImageUrl || null;

  if(!messageRaw && !imageToSend) return;

  const phoneMatch = messageRaw.match(PHONE_REGEX);

  // ---- LEAD CAPTURE FLOW (Formspree) ----
  if (phoneMatch) {
    const phoneRaw    = phoneMatch[1];
    const phoneDigits = phoneRaw.replace(/\D/g, '');

    if(imageToSend && lastUploadedUrlShown === imageToSend){
      addMessage(messageRaw || 'Image', 'user', null);
    } else {
      addMessage(messageRaw || 'Image', 'user', imageToSend);
      lastUploadedUrlShown = imageToSend;
    }

    input.value = '';
    showStatus('Saving your number...');
    sendBtn.disabled = true;

    try {
      await fetch(FORMSPREE_ENDPOINT, {
        method: 'POST',
        headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: phoneDigits, message: messageRaw, source: 'TatvaBot chat' })
      });

      addMessage("Thank you! üå± Your number has been shared with the Tatvabhoomi team. We‚Äôll reach out to you soon. Meanwhile, you can keep asking your plant questions here.", 'bot');
    } catch(err){
      console.error('Formspree error', err);
      addMessage("I tried to save your number but something went wrong. Please try again in a while or contact us through the website.", 'bot');
    } finally {
      uploadedImageUrl = null;
      sendBtn.disabled = false;
      showStatus('');
    }
    return; // do not forward to /api/chat
  }

  // ---- NORMAL CHAT FLOW ----
  const message = messageRaw;

  if(imageToSend && lastUploadedUrlShown === imageToSend){
    addMessage(message || 'Image', 'user', null);
  } else {
    addMessage(message || 'Image', 'user', imageToSend);
    lastUploadedUrlShown = imageToSend;
  }

  input.value = '';
  showStatus('TatvaBot is thinking...');
  sendBtn.disabled = true;

  const typingEl = showTypingIndicator();

  try {
    const body = { message: message || '', image: imageToSend || null };
    const res  = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });

    const data = await res.json().catch(()=>null);
    // small delay so typing feels natural
    await new Promise(r => setTimeout(r, 600));

    if(res.ok && data && (data.reply || data.answer || data.text)){
      const replyText  = data.reply || data.answer || data.text || '';
      const replyImage = data.image || data.img || (data.result && data.result.secure_url) || null;
      removeTypingIndicator(typingEl);
      addMessage(replyText, 'bot', replyImage || null);
    } else {
      console.error('Chat API error', res, data);
      removeTypingIndicator(typingEl);
      addMessage('Sorry ‚Äî tatvabot had trouble replying. Try again later.', 'bot');
    }
  } catch(err){
    console.error('Network error', err);
    removeTypingIndicator(typingEl);
    addMessage('Network error. Please check your connection and try again.', 'bot');
  } finally {
    uploadedImageUrl = null;
    sendBtn.disabled = false;
    showStatus('');
  }
}

/* handlers */
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keydown', (e) => {
  if(e.key === 'Enter'){
    e.preventDefault();
    sendMessage();
  }
});

/* ---------- VOICE INPUT (Web Speech API) ---------- */

/*
 Behaviour:
  - Click mic to start recording, click again to stop.
  - Interim speech appears live in input.
  - When final result arrives it auto-sends the message to Tatvabot.
  - If the browser doesn't support SpeechRecognition, mic is disabled and status explains it.
*/

let recognition = null;
let isRecording = false;
const autoSendOnFinal = true; // change to false if you prefer manual-send after voice

function setupSpeech(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition){
    micBtn.disabled = true;
    micBtn.title = "Voice not supported in this browser";
    showStatus('Voice input not supported in this browser (try Chrome).');
    return;
  }

  recognition = new SpeechRecognition();
  recognition.lang = 'en-IN'; // adapt: Hindi/English mix common in India. Change if needed.
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;
  recognition.continuous = false;

  recognition.onstart = () => {
    isRecording = true;
    micBtn.classList.add('recording');
    micBtn.title = "Recording... click to stop";
    showStatus('Listening...');
  };

  recognition.onend = () => {
    // onend may be called after stop() or when speech ends
    isRecording = false;
    micBtn.classList.remove('recording');
    micBtn.title = "Click to speak";
    showStatus('');
  };

  recognition.onerror = (ev) => {
    console.error('Speech recognition error', ev);
    isRecording = false;
    micBtn.classList.remove('recording');
    micBtn.title = "Click to speak";
    if(ev && ev.error){
      if(ev.error === 'not-allowed' || ev.error === 'permission-denied') {
        showStatus('Microphone permission denied. Allow mic and try again.');
      } else {
        showStatus('Voice error: ' + ev.error);
      }
    }
  };

  let interimTranscript = '';
  recognition.onresult = (ev) => {
    interimTranscript = '';
    let finalTranscript = '';

    for(let i=0;i<ev.results.length;i++){
      const res = ev.results[i];
      if(res.isFinal){
        finalTranscript += res[0].transcript;
      } else {
        interimTranscript += res[0].transcript;
      }
    }

    // show interim in input (do not overwrite user's typed text unless empty)
    input.value = (finalTranscript || interimTranscript || input.value) ;
    // if final and autoSend set, send it
    if(finalTranscript && autoSendOnFinal){
      // small timeout to allow UI to update
      setTimeout(()=> {
        // move caret/focus
        input.focus();
        sendMessage();
      }, 120);
    }
  };
}

micBtn.addEventListener('click', async () => {
  if(!recognition){
    setupSpeech();
    if(!recognition){ return; }
  }

  if(isRecording){
    // stop recording
    try { recognition.stop(); } catch(e){ console.warn('stop error', e); }
    // onend will handle UI
  } else {
    // start recording
    try {
      recognition.start();
    } catch(e){
      console.error('recognition start error', e);
      showStatus('Could not start microphone. Check permissions.');
    }
  }
});

/* initialize speech if supported so first click is responsive */
if (window.SpeechRecognition || window.webkitSpeechRecognition) {
  setupSpeech();
} else {
  micBtn.disabled = true;
  micBtn.title = 'Voice not supported';
}

/* initial focus */
input.focus();
console.info('TatvaBot UI loaded ‚Äî persistence enabled (localStorage). Voice available:', !!(window.SpeechRecognition || window.webkitSpeechRecognition));
</script>
</body>
</html>
