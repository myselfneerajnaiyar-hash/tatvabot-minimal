<script>
/*
  Fixed client script:
  - CLOUD_UPLOAD_URL is a valid string (template literal)
  - Wrapped startup in DOMContentLoaded
  - Added dedupe so the same image url isn't shown twice
  - Keeps existing server route usage: POST /api/chat
*/

document.addEventListener('DOMContentLoaded', () => {
  const CLOUD_NAME = "dps3lh1ed";
  const UPLOAD_PRESET = "tatvabot_unsigned";
  const CLOUD_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;

  const chatWindow = document.getElementById('chat-window');
  const input = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');
  const fileInput = document.getElementById('file-input');
  const chooseFileBtn = document.getElementById('choose-file-btn');
  const uploadBtn = document.getElementById('upload-btn');
  const statusEl = document.getElementById('status');

  if(!chatWindow || !input || !sendBtn || !fileInput || !chooseFileBtn || !uploadBtn || !statusEl){
    console.error('Missing DOM elements. Ensure the script is placed AFTER the HTML or wrapped in DOMContentLoaded.');
    alert('Chat failed to initialize. Open console (F12) to see details.');
    return;
  }

  let uploadedImageUrl = null;    // the temporary uploaded image url (local state)
  let uploadInProgress = false;
  let lastUserImage = null;       // remember last user-attached image to avoid duplicates

  function showStatus(text){
    statusEl.textContent = text || '';
  }

  function addMessage(text, from='bot', imageUrl=null){
    const wrapper = document.createElement('div');
    wrapper.className = 'msg ' + (from==='user' ? 'msg-user' : 'msg-bot');
    const span = document.createElement('span');
    span.innerHTML = (text || '') .replace(/\n/g,'<br>');
    wrapper.appendChild(span);

    if(imageUrl){
      const img = document.createElement('img');
      img.src = imageUrl;
      img.alt = 'attached image';
      img.loading = 'lazy';
      wrapper.appendChild(img);
    }

    chatWindow.appendChild(wrapper);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  // open file chooser
  chooseFileBtn.addEventListener('click', () => fileInput.click());

  // upload to Cloudinary
  uploadBtn.addEventListener('click', async () => {
    const file = fileInput.files[0];
    if(!file){
      alert('Please choose an image first (click the ðŸ“· icon).');
      return;
    }
    if(uploadInProgress) return;

    uploadInProgress = true;
    uploadBtn.disabled = true;
    chooseFileBtn.disabled = true;
    showStatus('Uploading image...');

    try {
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', UPLOAD_PRESET);

      const res = await fetch(CLOUD_UPLOAD_URL, { method: 'POST', body: fd });
      const json = await res.json().catch(()=>null);

      if(res.ok && json && (json.secure_url || json.url)){
        uploadedImageUrl = json.secure_url || json.url;
        showStatus('Upload OK');

        // Dedupe logic: only add the user-preview if it is not identical to the very last user image shown
        // (this prevents showing the same preview twice if user clicks upload multiple times rapidly)
        if(lastUserImage !== uploadedImageUrl){
          addMessage('Image attached', 'user', uploadedImageUrl);
          lastUserImage = uploadedImageUrl;
        } else {
          console.debug('Duplicate user image suppressed (same URL).');
        }

        // allow sending; clear file input so same file can be re-chosen if needed
        fileInput.value = '';
      } else {
        console.error('Cloudinary upload failed:', res, json);
        alert('Upload failed. See console for details.');
        showStatus('Upload failed');
      }
    } catch(err){
      console.error('Upload error', err);
      alert('Upload error: ' + (err.message || err));
      showStatus('Upload error');
    } finally {
      uploadInProgress = false;
      uploadBtn.disabled = false;
      chooseFileBtn.disabled = false;
      setTimeout(()=>showStatus(''), 1800);
    }
  });

  // send message + (optional) uploadedImageUrl to /api/chat
  async function sendMessage(){
    const message = input.value.trim();
    if(!message && !uploadedImageUrl) return;

    // show user's message (local preview). If there's an attached image, it was already added during upload.
    if(message){
      addMessage(message, 'user', null);
    }

    input.value = '';
    showStatus('TatvaBot is thinking...');
    sendBtn.disabled = true;

    try {
      const body = { message: message || '', image: uploadedImageUrl || null };
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const json = await res.json().catch(()=>null);

      // handle common shapes: { reply, image } or { answer, img } etc
      if(res.ok && json && (json.reply || json.answer || json.text || json.output)){
        const replyText = json.reply || json.answer || json.text || json.output || '';
        let replyImage = json.image || json.img || (json.result && json.result.secure_url) || null;

        // If the bot returned the same image URL we already showed for the user, suppress duplicate
        if(replyImage && lastUserImage && replyImage === lastUserImage){
          // don't show bot image to avoid duplicate.
          replyImage = null;
          // reset lastUserImage (we consumed it)
          lastUserImage = null;
        }

        addMessage(replyText, 'bot', replyImage);
      } else {
        console.error('Chat API error', res, json);
        addMessage('Sorry â€” failed to reach bot. Check server logs.', 'bot', null);
        alert('Chat API returned error. Open Console (F12) and copy the first red line for debugging.');
      }
    } catch(err){
      console.error('Network error sending to /api/chat', err);
      addMessage('Network error. Please check your connection and try again.', 'bot');
    } finally {
      // clear temporary uploadedImageUrl (bot already received a copy)
      uploadedImageUrl = null;
      sendBtn.disabled = false;
      showStatus('');
    }
  }

  // handlers
  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); sendMessage(); } });

  // focus input
  input.focus();

  // Helpful global error handler to surface first console line
  window.addEventListener('error', (ev) => {
    console.error('Page runtime error:', ev.error || ev.message || ev);
    if(!window.__tatvabot_reported_error){
      window.__tatvabot_reported_error = true;
      alert('A script error occurred. Open Console (F12) and copy the first red line and send it to me.');
    }
  });

});
</script>
