<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>TatvaBot â€” Chat + Image Upload</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --green:#14532d;
    --muted:#f7f7f8;
    --bubble-bg:#f1f5f9;
    --text:#111827;
    --accent:#16a34a;
    --muted-border:#e6e6e6;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:var(--muted);}
  body{display:flex;align-items:center;justify-content:center;padding:18px;}

  /* container */
  .chat-wrapper{
    width:100%; max-width:960px;
    background:#fff; border-radius:12px;
    box-shadow:0 12px 30px rgba(2,6,23,0.08);
    overflow:hidden;
    display:flex; flex-direction:column;
    min-height:560px;
    height:80vh; /* so there is a fixed viewport for scrolling chat-window */
  }

  /* header - fixed inside wrapper */
  .chat-header{
    background:var(--green);
    color:#fff;
    padding:14px 18px;
    font-weight:600;
    display:flex;
    justify-content:space-between;
    align-items:center;
    position:sticky;
    top:0;
    z-index:1000;
  }
  .chat-header small{display:block;font-weight:400;font-size:12px;opacity:.95;margin-top:4px;}

  /* body area holds the scrollable chat-window */
  .chat-body{
    display:flex;
    gap:0;
    padding:18px;
    flex:1 1 auto;
    min-height:0; /* important so child can scroll */
    box-sizing:border-box;
  }

  .chat-window{
    flex:1;
    background:#fafafa;
    border-radius:8px;
    padding:14px;
    overflow:auto;
    height:100%;
    box-sizing:border-box;
  }

  .msg{ margin-bottom:12px; max-width:78%; line-height:1.4; display:flex; flex-direction:column; }
  .msg span{ display:block; background:var(--bubble-bg); color:var(--text); padding:12px 14px; border-radius:12px; white-space:pre-wrap; word-wrap:break-word; box-shadow:0 1px 0 rgba(0,0,0,0.02); }
  .msg-user{ align-items:flex-end; margin-left:auto; text-align:right; }
  .msg-user span{ background:var(--green); color:#fff; }
  .msg img{ display:block; margin-top:8px; max-width:320px; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,0.06); }

  /* footer (controls) pinned to bottom of wrapper */
  .chat-footer{
    border-top:1px solid var(--muted-border);
    padding:12px 18px;
    display:flex;
    gap:8px;
    align-items:center;
    background:#fff;
  }

  .chat-footer input[type="text"]{
    flex:1;
    padding:10px 14px;
    border-radius:999px;
    border:1px solid #ddd;
    outline:none;
    font-size:14px;
  }
  .chat-footer input[type="text"]:focus{ border-color:var(--green); }

  .file-btn{
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #ddd;
    background:#fff;
    cursor:pointer;
    font-size:16px;
    line-height:1;
  }

  .send{
    background:var(--accent);
    color:#fff;
    border:none;
    padding:10px 16px;
    border-radius:999px;
    cursor:pointer;
  }
  .send:disabled{ opacity:.6; cursor:default; }

  .status{
    font-size:13px; color:#6b7280; padding:6px 18px 10px; min-height:20px;
  }

  @media(max-width:640px){
    .msg img{ max-width:220px; }
  }
</style>
</head>
<body>
  <div class="chat-wrapper" role="application" aria-label="TatvaBot chat">
    <div class="chat-header" id="chat-header">
      <div>
        <div style="font-size:16px"><strong>TatvaBot â€” Gardening Assistant</strong></div>
        <small>Ask about vermicompost, terrace gardening, or Tatvabhoomi products</small>
      </div>
      <div style="font-size:12px;opacity:.95">v1</div>
    </div>

    <div class="chat-body">
      <div id="chat-window" class="chat-window" aria-live="polite" role="log">
        <div class="msg msg-bot"><span>ðŸ‘‹ Namaste! Iâ€™m TatvaBot. How can I help with your plants today?</span></div>
      </div>
    </div>

    <div id="status" class="status" aria-live="polite"></div>

    <div class="chat-footer" role="region" aria-label="Chat controls">
      <input id="user-input" type="text" placeholder="Type your question..." autocomplete="off" aria-label="Type message" />
      <!-- attach icon opens file chooser. File selection auto-uploads. -->
      <label class="file-btn" id="choose-file-btn" title="Attach image (camera or gallery)">ðŸ“Ž</label>
      <input id="file-input" type="file" accept="image/*" capture="environment" style="display:none" />
      <button id="send-btn" class="send" aria-label="Send message">Send</button>
    </div>
  </div>

<script>
/*
  Single-file front-end.
  Server endpoints expected:
    POST /api/upload  -> returns JSON, e.g. { url: "<secure_url>" } (or secure_url/result.secure_url)
    POST /api/chat    -> accepts { message, image } and returns { reply, image? }

  Formspree integration: when user sends a phone-number-like message, we POST it to Formspree
  and show a thank-you bot message when Formspree responds OK.
*/

const chatWindow = document.getElementById('chat-window');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
const chooseFileBtn = document.getElementById('choose-file-btn');
const statusEl = document.getElementById('status');

// ---- EDIT: put your formspree endpoint here ----
const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xwpdkjaa';
// ------------------------------------------------

let uploadedImageUrl = null;       // URL returned by /api/upload for the current selection
let lastUploadedUrlShown = null;   // last URL we displayed as "Image attached" - used to prevent duplicates

function showStatus(text){ statusEl.textContent = text || ''; }

function addMessage(text, from='bot', imageUrl=null){
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (from==='user' ? 'msg-user' : 'msg-bot');
  const span = document.createElement('span');
  span.innerHTML = (text || '') .replace(/\n/g,'<br>');
  wrapper.appendChild(span);
  if(imageUrl){
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = 'image';
    img.loading = 'lazy';
    wrapper.appendChild(img);
  }
  chatWindow.appendChild(wrapper);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

/* Upload flow (unchanged from your working flow) */
chooseFileBtn.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', async () => {
  const file = fileInput.files && fileInput.files[0];
  if(!file) return;

  showStatus('Uploading image...');
  chooseFileBtn.disabled = true;
  sendBtn.disabled = true;

  try {
    const fd = new FormData();
    fd.append('file', file);

    const res = await fetch('/api/upload', { method: 'POST', body: fd });
    const data = await res.json().catch(()=>null);

    if(res.ok && data && (data.url || data.secure_url || data.result?.secure_url || data.result?.url)){
      uploadedImageUrl = data.url || data.secure_url || data.result?.secure_url || data.result?.url || null;

      // show thumbnail only if we haven't already shown it
      if(uploadedImageUrl && uploadedImageUrl !== lastUploadedUrlShown){
        addMessage('Image attached', 'user', uploadedImageUrl);
        lastUploadedUrlShown = uploadedImageUrl;
      }
      showStatus('Upload OK');
    } else {
      console.error('Upload failed', res, data);
      alert('Upload failed. Check server logs and console.');
      showStatus('Upload failed');
    }
  } catch(err){
    console.error('Upload error', err);
    alert('Upload error: ' + (err.message || err));
    showStatus('Upload error');
  } finally {
    fileInput.value = '';
    chooseFileBtn.disabled = false;
    sendBtn.disabled = false;
    setTimeout(()=>showStatus(''), 1600);
  }
});

/* Basic phone detection: reasonably permissive â€” matches digits with optional +, spaces or dashes */
function isPhoneNumber(str){
  if(!str) return false;
  const s = str.trim();
  // require at least 7 digits (common minimum) and only allowed separators
  const digits = s.replace(/[^\d]/g,'');
  if(digits.length < 7) return false;
  // a simple pattern prohibiting letters
  if(/[A-Za-z]/.test(s)) return false;
  return true;
}

/* Submit a lead to Formspree. Returns true on success. */
async function submitLeadToFormspree(phone, messageText){
  if(!FORMSPREE_ENDPOINT) return false;
  try{
    // Formspree accepts JSON (with Accept: application/json) or form data
    const payload = { phone: phone || '', message: messageText || '' };
    const res = await fetch(FORMSPREE_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>null);
    // Formspree returns 200 / 201 for success and includes ok/message
    return res.ok;
  } catch(e){
    console.error('Formspree submit error', e);
    return false;
  }
}

/* Send message:
   - keeps the existing behavior with no duplicate thumbnails
   - if user message looks like phone number, we also post to Formspree and show a thank-you bot reply
*/
async function sendMessage(){
  const message = input.value.trim();
  const imageToSend = uploadedImageUrl || null;

  if(!message && !imageToSend) return;

  if(imageToSend && lastUploadedUrlShown === imageToSend){
    // image already visible, show only text
    addMessage(message || 'Image', 'user', null);
  } else {
    // image not yet shown locally, include it with user's message
    addMessage(message || 'Image', 'user', imageToSend);
    lastUploadedUrlShown = imageToSend;
  }

  input.value = '';
  showStatus('TatvaBot is thinking...');
  sendBtn.disabled = true;

  try {
    // send the chat request to your server
    const body = { message: message || '', image: imageToSend || null };
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json().catch(()=>null);

    if(res.ok && data && (data.reply || data.answer || data.text)){
      const replyText = data.reply || data.answer || data.text || '';
      const replyImage = data.image || data.img || (data.result && data.result.secure_url) || null;
      addMessage(replyText, 'bot', replyImage || null);
    } else {
      console.error('Chat API error', res, data);
      addMessage('Sorry â€” tatvabot had trouble replying. Try again later.', 'bot');
    }

    // ---- Formspree lead submission: if input looks like a phone number, call Formspree ----
    // (we run this AFTER /api/chat so we don't block the main chat flow)
    if(isPhoneNumber(message) && FORMSPREE_ENDPOINT){
      // show small status while submitting
      showStatus('Submitting your number...');
      const ok = await submitLeadToFormspree(message, 'User entered phone number via bot UI');
      if(ok){
        // show a confirmation message in chat from bot (so user sees Thank You)
        addMessage('Thanks â€” we received your number. Our team will call you soon.', 'bot');
      } else {
        // optional: show failure status but don't spam alerts
        console.warn('Formspree submission failed');
      }
      // clear status after short delay
      setTimeout(()=>showStatus(''), 1600);
    }

  } catch(err){
    console.error('Network error', err);
    addMessage('Network error. Please check your connection and try again.', 'bot');
  } finally {
    // clear ONLY the in-flight uploadedImageUrl (so next message won't resend it),
    // but KEEP lastUploadedUrlShown until the next upload â€” this prevents duplicate thumbnails.
    uploadedImageUrl = null;
    sendBtn.disabled = false;
    showStatus('');
  }
}

// handlers
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); sendMessage(); } });

// initial focus
input.focus();

</script>
</body>
</html>
