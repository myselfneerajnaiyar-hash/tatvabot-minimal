<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TatvaBot ‚Äî chat</title>
  <style>
    /* Simple styling so buttons & layout behave like your screenshots */
    body{font-family:system-ui,Segoe UI,Roboto,sans-serif; margin:0; background:#f6f7f8}
    .header{background:#1f8a2e;color:#fff;padding:18px;border-radius:8px;margin:18px}
    .container{max-width:900px;margin:10px auto;padding:12px}
    .chatWindow{height:540px;background:#fff;border-radius:8px;padding:18px;overflow:auto;border:1px solid #eee}
    .message{display:inline-block;padding:12px;border-radius:12px;margin:8px 0; background:#eef9ea;color:#111;max-width:70%}
    .message.user{background:#1f8a2e;color:#fff;margin-left:auto}
    .controls{display:flex;gap:8px;align-items:center;margin-top:14px}
    .input{flex:1;padding:12px;border-radius:24px;border:1px solid #ddd}
    button{padding:8px 14px;border-radius:8px;border:0;background:#1f8a2e;color:#fff;cursor:pointer}
    .btn-gray{background:#f3f3f3;color:#222;border:1px solid #ddd}
    .small{font-size:13px;color:#666;margin-top:6px}
    .hidden{display:none}
    .thumb{max-width:300px;border-radius:12px;display:block;margin:10px 0}
    .upload-status{display:inline-block;padding:6px 10px;border-radius:18px;background:#e8f6e9;color:#0a7a2a;font-weight:600;margin-right:8px}
    .note{font-size:12px;color:#777;margin-top:8px}
  </style>
</head>
<body>
  <div class="header">TatvaBot ‚Äî Gardening Assistant</div>
  <div class="container">
    <div class="chatWindow" id="chatWindow">
      <div class="message">üëã Namaste! I'm TatvaBot. How can I help with your plants today?</div>
    </div>

    <div class="controls" style="flex-direction:column;align-items:stretch">
      <div style="display:flex;align-items:center;gap:8px">
        <input id="textInput" class="input" placeholder="Type your question..." />
        <button id="sendBtn">Send</button>
      </div>

      <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
        <!-- Camera (direct capture on mobile) -->
        <label class="btn-gray" id="cameraLabel" style="padding:6px 10px;cursor:pointer;">
          üì∑ Camera
          <input id="cameraInput" class="hidden" type="file" accept="image/*" capture="environment">
        </label>

        <!-- File upload -->
        <label class="btn-gray" id="fileLabel" style="padding:6px 10px;cursor:pointer;">
          ‚¨ÜÔ∏è Upload
          <input id="fileInput" class="hidden" type="file" accept="image/*">
        </label>

        <!-- Manual Upload button (uploads currently selected file to Cloudinary) -->
        <button id="uploadBtn" class="btn-gray">Upload</button>

        <div id="statusWrap" style="margin-left:8px"></div>
      </div>

      <div class="note">Uploads go directly to Cloudinary (unsigned preset).</div>

    </div>
  </div>

<script>
/*
  IMPORTANT: these values are from you (do NOT change)
*/
const CLOUD_NAME = "dps3lh1ed";
const UPLOAD_PRESET = "tatvabot_unsigned";

/* Elements */
const chatWindow = document.getElementById('chatWindow');
const textInput = document.getElementById('textInput');
const sendBtn = document.getElementById('sendBtn');
const cameraInput = document.getElementById('cameraInput');
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const statusWrap = document.getElementById('statusWrap');

let selectedFile = null;   // the File object selected
let latestUploadedUrl = null; // secure_url returned by Cloudinary

/* Helpers */
function addMessage(text, opts = {}) {
  const div = document.createElement('div');
  div.className = 'message' + (opts.user ? ' user' : '');
  if (opts.html) div.innerHTML = opts.html;
  else div.textContent = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  return div;
}

/* Pick files */
cameraInput.addEventListener('change', (e)=>{
  if (e.target.files && e.target.files[0]) {
    selectedFile = e.target.files[0];
    showSelectedPreview(selectedFile);
  }
});
fileInput.addEventListener('change', (e)=>{
  if (e.target.files && e.target.files[0]) {
    selectedFile = e.target.files[0];
    showSelectedPreview(selectedFile);
  }
});

function showSelectedPreview(file) {
  // remove earlier preview if present
  const existing = document.querySelector('.thumb');
  if (existing) existing.remove();
  const reader = new FileReader();
  reader.onload = function(ev){
    const img = document.createElement('img');
    img.src = ev.target.result;
    img.className = 'thumb';
    chatWindow.appendChild(img);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  };
  reader.readAsDataURL(file);
}

/* Upload to Cloudinary unsigned (direct from browser) */
async function uploadToCloudinary(file) {
  if (!file) throw new Error('No file selected');
  statusWrap.innerHTML = '<span class="upload-status">Uploading‚Ä¶</span>';
  const url = https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload;
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);

  const res = await fetch(url, { method:'POST', body: fd });
  if (!res.ok) {
    const text = await res.text().catch(()=>res.statusText);
    statusWrap.innerHTML = '';
    throw new Error(Upload failed: ${res.status} ${text});
  }
  const body = await res.json();
  statusWrap.innerHTML = '<span style="color:#0a7a2a;font-weight:600">Upload OK</span>';
  latestUploadedUrl = body.secure_url || body.url || null;
  return body;
}

/* Upload button behaviour */
uploadBtn.addEventListener('click', async () => {
  try {
    if (!selectedFile) { alert('Pick a photo first (camera or upload).'); return; }
    await uploadToCloudinary(selectedFile);
    // show small confirmation in chat
    addMessage('Image attached', { html: '<b>Image attached</b>' });
  } catch (err) {
    alert('Upload failed: ' + (err.message || err));
  }
});

/* Send message (with optional image URL) */
sendBtn.addEventListener('click', sendMessage);
textInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') sendMessage(); });

async function sendMessage() {
  const text = (textInput.value || '').trim();
  if (!text && !latestUploadedUrl) { alert('Type a question or upload an image'); return; }

  // show user's message in chat immediately
  if (text) addMessage(text, { user:true });

  // Prepare payload
  const payload = { message: text || '', imageUrl: latestUploadedUrl || null };

  // clear input and latestUploadedUrl so user can continue
  textInput.value = '';
  latestUploadedUrl = null;
  selectedFile = null;

  // Call your server route
  try {
    addMessage('Sending to bot‚Ä¶', { html: '<i>Sending to bot‚Ä¶</i>' });
    const res = await fetch('/api/chat', {
      method:'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const text = await res.text().catch(()=>res.statusText);
      throw new Error('Server error: ' + res.status + ' ' + text);
    }

    const data = await res.json();
    // Expect data.reply (string) or data.html
    const botReply = data.reply || data.message || JSON.stringify(data);
    addMessage(botReply, { html: botReply });
  } catch (err) {
    addMessage('Sorry ‚Äî failed to reach bot. Try again.', { html: '<b>Sorry ‚Äî failed to reach bot. Try again.</b>' });
    console.error(err);
  }
}
</script>
</body>
</html>
