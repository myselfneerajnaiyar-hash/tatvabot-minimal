<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>TatvaBot â€” Chat + Image Upload</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --green:#14532d;
    --muted:#f7f7f8;
    --bubble-bg:#f1f5f9;
    --text:#111827;
    --accent:#16a34a;
    --muted-border:#e6e6e6;
  }

  html,body{
    height:100%;
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    background:var(--muted);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
  }

  .chat-wrapper{
    width:100%;
    max-width:960px;
    background:#fff;
    border-radius:12px;
    box-shadow:0 12px 30px rgba(2,6,23,0.08);
    display:grid;
    grid-template-columns:1fr 340px;
    overflow:hidden;
    min-height:540px;
    position:relative;
  }

  /* ---- FIXED HEADER ---- */
  .chat-header{
    background:var(--green);
    color:#fff;
    padding:14px;
    font-weight:600;
    position:sticky;
    top:0;
    z-index:50;
    border-radius:0;
  }
  .chat-header small{
    display:block;
    font-weight:400;
    font-size:12px;
    opacity:.9;
    margin-top:4px;
  }

  .left{
    padding:0 20px 18px 20px;
    display:flex;
    flex-direction:column;
    height:100%;
  }

  .chat-window{
    background:#fafafa;
    border-radius:8px;
    padding:14px;
    overflow:auto;
    flex:1;
    min-height:340px;
    margin-top:10px;
  }

  .msg{
    margin-bottom:12px;
    max-width:78%;
    line-height:1.4;
    display:flex;
    flex-direction:column;
  }

  .msg span{
    display:block;
    background:var(--bubble-bg);
    color:var(--text);
    padding:12px 14px;
    border-radius:12px;
    white-space:pre-wrap;
    word-wrap:break-word;
  }

  .msg-user{
    align-items:flex-end;
    margin-left:auto;
    text-align:right;
  }

  .msg-user span{
    background:var(--green);
    color:#fff;
  }

  .msg img{
    display:block;
    margin-top:8px;
    max-width:320px;
    border-radius:8px;
  }

  .chat-footer{
    display:flex;
    gap:8px;
    padding-top:12px;
    border-top:1px solid var(--muted-border);
    align-items:center;
  }

  .chat-footer input[type="text"]{
    flex:1;
    padding:10px 14px;
    border-radius:999px;
    border:1px solid #ddd;
  }

  .send{
    background:var(--accent);
    color:#fff;
    border:none;
    padding:10px 16px;
    border-radius:999px;
    cursor:pointer;
  }

  .file-btn{
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #ddd;
    background:#fff;
    cursor:pointer;
  }

  @media(max-width:920px){
    .chat-wrapper{ grid-template-columns:1fr; }
    .right{ display:none; }
  }
</style>
</head>

<body>
<div class="chat-wrapper">
  <div class="left">
    
    <!-- FIXED HEADER -->
    <div class="chat-header">
      TatvaBot â€” Gardening Assistant
      <small>Ask about vermicompost, terrace gardening, or Tatvabhoomi products</small>
    </div>

    <!-- CHAT WINDOW -->
    <div id="chat-window" class="chat-window">
      <div class="msg msg-bot"><span>ðŸ‘‹ Namaste! Iâ€™m TatvaBot. How can I help with your plants today?</span></div>
    </div>

    <div id="status" class="status"></div>

    <!-- FOOTER -->
    <div class="chat-footer">
      <label class="file-btn" id="choose-file-btn">ðŸ“Ž</label>
      <input id="file-input" type="file" accept="image/*" capture="environment" style="display:none" />

      <input id="user-input" type="text" placeholder="Type your message..." />
      <button id="send-btn" class="send">Send</button>
    </div>
  </div>

  <div class="right"></div>
</div>

<script>
const chatWindow = document.getElementById('chat-window');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
const chooseFileBtn = document.getElementById('choose-file-btn');
const statusEl = document.getElementById('status');

let uploadedImageUrl = null;

function showStatus(text){
  statusEl.textContent = text || "";
}

function addMessage(text, from="bot", imageUrl=null){
  const box = document.createElement("div");
  box.className = "msg " + (from === "user" ? "msg-user" : "msg-bot");

  const span = document.createElement("span");
  span.innerHTML = text.replace(/\n/g, "<br>");
  box.appendChild(span);

  if(imageUrl){
    const img = document.createElement("img");
    img.src = imageUrl;
    box.appendChild(img);
  }

  chatWindow.appendChild(box);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

/* 1ï¸âƒ£ AUTO-UPLOAD AFTER SELECTING IMAGE */
chooseFileBtn.addEventListener("click", () => fileInput.click());

fileInput.addEventListener("change", async () => {
  const file = fileInput.files[0];
  if(!file) return;

  showStatus("Uploading imageâ€¦");

  const fd = new FormData();
  fd.append("file", file);

  const res = await fetch("/api/upload", { method:"POST", body:fd });
  const data = await res.json();

  uploadedImageUrl = data.url || data.secure_url || data.result?.secure_url;

  addMessage("Image attached", "user", uploadedImageUrl);
  showStatus("");
});

/* 2ï¸âƒ£ SEND MESSAGE + (OPTIONAL IMAGE) */
async function sendMessage(){
  const text = input.value.trim();
  if(!text && !uploadedImageUrl) return;

  addMessage(text || "Image", "user", uploadedImageUrl);
  input.value = "";

  const body = { message:text, image:uploadedImageUrl };

  const res = await fetch("/api/chat", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();
  addMessage(data.reply, "bot", data.image);

  uploadedImageUrl = null;
}

sendBtn.addEventListener("click", sendMessage);
input.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ e.preventDefault(); sendMessage(); }
});
</script>
</body>
</html>
