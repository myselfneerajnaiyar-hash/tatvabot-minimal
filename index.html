<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>TatvaBot - Upload + Chat</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --green:#14532d;
    --muted:#f3f4f6;
    --bubble-bg:#e5e7eb;
    --text:#111827;
    --accent:#16a34a;
  }
  html,body{height:100%;margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;}
  body{background:var(--muted);display:flex;align-items:center;justify-content:center;padding:20px;}

  .chat-wrapper{
    width:100%; max-width:960px; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.08);
    display:grid; grid-template-columns:1fr 360px; overflow:hidden;
  }

  /* left = chat */
  .left { padding:18px 20px; display:flex; flex-direction:column; gap:12px; min-height:560px; }
  .chat-header{ background:var(--green); color:#fff; padding:14px; border-radius:8px; font-weight:600; display:flex; justify-content:space-between; align-items:center;}
  .chat-window{ background:#fafafa; border-radius:8px; padding:14px; flex:1; overflow:auto; min-height:360px; }
  .msg{ margin-bottom:12px; max-width:78%; line-height:1.4; }
  .msg span{ display:block; background:var(--bubble-bg); color:var(--text); padding:12px 14px; border-radius:12px; white-space:pre-wrap; word-wrap:break-word; }
  .msg-user{ justify-self:end; text-align:right; align-self:flex-end; }
  .msg-user span{ background:var(--green); color:#fff; }
  .msg img{ display:block; margin-top:8px; max-width:240px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.06); }

  /* footer with text input + upload inside */
  .chat-footer{ display:flex; gap:8px; padding-top:10px; border-top:1px solid #eee; align-items:center; }
  .chat-footer input[type="text"]{ flex:1; padding:10px 14px; border-radius:999px; border:1px solid #ddd; outline:none; }
  .chat-footer button.send{ background:var(--accent); color:#fff; border:none; padding:10px 16px; border-radius:999px; cursor:pointer; }
  .chat-footer button.send:disabled{ opacity:.6; cursor:default; }

  /* small upload button inside footer */
  .file-input-wrapper{ display:flex; gap:8px; align-items:center; margin-left:6px; white-space:nowrap; }
  .file-input-wrapper input[type=file]{ display:none; }
  .file-btn{ padding:6px 8px; border:1px solid #ccc; background:#fff; border-radius:6px; cursor:pointer; }

  /* right column (removed debug) - keep minimal UI for upload only if you want */
  .right{ padding:18px; border-left:1px solid #f1f1f1; background:#fff; }
  .hidden{ display:none !important; }

  .status{ font-size:13px; color:#6b7280; padding:6px 0 0 0; }
</style>
</head>
<body>
  <div class="chat-wrapper">
    <div class="left">
      <div class="chat-header">
        <div><strong>TatvaBot â€“ Gardening Assistant</strong><div style="font-weight:400;font-size:12px;opacity:.9">Ask about vermicompost, balcony/terrace gardening</div></div>
        <div style="font-size:12px;opacity:.85">v1</div>
      </div>

      <div id="chat-window" class="chat-window" aria-live="polite">
        <!-- initial welcome -->
        <div class="msg msg-bot"><span>ðŸ‘‹ Namaste! Iâ€™m TatvaBot. How can I help you with your plants or vermicompost today?</span></div>
      </div>

      <div id="status" class="status"></div>

      <div class="chat-footer">
        <input id="user-input" type="text" placeholder="Type your question..." autocomplete="off" />
        <div class="file-input-wrapper">
          <label class="file-btn" id="choose-file-btn">ðŸ“Ž</label>
          <input id="file-input" type="file" accept="image/*" />
          <button id="upload-btn" class="file-btn">Upload</button>
        </div>
        <button id="send-btn" class="send">Send</button>
      </div>
    </div>

    <!-- right column left for any future controls; hide debug JSON -->
    <div class="right hidden" id="debug-right">
      <!-- previously used for debug; hidden now -->
    </div>
  </div>

<script>
/*
  Workflow:
  1) User picks file -> fileInput.files[0]
  2) Click Upload -> POST /api/upload (FormData["file"])
     -> server returns { ok:true, url: "https://..." } OR { ok:false, error:... }
  3) When upload ok: show uploaded image inside chat as user message (like WhatsApp)
  4) Then Send (or auto-trigger) posts to /api/chat with body { message, image }
*/

const chatWindow = document.getElementById('chat-window');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
const uploadBtn = document.getElementById('upload-btn');
const chooseFileBtn = document.getElementById('choose-file-btn');
const statusEl = document.getElementById('status');

let uploadedImageUrl = null; // store url returned from /api/upload

function addMessage(text, from='bot', imageUrl=null){
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (from==='user' ? 'msg-user' : 'msg-bot');
  const span = document.createElement('span');
  span.innerHTML = (text || '') .replace(/\n/g,'<br>');
  wrapper.appendChild(span);
  if(imageUrl){
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = "uploaded image";
    img.onload = ()=>{ chatWindow.scrollTop = chatWindow.scrollHeight; };
    wrapper.appendChild(img);
  }
  chatWindow.appendChild(wrapper);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// small helper to show status
function showStatus(text){
  statusEl.textContent = text || '';
}

// wire choose file button
chooseFileBtn.addEventListener('click', () => fileInput.click());

// upload handler
uploadBtn.addEventListener('click', async (e) => {
  const file = fileInput.files && fileInput.files[0];
  if(!file){
    alert('Choose an image first');
    return;
  }
  try{
    showStatus('Uploading image...');
    uploadBtn.disabled = true;
    const fd = new FormData();
    fd.append('file', file);

    const res = await fetch('/api/upload', { method: 'POST', body: fd });
    const data = await res.json().catch(()=>null);

    if(res.ok && data && (data.url || data.secure_url)){
      uploadedImageUrl = data.url || data.secure_url || data.result?.url || data.result?.secure_url || null;
      showStatus('Upload OK');
      // show uploaded image as user's message in chat (WhatsApp style)
      addMessage('Image attached', 'user', uploadedImageUrl);
      // optionally clear file input (so user doesn't re-upload the same file accidentally)
      fileInput.value = '';
    } else {
      console.error('Upload failed:', res, data);
      alert('Upload failed. See console logs.');
      showStatus('Upload failed');
    }
  } catch(err){
    console.error('Upload error', err);
    alert('Upload error: ' + (err.message || err));
    showStatus('Upload error');
  } finally {
    uploadBtn.disabled = false;
    setTimeout(()=>showStatus(''), 2500);
  }
});

// send handler
sendBtn.addEventListener('click', async () => {
  const message = input.value.trim();
  if(!message && !uploadedImageUrl){
    return; // nothing to send
  }

  // show the user message, including image if attached
  addMessage(message || 'Image', 'user', uploadedImageUrl || null);
  input.value = '';
  showStatus('TatvaBot is thinking...');
  sendBtn.disabled = true;

  try {
    const body = {
      message: message || '',
      image: uploadedImageUrl || null
    };
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json().catch(()=>null);

    if(res.ok && data && data.reply){
      addMessage(data.reply, 'bot', data.image || null);
    } else {
      console.error('Chat API error', res, data);
      addMessage("Sorry, I had trouble replying. Please try again.", 'bot');
    }
  } catch(err){
    console.error('Network error', err);
    addMessage("Network error. Please check your connection and try again.", 'bot');
  } finally {
    // if you want to clear uploaded image after sending so next message is normal:
    uploadedImageUrl = null;
    sendBtn.disabled = false;
    showStatus('');
  }
});

// optional: press Enter to send (when text input has focus)
input.addEventListener('keydown', (e) => {
  if(e.key === 'Enter') {
    e.preventDefault();
    sendBtn.click();
  }
});

// initial focus
input.focus();
</script>
</body>
</html>
