<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>TatvaBot â€” Chat + Image Upload</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --green:#14532d;
    --muted:#f7f7f8;
    --bubble-bg:#f1f5f9;
    --text:#111827;
    --accent:#16a34a;
    --muted-border:#e6e6e6;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;}
  body{background:var(--muted);display:flex;align-items:center;justify-content:center;padding:18px;}

  /* make the whole wrapper fit the viewport so the header can be kept visible */
  .chat-wrapper{
    width:100%;
    max-width:960px;
    background:#fff;
    border-radius:12px;
    box-shadow:0 12px 30px rgba(2,6,23,0.08);
    display:grid;
    grid-template-columns:1fr 340px;
    overflow:hidden;
    min-height:540px;
    height: calc(100vh - 36px); /* keep wrapper inside viewport (prevents page scroll) */
  }

  /* left = chat */
  .left {
    padding:18px 20px;
    display:flex;
    flex-direction:column;
    gap:12px;
    min-height:520px;
    height:100%;
    /* ensure the left column doesn't cause the page to scroll */
    box-sizing:border-box;
  }

  /* Make the header sticky inside the left column */
  .chat-header{
    background:var(--green);
    color:#fff;
    padding:14px;
    border-radius:8px;
    font-weight:600;
    display:flex;
    justify-content:space-between;
    align-items:center;
    /* sticky keeps header visible while .chat-window scrolls */
    position: sticky;
    top: 0;
    z-index: 5;
  }
  .chat-header small{display:block;font-weight:400;font-size:12px;opacity:.9;margin-top:4px}

  /* chat-window is the only scrollable region */
  .chat-window{
    background:#fafafa;
    border-radius:8px;
    padding:14px;
    flex:1;
    overflow:auto;         /* this is the scroll area */
    min-height:340px;
  }

  .msg{ margin-bottom:12px; max-width:78%; line-height:1.4; display:flex; flex-direction:column; }
  .msg span{ display:block; background:var(--bubble-bg); color:var(--text); padding:12px 14px; border-radius:12px; white-space:pre-wrap; word-wrap:break-word; box-shadow:0 1px 0 rgba(0,0,0,0.02); }
  .msg-user{ align-items:flex-end; margin-left:auto; text-align:right; }
  .msg-user span{ background:var(--green); color:#fff; }
  .msg img{ display:block; margin-top:8px; max-width:320px; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,0.06); }

  .chat-footer{ display:flex; gap:8px; padding-top:10px; border-top:1px solid var(--muted-border); align-items:center; }
  .chat-footer input[type="text"]{ flex:1; padding:10px 14px; border-radius:999px; border:1px solid #ddd; outline:none; font-size:14px; }
  .chat-footer input[type="text"]:focus{ border-color:var(--green); }
  .send{ background:var(--accent); color:#fff; border:none; padding:10px 16px; border-radius:999px; cursor:pointer; }
  .send:disabled{ opacity:.6; cursor:default; }

  /* file controls styled inline inside footer */
  .file-controls{ display:flex; gap:8px; align-items:center; }
  .file-btn{ padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; font-size:14px; }
  .file-btn:disabled{ opacity:.6 }
  .camera-note{ font-size:11px; color:#6b7280; margin-left:6px; }

  /* right column minimal */
  .right{ padding:18px; border-left:1px solid #f1f1f1; background:#fff; overflow:auto; }
  .status{ font-size:13px; color:#6b7280; padding:6px 0 0 0; }

  /* small responsiveness */
  @media(max-width:920px){
    .chat-wrapper{ grid-template-columns:1fr; }
    .right{ display:none; }
  }
</style>
</head>
<body>
  <div class="chat-wrapper" role="application" aria-label="TatvaBot chat">
    <div class="left" id="left-col">
      <div class="chat-header" aria-hidden="false">
        <div>
          TatvaBot â€” Gardening Assistant
          <small>Ask about vermicompost, terrace gardening, or Tatvabhoomi products</small>
        </div>
        <div style="font-size:12px;opacity:.9">v1</div>
      </div>

      <div id="chat-window" class="chat-window" aria-live="polite" role="log">
        <div class="msg msg-bot"><span>ðŸ‘‹ Namaste! Iâ€™m TatvaBot. How can I help with your plants today?</span></div>
      </div>

      <div id="status" class="status" aria-live="polite"></div>

      <div class="chat-footer" role="region" aria-label="Chat controls">
        <input id="user-input" type="text" placeholder="Type your question..." autocomplete="off" aria-label="Type message" />
        <div class="file-controls" aria-hidden="false">
          <!-- camera-capable file input; capture="environment" suggests camera on mobile -->
          <label class="file-btn" id="choose-file-btn" title="Attach image (camera or gallery)">ðŸ“Ž</label>
          <input id="file-input" type="file" accept="image/*" capture="environment" style="display:none" />
          <button id="upload-btn" class="file-btn" title="Upload selected image">Upload</button>
        </div>
        <button id="send-btn" class="send" aria-label="Send message">Send</button>
      </div>
    </div>

    <div class="right" id="right-col" aria-hidden="true">
      <!-- Placeholder for future controls -->
      <div style="font-weight:600;margin-bottom:8px">Debug & Controls</div>
      <div id="debug" style="font-size:13px;color:#444;line-height:1.4">Hidden</div>
    </div>
  </div>

<script>
/*
 Single-file chat page.
 Expects these server routes (already present in your project):
  - POST /api/upload   -> returns JSON { ok:true, url: "<secure_url>" }
  - POST /api/chat     -> accepts { message, image } and returns { reply: "text", image?: "<url>" }
*/

const chatWindow = document.getElementById('chat-window');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
const chooseFileBtn = document.getElementById('choose-file-btn');
const uploadBtn = document.getElementById('upload-btn');
const statusEl = document.getElementById('status');
const debugEl = document.getElementById('debug');

let uploadedImageUrl = null;
let lastUserImage = null;

function showStatus(text){ statusEl.textContent = text || ''; }
function debugLog(obj){ if(debugEl) debugEl.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj); }

// Create and append message (text + optional image)
function addMessage(text, from='bot', imageUrl=null){
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (from==='user' ? 'msg-user' : 'msg-bot');
  const span = document.createElement('span');
  span.innerHTML = (text || '') .replace(/\n/g,'<br>');
  wrapper.appendChild(span);
  if(imageUrl){
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = 'attached image';
    img.loading = 'lazy';
    img.style.maxWidth = '320px';
    img.style.marginTop = '8px';
    wrapper.appendChild(img);
  }
  chatWindow.appendChild(wrapper);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// file chooser trigger
chooseFileBtn.addEventListener('click', () => fileInput.click());

// Upload selected image to /api/upload
uploadBtn.addEventListener('click', async () => {
  const file = fileInput.files[0];
  if(!file){
    alert('Please choose an image first (click the ðŸ“Ž).');
    return;
  }

  try{
    showStatus('Uploading image...');
    uploadBtn.disabled = true;
    chooseFileBtn.disabled = true;

    const fd = new FormData();
    fd.append('file', file);

    const res = await fetch('/api/upload', { method:'POST', body: fd });
    const data = await res.json().catch(()=>null);

    if(res.ok && data && (data.url || data.secure_url || data.result?.secure_url)){
      uploadedImageUrl = data.url || data.secure_url || data.result?.secure_url || data.result?.url || null;
      showStatus('Upload successful');
      addMessage('Image attached', 'user', uploadedImageUrl);
      fileInput.value = '';
    } else {
      console.error('Upload failed', res, data);
      alert('Upload failed. Check server logs. See console.');
      showStatus('Upload failed');
    }
  } catch(err){
    console.error('Upload error', err);
    alert('Upload error: ' + (err.message || err));
    showStatus('Upload error');
  } finally {
    uploadBtn.disabled = false;
    chooseFileBtn.disabled = false;
    setTimeout(()=>showStatus(''), 2200);
  }
});

// Send message + optional uploadedImageUrl to /api/chat
async function sendMessage(){
  const message = input.value.trim();
  if(!message && !uploadedImageUrl) return;

  // show user's message immediately
  addMessage(message || 'Image', 'user', uploadedImageUrl || null);
  input.value = '';
  showStatus('TatvaBot is thinking...');
  sendBtn.disabled = true;

  try {
    const body = { message: message || '', image: uploadedImageUrl || null };
    const res = await fetch('/api/chat', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json().catch(()=>null);

    if(res.ok && data && data.reply){
      addMessage(data.reply, 'bot', data.image || null);
    } else {
      console.error('Chat API error', res, data);
      addMessage('Sorry â€” tatvabot had trouble replying. Try again later.', 'bot');
    }
  } catch(err){
    console.error('Network error', err);
    addMessage('Network error. Please check your connection and try again.', 'bot');
  } finally {
    uploadedImageUrl = null; // clear uploaded image after sending
    sendBtn.disabled = false;
    showStatus('');
  }
}

// handlers
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); sendMessage(); } });

// focus
input.focus();
</script>
</body>
</html>
