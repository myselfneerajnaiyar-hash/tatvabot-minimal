<script>
const form = document.getElementById("chat-form");
const input = document.getElementById("user-input");
const chatWindow = document.getElementById("chat-window");
const statusEl = document.getElementById("status");

// upload elements
const fileInput = document.querySelector('input[type="file"]');
const uploadButton = document.querySelector('button#upload');
const clearButton = document.querySelector('button#clear');
let uploadedImageUrl = null;

function addMessage(text, from = "bot", image = null) {
  const div = document.createElement("div");
  div.className = "msg msg-" + from;

  const span = document.createElement("span");
  span.innerHTML = text.replace(/\n/g, "<br>");
  div.appendChild(span);

  if (image) {
    const img = document.createElement("img");
    img.src = image;
    img.style.maxWidth = "200px";
    img.style.marginTop = "8px";
    div.appendChild(img);
  }

  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function showStatus(text) {
  statusEl.textContent = text || "";
}

// upload button
if (uploadButton && fileInput) {
  uploadButton.addEventListener("click", async () => {
    const file = fileInput.files[0];
    if (!file) return alert("Choose a file first");

    showStatus("Uploading...");
    uploadButton.disabled = true;

    try {
      const fd = new FormData();
      fd.append("file", file);

      const res = await fetch("/api/upload", { method: "POST", body: fd });
      const data = await res.json();

      if (res.ok && data.url) {
        uploadedImageUrl = data.url;
        addMessage("Image uploaded", "user", uploadedImageUrl);
        showStatus("Upload OK");
      } else {
        alert("Upload failed");
      }
    } catch (err) {
      alert("Upload error: " + err.message);
    } finally {
      uploadButton.disabled = false;
      showStatus("");
    }
  });
}

// clear button
if (clearButton) {
  clearButton.addEventListener("click", () => {
    if (fileInput) fileInput.value = "";
    uploadedImageUrl = null;
    showStatus("");
  });
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const message = input.value.trim();

  // FIXED CONDITION
  if (!message && !uploadedImageUrl) return;  

  // show user message
  addMessage(message || "Image sent", "user", uploadedImageUrl);
  input.value = "";
  showStatus("TatvaBot is thinking...");

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message,
        image: uploadedImageUrl,
      }),
    });

    const data = await res.json();

    if (res.ok && data.reply) {
      addMessage(data.reply, "bot");
    } else {
      addMessage("Error in bot reply", "bot");
    }
  } catch (err) {
    addMessage("Network error", "bot");
  } finally {
    uploadedImageUrl = null;
    showStatus("");
  }
});
</script>
