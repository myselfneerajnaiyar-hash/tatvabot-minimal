<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TatvaBot â€“ Gardening Assistant</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --green:#14532d;
    --muted:#f3f4f6;
    --bubble-bg:#e5e7eb;
    --text:#111827;
    --accent:#16a34a;
  }
  html,body{height:100%;margin:0;font-family:system-ui,Arial;}
  body{background:var(--muted);display:flex;align-items:center;justify-content:center;padding:20px;}

  .chat-wrapper{
    width:100%;max-width:420px;background:#fff;border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,0.08);
    display:flex;flex-direction:column;overflow:hidden;
  }

  .chat-header{
    background:var(--green);color:#fff;padding:14px;font-weight:600;
  }

  .chat-window{
    padding:14px;background:#fafafa;flex:1;overflow-y:auto;
    max-height:480px;
  }

  .msg{margin-bottom:12px;max-width:80%;}
  .msg span{
    display:block;background:var(--bubble-bg);padding:10px 14px;border-radius:12px;
  }
  .msg-user span{background:var(--green);color:#fff;text-align:right;}
  .msg img{display:block;margin-top:6px;max-width:180px;border-radius:6px}

  .chat-footer{
    display:flex;align-items:center;gap:6px;padding:10px;border-top:1px solid #ddd;
  }

  input[type=text]{
    flex:1;padding:10px;border-radius:999px;border:1px solid #ccc;
  }

  .file-btn{
    padding:6px 8px;border:1px solid #ccc;background:#fff;border-radius:6px;cursor:pointer;
  }

  #file-input{display:none;}
  #send-btn{
    background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:999px;cursor:pointer;
  }
</style>
</head>
<body>

<div class="chat-wrapper">
  
  <div class="chat-header">TatvaBot â€“ Gardening Assistant</div>

  <div id="chat-window" class="chat-window">
    <div class="msg msg-bot"><span>ðŸ‘‹ Namaste! Iâ€™m TatvaBot. How can I help you today?</span></div>
  </div>

  <div class="chat-footer">
      <label class="file-btn" id="choose-file-btn">ðŸ“Ž</label>
      <input id="file-input" type="file" accept="image/*" />
      <button id="upload-btn" class="file-btn">Upload</button>
      <input id="user-input" type="text" placeholder="Type your question..." />
      <button id="send-btn">Send</button>
  </div>

</div>

<script>
const chatWindow=document.getElementById("chat-window");
const input=document.getElementById("user-input");
const fileInput=document.getElementById("file-input");
const chooseBtn=document.getElementById("choose-file-btn");
const uploadBtn=document.getElementById("upload-btn");
const sendBtn=document.getElementById("send-btn");

let uploadedImageUrl=null;

function addMessage(text,from="bot",imageUrl=null){
  const div=document.createElement("div");
  div.className="msg "+(from==="user"?"msg-user":"msg-bot");

  const span=document.createElement("span");
  span.innerHTML=text.replace(/\n/g,"<br>");
  div.appendChild(span);

  if(imageUrl){
    const img=document.createElement("img");
    img.src=imageUrl;
    div.appendChild(img);
  }

  chatWindow.appendChild(div);
  chatWindow.scrollTop=chatWindow.scrollHeight;
}

chooseBtn.onclick=()=>fileInput.click();

uploadBtn.onclick=async()=>{
  if(!fileInput.files.length){alert("Choose an image first");return;}

  const fd=new FormData();
  fd.append("file",fileInput.files[0]);

  const res=await fetch("/api/upload",{method:"POST",body:fd});
  const data=await res.json();

  uploadedImageUrl=data.url || data.secure_url || data.result?.secure_url;

  addMessage("Image attached","user",uploadedImageUrl);
  fileInput.value="";
};

sendBtn.onclick=async()=>{
  const text=input.value.trim();
  if(!text && !uploadedImageUrl) return;

  addMessage(text||"Image","user",uploadedImageUrl);

  const res=await fetch("/api/chat",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({message:text,image:uploadedImageUrl})
  });

  const data=await res.json();
  addMessage(data.reply||"Error replying","bot");

  uploadedImageUrl=null;
  input.value="";
};
</script>

</body>
</html>
