<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TatvaBot - Upload + Camera</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,system-ui,Arial;margin:0;background:#f7f7f7;color:#222}
    .app{max-width:920px;margin:18px auto;padding:18px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    header{background:#1f8e3e;color:#fff;padding:12px 16px;border-radius:6px;font-weight:700}
    .chat{min-height:380px;border:1px solid #eee;margin:18px 0;padding:12px;border-radius:6px;background:#fafafa;overflow:auto}
    .msg.bot{background:#eaf6ea;color:#0b6a16;display:inline-block;padding:10px;border-radius:10px;margin:8px 0;}
    .msg.user{background:#e9f0f7;display:inline-block;padding:10px;border-radius:10px;margin:8px 0;float:right}
    .image-preview{max-width:320px;border-radius:8px;display:block;margin:10px 0}
    .controls{display:flex;gap:10px;align-items:center;margin-top:12px}
    input[type="text"]{flex:1;padding:12px;border-radius:22px;border:1px solid #ddd;box-sizing:border-box}
    button{padding:8px 12px;border-radius:8px;border:0;background:#178a3d;color:#fff;cursor:pointer}
    button.secondary{background:#1f6fb0}
    small.hint{display:block;color:#888;margin-top:8px}
    .btn-plain{background:#eee;color:#333;padding:7px 10px;border-radius:8px}
    .disabled{opacity:.5;pointer-events:none}
    .row{display:flex;gap:8px;align-items:center}
    footer{margin-top:8px;color:#666;font-size:13px}
    .spinner{display:inline-block;margin-left:6px}
  </style>
</head>
<body>
  <div class="app">
    <header>TatvaBot ‚Äî Gardening Assistant</header>

    <div class="chat" id="chat">
      <div class="msg bot">üëã Namaste! I'm TatvaBot. How can I help with your plants today?</div>
    </div>

    <div class="controls" style="flex-direction:column">
      <div style="width:100%;display:flex;align-items:center;gap:8px">
        <input id="textInput" type="text" placeholder="Type your question..." />
        <button id="sendBtn">Send</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="cameraBtn" class="btn-plain">üì∑ Camera</button>
        <button id="chooseBtn" class="btn-plain">üìÅ Choose File</button>
        <button id="uploadBtn" class="secondary">‚¨ÜÔ∏è Upload</button>
        <span id="uploadStatus" style="margin-left:8px;color:#666"></span>
      </div>

      <small class="hint">Uploads go directly to Cloudinary (unsigned preset).</small>
    </div>

    <!-- hidden file input used by "Choose File" -->
    <input id="fileInput" type="file" accept="image/*" style="display:none">

    <!-- video element used temporarily for camera capture -->
    <div id="cameraContainer" style="display:none;margin-top:12px">
      <video id="cameraVideo" autoplay playsinline width="320" style="border-radius:6px;border:1px solid #ddd"></video>
      <div style="margin-top:8px">
        <button id="captureBtn" class="btn-plain">Capture</button>
        <button id="closeCamBtn" class="btn-plain">Close</button>
      </div>
    </div>
  </div>

<script>
/*
  HOW THIS WORKS (simple steps):
  1) Choose a file or use Camera -> captured image is kept in currentImageFile.
  2) Click Upload -> image is sent to Cloudinary unsigned preset. On success we store image URL.
  3) Click Send -> sends { message, image } to /api/chat (server). The server should return bot reply text.
*/

const cloudName = "dps3lh1ed";            // <- your cloud name
const uploadPreset = "tatvabot_unsigned"; // <- your unsigned preset

const chatEl = document.getElementById('chat');
const textInput = document.getElementById('textInput');
const sendBtn = document.getElementById('sendBtn');
const cameraBtn = document.getElementById('cameraBtn');
const chooseBtn = document.getElementById('chooseBtn');
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const uploadStatus = document.getElementById('uploadStatus');

const cameraContainer = document.getElementById('cameraContainer');
const cameraVideo = document.getElementById('cameraVideo');
const captureBtn = document.getElementById('captureBtn');
const closeCamBtn = document.getElementById('closeCamBtn');

let currentImageFile = null;   // File or Blob to upload
let currentImageUrl = null;    // Cloudinary URL after upload
let streamRef = null;

// Utility: show message in chat
function appendMessage(text, who='bot', imgUrl=null){
  const d = document.createElement('div');
  d.className = 'msg ' + (who === 'bot' ? 'bot' : 'user');
  d.innerHTML = '';
  if(imgUrl){
    const img = document.createElement('img');
    img.src = imgUrl;
    img.className = 'image-preview';
    d.appendChild(img);
  }
  const p = document.createElement('div');
  p.textContent = text;
  d.appendChild(p);
  chatEl.appendChild(d);
  chatEl.scrollTop = chatEl.scrollHeight;
}

// When user clicks Choose File
chooseBtn.addEventListener('click', () => {
  fileInput.click();
});

// File input changed -> store selected file
fileInput.addEventListener('change', e => {
  if(e.target.files && e.target.files[0]){
    currentImageFile = e.target.files[0];
    currentImageUrl = null;
    uploadStatus.textContent = File selected: ${currentImageFile.name};
  }
});

// Camera flow
cameraBtn.addEventListener('click', async () => {
  cameraContainer.style.display = 'block';
  try {
    streamRef = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    cameraVideo.srcObject = streamRef;
  } catch (err) {
    alert('Camera access denied or not available.');
    cameraContainer.style.display = 'none';
  }
});

captureBtn.addEventListener('click', () => {
  // draw current frame to canvas, convert to blob
  const w = cameraVideo.videoWidth || 640;
  const h = cameraVideo.videoHeight || 480;
  const canvas = document.createElement('canvas');
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(cameraVideo, 0, 0, w, h);
  canvas.toBlob(blob => {
    currentImageFile = new File([blob], 'capture.png', { type: 'image/png' });
    currentImageUrl = null;
    uploadStatus.textContent = 'Captured from camera (not uploaded yet)';
    // show preview in chat area so user sees captured result
    appendMessage('Image attached', 'user', URL.createObjectURL(currentImageFile));
    stopCamera();
  }, 'image/png');
});

closeCamBtn.addEventListener('click', () => {
  stopCamera();
});

function stopCamera(){
  cameraContainer.style.display = 'none';
  if(streamRef){
    streamRef.getTracks().forEach(t => t.stop());
    streamRef = null;
  }
}

// Upload to Cloudinary unsigned
uploadBtn.addEventListener('click', async () => {
  if(!currentImageFile){ alert('Choose a file or capture first'); return; }
  uploadBtn.disabled = true;
  uploadStatus.textContent = 'Uploading...';
  try {
    const fd = new FormData();
    fd.append('file', currentImageFile);
    fd.append('upload_preset', uploadPreset);
    // optional: add folder or tags via fd.append('folder', 'tatvabot_uploads')
    const res = await fetch(https://api.cloudinary.com/v1_1/${cloudName}/upload, {
      method: 'POST',
      body: fd
    });
    const data = await res.json();
    if(!res.ok){ throw new Error(data.error && data.error.message ? data.error.message : 'Upload failed'); }
    currentImageUrl = data.secure_url || data.url;
    uploadStatus.textContent = 'Upload OK';
    appendMessage('Image attached', 'user', currentImageUrl);
  } catch(e) {
    console.error(e);
    alert('Upload failed: ' + e.message);
    uploadStatus.textContent = 'Upload failed';
  } finally {
    uploadBtn.disabled = false;
  }
});

// Send to /api/chat
sendBtn.addEventListener('click', async () => {
  const msg = (textInput.value || '').trim();
  if(!msg && !currentImageUrl && !currentImageFile){ alert('Type a message or attach an image'); return; }

  // If user attached an image but hasn't uploaded it yet, upload automatically
  if(currentImageFile && !currentImageUrl){
    const doUpload = confirm('Image not uploaded yet. Upload now automatically?');
    if(doUpload){
      uploadBtn.click();
      // wait small time for upload to complete
      let tries = 0;
      while(!currentImageUrl && tries < 60){
        await new Promise(r=>setTimeout(r,300));
        tries++;
      }
      if(!currentImageUrl){ alert('Image upload did not finish. Try again.'); return; }
    } else {
      // user declined upload -> remove image and continue with only text
      currentImageFile = null;
    }
  }

  // show user's message in UI
  if(msg) appendMessage(msg, 'user');
  // clear input
  textInput.value = '';

  // prepare payload for server
  const payload = { message: msg, image: currentImageUrl || null };

  // POST to your server route /api/chat
  try {
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';
    const r = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if(!r.ok){ throw new Error(j.error || j.message || 'Server error'); }

    // server should return something like { reply: "text", image: null } or replyHtml
    const botText = j.reply || j.text || j.message || 'No reply from bot';
    appendMessage(botText, 'bot');

    // if server returns bot image url show it
    if(j.image) appendMessage('', 'bot', j.image);
  } catch(err) {
    console.error(err);
    appendMessage('Sorry ‚Äî failed to reach bot. Try again.', 'bot');
    alert('Send failed: ' + (err.message||err));
  } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
  }
});


// small helper: allow Enter key to send
textInput.addEventListener('keydown', (e) => {
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendBtn.click();
  }
});

// --- end of script ---
</script>
</body>
</html>
