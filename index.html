<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TatvaBot ‚Äî Chat with image upload</title>
  <style>
    /* Minimal clean styles */
    body { font-family: Inter, system-ui, Arial; margin: 0; background:#f6f7f8; color:#222; }
    .container { max-width:900px; margin:28px auto; padding:18px; background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    header { background:#197a3b; color:white; padding:14px 20px; border-radius:8px; margin-bottom:18px; }
    .chat { min-height:360px; border:1px solid #eee; border-radius:8px; padding:14px; overflow:auto; background: #fafafa; }
    .bubble { display:inline-block; padding:12px 16px; border-radius:14px; margin:8px 0; max-width:78%; }
    .bot { background:#eaf6ea; color:#0f2; border-radius:14px 14px 14px 2px; }
    .user { background:#197a3b; color:white; float:right; border-radius:14px 14px 2px 14px; }
    .preview { margin:8px 0; display:block; }
    .controls { display:flex; gap:10px; align-items:center; margin-top:16px; }
    input.text { flex:1; padding:12px 14px; border-radius:22px; border:1px solid #ddd; }
    button { padding:8px 14px; border-radius:8px; border:none; cursor:pointer; }
    button.primary { background:#197a3b; color:#fff; }
    .smallBtn { background:#fff; border:1px solid #ddd; display:flex; gap:6px; align-items:center; padding:6px 10px; border-radius:8px; }
    .status { font-size:12px; color:#888; margin-top:6px; }
    .note { font-size:12px; color:#666; margin-top:8px; }
    .hidden { display:none; }
    .image-card { width:280px; border-radius:10px; overflow:hidden; box-shadow:0 4px 8px rgba(0,0,0,0.08); background:#fff; }
    .img-thumb { width:100%; display:block; }
  </style>
</head>
<body>
  <div class="container">
    <header><strong>TatvaBot ‚Äî Gardening Assistant</strong><div style="font-size:13px;opacity:.9">Ask about vermicompost, plants, etc.</div></header>

    <div id="chat" class="chat" role="log" aria-live="polite">
      <div class="bubble bot">üëã Namaste! I'm TatvaBot. How can I help with your plants today?</div>
    </div>

    <div class="controls">
      <input id="msgInput" class="text" placeholder="Type your question..." />
      <button id="cameraBtn" class="smallBtn" title="Use camera">üì∑ Camera</button>
      <button id="uploadBtn" class="smallBtn" title="Upload image">üìÅ Upload</button>
      <button id="sendBtn" class="primary">Send</button>
    </div>

    <div id="uploadStatus" class="status"></div>
    <div id="previewWrap" class="note"></div>

    <!-- hidden file inputs -->
    <input id="fileInput" class="hidden" type="file" accept="image/*" />
    <!-- file input for camera on devices: capture attribute -->
    <input id="cameraInput" class="hidden" type="file" accept="image/*" capture="environment" />

    <div class="note">Uploads go directly to Cloudinary (unsigned preset).</div>
  </div>

<script>
/* ====== CONFIG - update only these if needed ====== */
const CLOUD_NAME = 'dps3lh1ed';                // your cloud name (given)
const UPLOAD_PRESET = 'tatvabot_unsigned';     // your unsigned preset (given)
const BOT_API_URL = '/api/chat';               // backend endpoint that receives messages (change if different)
/* ================================================= */

const chat = document.getElementById('chat');
const msgInput = document.getElementById('msgInput');
const fileInput = document.getElementById('fileInput');
const cameraInput = document.getElementById('cameraInput');
const cameraBtn = document.getElementById('cameraBtn');
const uploadBtn = document.getElementById('uploadBtn');
const sendBtn = document.getElementById('sendBtn');
const uploadStatus = document.getElementById('uploadStatus');
const previewWrap = document.getElementById('previewWrap');

let lastImageUrl = null;  // store uploaded image URL

// helpers
function appendUserMessage(text, imageUrl = null) {
  const container = document.createElement('div');
  container.style.clear = 'both';
  const bubble = document.createElement('div');
  bubble.className = 'bubble user';
  bubble.innerText = text;
  container.appendChild(bubble);
  if (imageUrl) {
    const imgCard = document.createElement('div');
    imgCard.className = 'image-card';
    imgCard.style.marginTop = '12px';
    const img = document.createElement('img');
    img.className = 'img-thumb';
    img.src = imageUrl;
    imgCard.appendChild(img);
    container.appendChild(imgCard);
  }
  chat.appendChild(container);
  chat.scrollTop = chat.scrollHeight;
}
function appendBotMessage(html) {
  const bubble = document.createElement('div');
  bubble.className = 'bubble bot';
  bubble.innerHTML = html;
  chat.appendChild(bubble);
  chat.scrollTop = chat.scrollHeight;
}
function setStatus(text) {
  uploadStatus.innerText = text || '';
}

/* ========== Upload to Cloudinary (unsigned) ========== */
async function uploadFileToCloudinary(file) {
  setStatus('Uploading image...');
  uploadBtn.disabled = true;
  cameraBtn.disabled = true;
  sendBtn.disabled = true;

  try {
    const url = https://api.cloudinary.com/v1_1/${encodeURIComponent(CLOUD_NAME)}/image/upload;
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', UPLOAD_PRESET);

    const res = await fetch(url, { method: 'POST', body: fd });
    const data = await res.json();

    if (!res.ok) {
      console.error('Cloudinary error', data);
      // show friendly message; include JSON message if present
      const errMsg = (data && data.error && data.error.message) ? data.error.message : Upload failed: ${res.status};
      setStatus(errMsg);
      throw new Error(errMsg);
    }

    const secureUrl = data.secure_url || data.url;
    lastImageUrl = secureUrl;
    previewWrap.innerHTML = <div style="margin-top:8px">Image uploaded ‚úì <div style="margin-top:8px"><img src="${secureUrl}" style="max-width:240px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.08)"></div></div>;
    setStatus('Upload OK');
    return secureUrl;

  } finally {
    uploadBtn.disabled = false;
    cameraBtn.disabled = false;
    sendBtn.disabled = false;
  }
}

/* ====== events ====== */
uploadBtn.addEventListener('click', () => fileInput.click());
cameraBtn.addEventListener('click', () => cameraInput.click());

fileInput.addEventListener('change', async (ev) => {
  const f = ev.target.files && ev.target.files[0];
  if (!f) return;
  try {
    await uploadFileToCloudinary(f);
  } catch (err) {
    alert('Upload failed: ' + err.message);
  } finally {
    fileInput.value = '';
  }
});

cameraInput.addEventListener('change', async (ev) => {
  const f = ev.target.files && ev.target.files[0];
  if (!f) return;
  try {
    await uploadFileToCloudinary(f);
  } catch (err) {
    alert('Upload failed: ' + err.message);
  } finally {
    cameraInput.value = '';
  }
});

/* ===== Send to bot =====
We post JSON to BOT_API_URL: { message: text, image: lastImageUrl }
Your backend should accept this. If your backend expects form-data or another route,
change BOT_API_URL and payload accordingly.
*/
sendBtn.addEventListener('click', async () => {
  const text = msgInput.value.trim();
  if (!text && !lastImageUrl) {
    alert('Type a message or upload an image first.');
    return;
  }

  // show user message immediately
  appendUserMessage(text || 'Image', lastImageUrl);
  msgInput.value = '';

  // disable while waiting
  sendBtn.disabled = true;
  setStatus('Sending to bot...');

  try {
    const payload = { message: text, image: lastImageUrl };
    const res = await fetch(BOT_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      // show friendly error and return
      const txt = await res.text();
      setStatus('Bot error: ' + res.status);
      appendBotMessage('Sorry ‚Äî failed to reach bot. Try again.');
      console.error('Bot response error', res.status, txt);
      return;
    }

    // expecting JSON { reply: "...", ... } or HTML; adapt to your backend's response format
    const json = await res.json();
    const botReplyHtml = json.reply_html || (json.reply || 'No reply from bot.');
    appendBotMessage(botReplyHtml);

    // clear last image if you want single-use
    lastImageUrl = null;
    previewWrap.innerHTML = '';

  } catch (err) {
    console.error('Send error', err);
    appendBotMessage('Sorry ‚Äî failed to reach bot. Try again.');
    setStatus('Send failed: ' + err.message);
  } finally {
    sendBtn.disabled = false;
    setStatus('');
  }
});

/* allow Enter to send */
msgInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});
</script>
</body>
</html>
